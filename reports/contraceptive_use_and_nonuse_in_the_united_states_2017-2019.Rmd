---
title: "Use and Nonuse of Contraception in the United States Reported in the 2017-2019 National Survey of Family Growth"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(here)

i_am('reports/contraceptive_use_and_nonuse_in_the_united_states_2017-2019.Rmd')

source(here('R/NSFG_helpers.R'))
source(here('R/general_helpers.R'))

knitr::opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r load-data}
set_NSFG_2017_2019_data()
```

```{r process-fem-data, dependson='load-data'}
fem1719formats <- rbindlist(list(
  fem1719$Formats,
  # Include missing level 13 for WHYNOTPGF format.
  data.table(
    format_name = 'WHYNOTPGF',
    factor_value = 13,
    factor_label = 'No menstrual cycle or menstrual irregularity'
  ),
  # Create custom format encoding for ever_used_method series from METHHXF and OTHRMETHF.
  fem1719$Formats[
    (
      format_name == 'METHHXF' &
        factor_value %in% c(3:18, 20:21, 25:26, 98:99)
    ) | (
      format_name == 'OTHRMETHF' &
        factor_value == 24
    ),
    .(
      format_name = 'ever_used_method',
      factor_value,
      factor_label
    )
  ],
  data.table(
    format_name = 'ever_used_method',
    factor_value = c(31:33),
    factor_label = c(
      'Copper-bearing IUD (such as Copper-T or ParaGard)',
      'Hormonal IUD (such as Mirena, Skyla, Liletta, or Kyleena)',
      'Other or unknown IUD'
    )
  )
))
setkey(fem1719formats, format_name, factor_value)


# Start working female respondents data table.
fem1719dt <- copy(fem1719$Data[, .(
  CASEID,
  SECU,
  SEST,
  WGT2017_2019
)])


# Copy variables to working data table and set them to factors.
set_NSFG_variables_as_factors(
  variables = c(
    ATTRACT = 'ATTRACT',
    CONDVAG = 'YESNONAF',
    CONSTAT1 = 'CONSTATF',
    CURRMETH1 = 'METHHXF',
    CURRPREG = 'Y1N5C',
    EVERUSED = 'YESNONAF',
    HADSEX = 'HADSEX',
    HPPREGQ = 'HPPREGQ',
    LSEXPREG = 'Y1N2RECF',
    MISSPILL = 'MISSPILL',
    P12MOCON = 'P12MOCON',
    P1YRELP = 'P1YRELP',
    POSIBLMN = 'Y1N5RDF',
    POSIBLPG = 'Y1N5RDF',
    PSURGSTR = 'Y1N5C',
    PXNOFREQ = 'P12METHF',
    REASIMPP = 'REASP',
    REASIMPR = 'REASR',
    RSTRSTAT = 'RSTRSTAT',
    SEX3MO = 'Y1N2RECF',
    TUBS = 'Y1N5C',
    VAGSEX = 'YESNONAF',
    WHYCONDL = 'WHYCONDL',
    WHYNOUSING1 = 'WHYNOUSNG',
    WYNOLSTP = 'Y1N5RDF',
    WYNOTUSE = 'Y1N5RDF',
    YNOSEX = 'YNOSEX'
  )
)


# Create boolean variables for whether each contraceptive method was used at last intercourse within the past 3 months.
set_NSFG_mentions_to_booleans(
  out_prefix = 'used_last_3m_method',
  in_prefix = 'METH3M',
  in_series = 1:3,
  format = 'METH3MF',
  skip = 20:21
)


# If last intercourse within the past 3 months was with husband or cohabitating partner who has an active vasectomy, then set boolean variable of vasectomy use at last intercourse within the past 3 months to true.
fem1719dt[,
  used_last_3m_method3 := fifelse(
    SEX3MO == 'YES' & PSURGSTR == 'YES' & (
      P1YRELP == 'Current husband or (current husband from whom she is separated)' |
      P1YRELP == 'Current cohabiting partner'
    ),
    TRUE,
    used_last_3m_method3
  )
]


# If respondent has had intercourse in the past 3 months and has an active tubal ligation (or essure), then set boolean variable of tubal ligation use at last intercourse within the past 3 months to true.
fem1719dt[,
  used_last_3m_method4 := fifelse(
    SEX3MO == 'YES' & TUBS == 'YES',
    TRUE,
    used_last_3m_method4
  )
]


# Reset count of methods used at last intercourse within the past 3 months to include overrides of vasectomy and tubal ligation boolean variables.
set_count_variable_for_mentions(fem1719dt, 'used_last_3m_method')


# Create categorical variable for whether used contraception at last intercourse within the past 3 months.
fem1719dt[,
  used_last_3m := factor(fifelse(
    used_last_3m_method_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  ))
]


# Create categorical variable specifying reasons not at increased risk for unintended pregnancy, if applicable.
fem1719dt[,
  used_last_3m_status := factor(
    fcase(
      used_last_3m_method_count > 0,
        'Used at least one contraceptive method at last intercourse',
      SEX3MO != 'YES',
        'Did not have sexual intercourse with male in past 3 months',
      LSEXPREG == 'YES',
        'Pregnant in month of last intercourse',
      CONSTAT1 == 'Postpartum',
        'Postpartum',
      (WYNOTUSE == 'Yes' | WYNOLSTP == 'Yes'),
        'Currently trying to conceive',
      POSIBLPG == 'No',
        'Physically unable to conceive',
      POSIBLMN == 'No' & (
        P1YRELP == 'Current cohabiting partner' |
        P1YRELP == 'Current husband or (current husband from whom she is separated)'
      ),
        'Last intercourse was with partner who is physically unable to conceive',
      default = 'Otherwise did not use contraception at last intercourse'
    ),
    ordered = TRUE,
    levels = c(
      'Used at least one contraceptive method at last intercourse',
      'Did not have sexual intercourse with male in past 3 months',
      'Pregnant in month of last intercourse',
      'Postpartum',
      'Currently trying to conceive',
      'Physically unable to conceive',
      'Last intercourse was with partner who is physically unable to conceive',
      'Otherwise did not use contraception at last intercourse'
    )
  )
]


# Create categorical variable specifying whether respondent or partner wants to conceive.
fem1719dt[,
  pregnancy_intent_status := factor(
    fcase(
      WYNOTUSE == 'Not Applicable',
        'No answer provided in public use data file',
      WYNOTUSE == 'Yes',
        'Wants to get pregnant',
      HPPREGQ == 'Yes',
        'Partner wants respondent to get pregnant',
      WYNOTUSE == "Don't know" | HPPREGQ == "Don't know",
        "Don't know",
      WYNOTUSE == 'Refused' | HPPREGQ == 'Refused',
        'Refused',
      HPPREGQ == '(If volunteered:) no current partner',
        '(If volunteered:) no current partner',
      HPPREGQ == 'Not Applicable',
        'No answer provided in public use data file',
      default = 'Not intending to conceive'
    ),
    ordered = TRUE,
    levels = c(
      'No answer provided in public use data file',
      'Wants to get pregnant',
      'Partner wants respondent to get pregnant',
      "Don't know",
      'Refused',
      '(If volunteered:) no current partner',
      'Not intending to conceive'
    )
  )
]


# Create boolean variables for whether each reason for not using contraception was mentioned.
set_NSFG_mentions_to_booleans(
  out_prefix = 'nonuse_reason',
  in_prefix = 'WHYNOUSING',
  in_series = 1:5,
  format = 'WHYNOUSNG'
)


# Create boolean variables for whether each reason for not being able to get pregnant was mentioned.
set_NSFG_mentions_to_booleans(
  out_prefix = 'pregnancy_impossible_reason',
  in_prefix = 'WHYNOTPG',
  in_series = 1:2,
  format = 'WHYNOTPGF'
)


# Create boolean variables for whether each method was used at all in the past 3 months.
fem1719METHXidxs <- get_NSFG_format_indices('METHHXF', skip = c(1:2, 22:23, 55, 98:99))
names(fem1719METHXidxs) <- paste0('any_use_12m_method', fem1719METHXidxs)
fem1719METHX <- create_NSFG_pivot_table('METHX', 1:192)
fem1719METHX[, CMMHCALXID := ceiling(METHXID / 4)]
fem1719METHX <- fem1719METHX[
  create_NSFG_pivot_table(
    'CMMHCALX',
    1:48,
    c('CASEID', 'CMINTVW', 'CMLSTYR')
  ),
  on = c('CASEID', 'CMMHCALXID')
]
fem1719dt <- fem1719METHX[
  !is.na(METHX) & !is.na(CMMHCALX) &
    CMMHCALX > CMLSTYR &
    CMMHCALX <= CMINTVW,
  lapply(
    fem1719METHXidxs,
    \(x) any(.SD$METHX == x)
  ),
  by = CASEID
][fem1719dt]
fem1719dt[,
  names(fem1719METHXidxs) := lapply(.SD, na_to_false),
  .SDcols = names(fem1719METHXidxs)
]


# Create pivot table of MONSX variables for creating the sex12mo and sex_this_month variables below.
fem1719MONSX <- create_NSFG_pivot_table(
  'CMMONSX',
  2:48,
  c('CASEID', 'CMINTVW', 'CMLSTYR')
)[
  create_NSFG_pivot_table('MONSX', 2:48),
  on = c(CASEID = 'CASEID', CMMONSXID = 'MONSXID')
]


# Create sex12mo variable for females.
fem1719dt <- fem1719MONSX[
  !is.na(MONSX) & MONSX == 1 &
    CMMONSX > CMLSTYR &
    CMMONSX <= CMINTVW,
  .(sex12mo = TRUE),
  by = CASEID
][fem1719dt]
fem1719dt[, sex12mo := na_to_false(sex12mo)]


# Create sex_this_month variable.
fem1719dt <- fem1719MONSX[
  CMMONSX == CMINTVW,
  .(sex_this_month = equals(MONSX, 1)),
  by = CASEID
][fem1719dt]
fem1719dt[, sex_this_month := na_to_false(sex_this_month)]


# If last intercourse within the past 12 months was with husband or cohabitating partner who has an active vasectomy, then set boolean variable of vasectomy use in the past 12 months to true.
fem1719dt[,
  any_use_12m_method5 := fifelse(
    sex12mo & PSURGSTR == 'YES' & (
        P1YRELP == 'Current husband or (current husband from whom she is separated)' |
        P1YRELP == 'Current cohabiting partner'
      ),
    TRUE,
    any_use_12m_method5
  )
]


# If respondent has had intercourse in past 12 months and has an active tubal ligation (or essure), then set boolean variable of tubal ligation use at in the past 12 months to true.
fem1719dt[,
  any_use_12m_method6 := fifelse(
    sex12mo & TUBS == 'YES',
    TRUE,
    any_use_12m_method6
  )
]


# Reset count of methods used in the past 12 months to include overrides of vasectomy and tubal ligation boolean variables.
set_count_variable_for_mentions(fem1719dt, 'any_use_12m_method')


# Create categorical variable specifying consistency of any contraceptive method use over previous 12 months that combines P12MOCON and PXNOFREQ.
fem1719dt[,
  any_use_12m_consistency := factor(
    fcase(
      P12MOCON == 'Every time',
        'Every time',
      PXNOFREQ != 'Not Applicable',
        as.character(PXNOFREQ),
      default = 'No answer provided in public use data files'
    ),
    ordered = TRUE,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      "Don't know",
      'No answer provided in public use data files'
    )
  )
]


# Create boolean variables for whether each method was used in the month preceding the interview.
set_NSFG_mentions_to_booleans(
  out_prefix = 'last_month_method',
  in_prefix = 'LSTMONMETH',
  in_series = 1:4,
  format = 'METHHXF',
  skip = c(1:2, 22:23, 55, 98:99)
)


# Create boolean variables for whether each method was used in the month of the interview.
set_NSFG_mentions_to_booleans(
  out_prefix = 'this_month_method',
  in_prefix = 'CURRMETH',
  in_series = 1:4,
  format = 'METHHXF',
  skip = c(1:2, 22:23, 55, 98:99)
)


# Create boolean variables for each reason for using pill.
set_NSFG_mentions_to_booleans(
  out_prefix = 'why_use_pill_reason',
  in_prefix = 'YUSEPILL',
  in_series = 1:6,
  format = 'YUSEMTHF'
)


# Create categorical variable reflecting overall motivation for pill use.
fem1719dt[,
  pill_motivation := factor(
    fcase(
      why_use_pill_reason1 & !(
        why_use_pill_reason2 |
        why_use_pill_reason3 |
        why_use_pill_reason4 |
        why_use_pill_reason5 |
        why_use_pill_reason6 |
        why_use_pill_reason7 |
        why_use_pill_reason8
      ), 'Only for birth control',
      !why_use_pill_reason1 & (
        why_use_pill_reason2 |
        why_use_pill_reason3 |
        why_use_pill_reason4 |
        why_use_pill_reason5 |
        why_use_pill_reason6 |
        why_use_pill_reason7 |
        why_use_pill_reason8
      ), 'Only for reasons other than contraception',
      default = 'For both reasons'
    )
  )
]


# Create boolean variables for each reason for using an IUD.
set_NSFG_mentions_to_booleans(
  out_prefix = 'why_use_iud_reason',
  in_prefix = 'YUSEIUD',
  in_series = 1:6,
  format = 'YUSEMTHF'
)


# Create categorical variable reflecting overall motivation for IUD use.
fem1719dt[,
  iud_motivation := factor(
    fcase(
      why_use_iud_reason99,
        "Don't know",
      why_use_iud_reason1 & (
        why_use_iud_reason2 |
        why_use_iud_reason3 |
        why_use_iud_reason4 |
        why_use_iud_reason5 |
        why_use_iud_reason6 |
        why_use_iud_reason7 |
        why_use_iud_reason8
      ),
        'For both reasons',
      why_use_iud_reason1 & !(
        why_use_iud_reason2 |
        why_use_iud_reason3 |
        why_use_iud_reason4 |
        why_use_iud_reason5 |
        why_use_iud_reason6 |
        why_use_iud_reason7 |
        why_use_iud_reason8
      ),
        'Only for contraception',
      !why_use_iud_reason1 & (
        why_use_iud_reason2 |
        why_use_iud_reason3 |
        why_use_iud_reason4 |
        why_use_iud_reason5 |
        why_use_iud_reason6 |
        why_use_iud_reason7 |
        why_use_iud_reason8
      ),
        'Only for reasons other than contraception',
      default = 'No answer provided in public use data file'
    )
  )
]


# Create boolean variables for whether specific contraceptive method was ever used. Because this is encoded in various method-specific variables in addition to the OTHRMETH series, this has to be done in two parts. Additionally, IUD is being split into copper and hormone based IUDs, so this is handled as special cases.
fem1719dt[
  fem1719$Data,
  `:=`(
    ever_used_method3  = na_to_false(i.PILLR == 1),
    ever_used_method4  = na_to_false(i.CONDOMR == 1),
    ever_used_method5  = na_to_false(i.VASECTMY == 1),
    ever_used_method6  = na_to_false(i.EVERTUBS %in% c(1, 4) | i.ESSURE == 1),
    ever_used_method7  = na_to_false(i.WIDRAWAL == 1),
    ever_used_method8  = na_to_false(i.DEPOPROV == 1),
    ever_used_method10 = na_to_false(i.RHYTHM == 1),
    ever_used_method11 = na_to_false(i.TEMPSAFE == 1),
    ever_used_method20 = na_to_false(i.MORNPILL == 1),
    ever_used_method25 = na_to_false(i.PATCH == 1),
    ever_used_method26 = na_to_false(i.RING == 1),
    ever_used_method33 = na_to_false(
      has_level(i.EVIUDTYP1, c(3, 9)) |
      has_level(i.EVIUDTYP2, c(3, 9)) |
      has_level(i.EVIUDTYP3, c(3, 9))
    )
  )
]
for (x in c(1:2)) {
  fem1719dt[
    fem1719$Data,
    (sprintf('ever_used_method%d', 30 + x)) := na_to_false(
      has_level(i.EVIUDTYP1, x) |
      has_level(i.EVIUDTYP2, x) |
      has_level(i.EVIUDTYP3, x)
    )
  ]
}
set_NSFG_mentions_to_booleans(
  out_prefix = 'ever_used_method',
  in_prefix = 'OTHRMETH0',
  in_series = 1:7,
  format = 'OTHRMETHF',
  skip = c(19, 95)
)


# Create boolean variables for whether each contraceptive method was ever discontinued due to dissatisfaction. Because IUD types have been split out, these cases must be handled individually.
set_NSFG_mentions_to_booleans(
  out_prefix = 'ever_quit_method',
  in_prefix = 'METHSTOP',
  in_series = sprintf('%02d', 1:10),
  format = 'METHSTOPF'
)
for (x in c(1:2)) {
  fem1719dt[
    fem1719$Data,
    (sprintf('ever_quit_method%d', 30 + x)) := ever_quit_method19 & (
      has_level(i.TYPEIUD_1, x) |
      has_level(i.TYPEIUD_2, x) |
      has_level(i.TYPEIUD_3, x)
    )
  ]
}
fem1719dt[
  fem1719$Data,
  ever_quit_method33 := ever_quit_method19 & (
    has_level(i.TYPEIUD_1, c(3, 9)) |
    has_level(i.TYPEIUD_2, c(3, 9)) |
    has_level(i.TYPEIUD_3, c(3, 9))
  )
]


# Create boolean variables for reason(s) for dissatisfaction with condom.
set_NSFG_mentions_to_booleans(
  out_prefix = 'condom_quit_reason',
  in_prefix = 'REASCOND0',
  in_series = 1:7,
  format = 'REASMFMT'
)
set_NSFG_mentions_to_booleans(
  out_prefix = 'specific_condom_quit_reason',
  in_prefix = 'STOPCOND',
  in_series = 1:2,
  format = 'STOPCONDFMT'
)


# Create boolean variables for reason(s) for dissatisfaction with pill.
set_NSFG_mentions_to_booleans(
  out_prefix = 'pill_quit_reason',
  in_prefix = 'REASPILL0',
  in_series = 1:9,
  format = 'REASMFMT'
)
set_NSFG_mentions_to_booleans(
  out_prefix = 'specific_pill_quit_reason',
  in_prefix = 'STOPPILL',
  in_series = 1:6,
  format = 'STOPPILLFMT'
)


# Create boolean variables for reason(s) for dissatisfaction with IUDs.
set_NSFG_mentions_to_booleans(
  out_prefix = 'iud_quit_reason',
  in_prefix = 'REASIUD0',
  in_series = 1:5,
  format = 'REASMFMT'
)
set_NSFG_mentions_to_booleans(
  out_prefix = 'specific_iud_quit_reason',
  in_prefix = 'STOPIUD',
  in_series = 1:5,
  format = 'STOPIUDFMT'
)
```

```{r process-male-data, dependson='load-data'}
# Start working male respondents data table.
male1719dt <- copy(male1719$Data[, .(
  CASEID,
  CMLSTYR,
  CMLSXCWP,
  CONDFREQ,
  CWPALLBC01,
  PXCONFRQ,
  PXMETHOD01,
  SECU,
  SEST,
  WGT2017_2019
)])


# Copy variables to working data table and set them to factors.
set_NSFG_variables_as_factors(
  sex = 'male',
  variables = c(
    ATTRACT = 'ATTRACT',
    CONDVAG = 'YESNONAF',
    CWPLMET201 = 'MTHDSV3F',
    CWPLUSE2 = 'Y1N5RDF',
    CWPNOFRQ = 'OFTIMEF',
    CWPPOSS = 'Y1N5RDF',
    CWPPRGNW ='Y1N5RDF',
    CWPTRYPG = 'Y1N5RDF',
    FATHPOSS = 'Y1N5RDF',
    HADSEX = 'HADSEX',
    P12MOCON = 'OFTIMEF',
    P12MOCONO = 'Y1N5RDF',
    P1COHABIT = 'Y1N5RDF',
    P1CURRWIFE = 'Y1N5RDF',
    PSURGSTR = 'N0Y1CF',
    PXCPREG = 'Y1N5RDF',
    PXLPMETH01 = 'MTHDSV3F',
    PXLPUSE = 'Y1N5RDF',
    PXLSXPRB = 'Y1N5RDF',
    PXNOFREQ = 'OFTIMEF',
    PXTRYING = 'Y1N5RDF',
    RSURGSTR = 'N0Y1RDF',
    SEX12MO = 'SEX3MO',
    SEX3MO = 'SEX3MO',
    VAGSEX = 'YESNONAF',
    WHYCONDL = 'WHYCONDF',
    YNOSEX = 'YNOSEX'
  )
)


# Create boolean variables for whether each contraceptive method was used at last intercourse within the past 3 months.
set_NSFG_mentions_to_booleans(
  sex = 'male',
  out_prefix = 'used_last_3m_method',
  in_prefix = 'METH3M',
  in_series = 1:4,
  format = 'METH3MF',
  skip = 95:96
)


# If last intercourse within the past 3 months was with wife or cohabitating partner who has an tubal ligation (or other sterilizing procedure), then set boolean variable of tubal ligation use at last intercourse within the past 3 months to true.
male1719dt[,
  used_last_3m_method5 := fifelse(
    SEX3MO == 'YES, HAD INTERCOURSE' &
      (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') &
      PSURGSTR == 'YES',
    TRUE,
    used_last_3m_method5
  )
]


# If respondent has had intercourse in the past 3 months and has an active vasectomy, then set boolean variable of vasectomy use at last intercourse within the past 3 months to true.
male1719dt[,
  used_last_3m_method3 := fifelse(
    SEX3MO == 'YES, HAD INTERCOURSE' & RSURGSTR == 'YES',
    TRUE,
    used_last_3m_method3
  )
]


# Reset count of methods used at last intercourse within the past 3 months to include overrides of tubal ligation and vasectomy boolean variables.
set_count_variable_for_mentions(male1719dt, 'used_last_3m_method')


# Create categorical variable for whether used contraception at last intercourse within the past 3 months.
male1719dt[,
  used_last_3m := factor(fifelse(
    used_last_3m_method_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  ))
]


# Create categorical variable specifying reasons not at increased risk for unintended pregnancy, if applicable.
male1719dt[,
  used_last_3m_status := factor(
    fcase(
      used_last_3m_method_count > 0,
        'Used at least one contraceptive method at last intercourse',
      SEX3MO != 'YES, HAD INTERCOURSE',
        'Did not have sexual intercourse with female in past 3 months',
      PXCPREG == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPRGNW == 'Yes'),
        'Last intercourse was with partner who is pregnant',
      PXTRYING == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPTRYPG == 'Yes'),
        'Last intercourse was with partner who is trying to conceive',
      FATHPOSS == 'No',
        'Physically unable to conceive',
      (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPOSS == 'No',
        'Last intercourse was with partner who is physically unable to concieve',
      default = 'Otherwise did not use contraception at last intercourse'
    ),
    ordered = TRUE,
    levels = c(
      'Used at least one contraceptive method at last intercourse',
      'Did not have sexual intercourse with female in past 3 months',
      'Last intercourse was with partner who is pregnant',
      'Last intercourse was with partner who is trying to conceive',
      'Physically unable to conceive',
      'Last intercourse was with partner who is physically unable to concieve',
      'Otherwise did not use contraception at last intercourse'
    )
  )
]


# Create categorical variable specifying whether respondent ever indicated he does not know if a partner used a method of contraception during last intercourse.
male1719dt[,
  not_aware := factor(fifelse(
    CWPLUSE2 == "Don't know" |
      CWPLMET201 == "Don't know" |
      PXLPUSE == "Don't know" |
      PXLPMETH01 == "Don't know" |
      PXLSXPRB == 'Yes' |
      PXLSXPRB == "Don't know",
    'Reports not knowing if partner used contraceptive method at last intercourse',
    'Does not report not knowing if partner used contraceptive method at last intercourse'
  ))
]


# Create boolean variables for whether each specific method was used in past 12 months.
for (x in get_NSFG_format_indices('MTHDSV1F', skip = c(10, 98:99), sex = 'male')) {
  male1719dt[,
    (sprintf('any_use_12m_method%d', x)) := male1719$Data[,
      !is.na(
        (century_month_comparison(`>`, CMLSXCWP, CMLSTYR) & (
          CWPLMET11 == x |
          CWPLMET12 == x |
          CWPLMET13 == x |
          CWPLMET201 == x |
          CWPLMET202 == x
        )) |
        (century_month_comparison(`>`, CMFSXCWP, CMLSTYR) & (
          CWPFMET01 == x |
          CWPFMET02 == x |
          CWPFMET03 == x |
          CWPFMET04 == x |
          CWPFMET05 == x
        )) |
        CWPALLBC01 == x |
        CWPALLBC02 == x |
        CWPALLBC03 == x |
        CWPALLBC04 == x |
        CWPALLBC05 == x |
        (century_month_comparison(`>`, CMLSXP1, CMLSTYR) & (
          PXLRMETH1 == x |
          PXLRMETH2 == x |
          PXLRMETH3 == x |
          PXLPMETH01 == x |
          PXLPMETH02 == x |
          PXLPMETH03 == x
        )) |
        (century_month_comparison(`>`, CMLSXP2, CMLSTYR) & (
          PXLRMETH5 == x |
          PXLRMETH6 == x |
          PXLRMETH7 == x |
          PXLPMETH11 == x |
          PXLPMETH12 == x |
          PXLPMETH13 == x
        )) |
        (century_month_comparison(`>`, CMLSXP3, CMLSTYR) & (
          PXLRMETH9 == x |
          PXLRMETH10 == x |
          PXLRMETH11 == x |
          PXLPMETH21 == x |
          PXLPMETH22 == x |
          PXLPMETH23 == x
        )) |
        (century_month_comparison(`>`, CMFSXP, CMLSTYR) & (
          PXFMETH01 == x |
          PXFMETH02 == x |
          PXFMETH03 == x |
          PXFMETH04 == x
        )) |
        (century_month_comparison(`>`, CMFSXP2, CMLSTYR) & (
          PXFMETH14 == x |
          PXFMETH15 == x |
          PXFMETH16 == x |
          PXFMETH17 == x
        )) |
        (century_month_comparison(`>`, CMFSXP3, CMLSTYR) & (
          PXFMETH27 == x |
          PXFMETH28 == x |
          PXFMETH29 == x |
          PXFMETH30 == x
        )) |
        PXMETHOD01 == x |
        PXMETHOD02 == x |
        PXMETHOD03 == x |
        PXMETHOD04 == x |
        PXMETHOD05 == x |
        PXMETHOD14 == x |
        PXMETHOD15 == x |
        PXMETHOD16 == x |
        PXMETHOD17 == x |
        PXMETHOD18 == x |
        PXMETHOD27 == x |
        PXMETHOD28 == x |
        PXMETHOD29 == x |
        PXMETHOD30 == x |
        PXMETHOD31 == x
      )
    ]
  ]
}

# Set a boolean variable for whether "Something else" was used in past 12 months separately because its encoding collides with "Contraceptive patch (Ortho-Evra)".
male1719dt[,
  any_use_12m_method13 := male1719$Data[,
    !is.na(
      (century_month_comparison(`>`, CMLSXCWP, CMLSTYR) & (
        CWPLMET11 == 10 |
        CWPLMET12 == 10 |
        CWPLMET13 == 10 |
        CWPLMET201 == 13 |
        CWPLMET202 == 13
      )) |
      (century_month_comparison(`>`, CMFSXCWP, CMLSTYR) & (
        CWPFMET01 == 13 |
        CWPFMET02 == 13 |
        CWPFMET03 == 13 |
        CWPFMET04 == 13 |
        CWPFMET05 == 13
      )) |
      CWPALLBC01 == 13 |
      CWPALLBC02 == 13 |
      CWPALLBC03 == 13 |
      CWPALLBC04 == 13 |
      CWPALLBC05 == 13 |
      (century_month_comparison(`>`, CMLSXP1, CMLSTYR) & (
        PXLRMETH1 == 10 |
        PXLRMETH2 == 10 |
        PXLRMETH3 == 10 |
        PXLPMETH01 == 13 |
        PXLPMETH02 == 13 |
        PXLPMETH03 == 13
      )) |
      (century_month_comparison(`>`, CMLSXP2, CMLSTYR) & (
        PXLRMETH5 == 10 |
        PXLRMETH6 == 10 |
        PXLRMETH7 == 10 |
        PXLPMETH11 == 13 |
        PXLPMETH12 == 13 |
        PXLPMETH13 == 13
      )) |
      (century_month_comparison(`>`, CMLSXP3, CMLSTYR) & (
        PXLRMETH9 == 10 |
        PXLRMETH10 == 10 |
        PXLRMETH11 == 10 |
        PXLPMETH21 == 13 |
        PXLPMETH22 == 13 |
        PXLPMETH23 == 13
      )) |
      (century_month_comparison(`>`, CMFSXP, CMLSTYR) & (
        PXFMETH01 == 13 |
        PXFMETH02 == 13 |
        PXFMETH03 == 13 |
        PXFMETH04 == 13
      )) |
      (century_month_comparison(`>`, CMFSXP2, CMLSTYR) & (
        PXFMETH14 == 13 |
        PXFMETH15 == 13 |
        PXFMETH16 == 13 |
        PXFMETH17 == 13
      )) |
      (century_month_comparison(`>`, CMFSXP3, CMLSTYR) & (
        PXFMETH27 == 13 |
        PXFMETH28 == 13 |
        PXFMETH29 == 13 |
        PXFMETH30 == 13
      )) |
      PXMETHOD01 == 13 |
      PXMETHOD02 == 13 |
      PXMETHOD03 == 13 |
      PXMETHOD04 == 13 |
      PXMETHOD05 == 13 |
      PXMETHOD14 == 13 |
      PXMETHOD15 == 13 |
      PXMETHOD16 == 13 |
      PXMETHOD17 == 13 |
      PXMETHOD18 == 13 |
      PXMETHOD27 == 13 |
      PXMETHOD28 == 13 |
      PXMETHOD29 == 13 |
      PXMETHOD30 == 13 |
      PXMETHOD31 == 13
    )
  ]
]


# Set a boolean variable for whether "Contraceptive patch (Ortho-Evra)" was used in past 12 months separately because its encoding collides with "Something else".
male1719dt[,
  any_use_12m_method10 := male1719$Data[,
    !is.na(
      (century_month_comparison(`>`, CMLSXCWP, CMLSTYR) & (
        CWPLMET201 == 10 |
        CWPLMET202 == 10
      )) |
      (century_month_comparison(`>`, CMFSXCWP, CMLSTYR) & (
        CWPFMET01 == 10 |
        CWPFMET02 == 10 |
        CWPFMET03 == 10 |
        CWPFMET04 == 10 |
        CWPFMET05 == 10
      )) |
      CWPALLBC01 == 10 |
      CWPALLBC02 == 10 |
      CWPALLBC03 == 10 |
      CWPALLBC04 == 10 |
      CWPALLBC05 == 10 |
      (century_month_comparison(`>`, CMLSXP1, CMLSTYR) & (
        PXLPMETH01 == 10 |
        PXLPMETH02 == 10 |
        PXLPMETH03 == 10
      )) |
      (century_month_comparison(`>`, CMLSXP2, CMLSTYR) & (
        PXLPMETH11 == 10 |
        PXLPMETH12 == 10 |
        PXLPMETH13 == 10
      )) |
      (century_month_comparison(`>`, CMLSXP3, CMLSTYR) & (
        PXLPMETH21 == 10 |
        PXLPMETH22 == 10 |
        PXLPMETH23 == 10
      )) |
      (century_month_comparison(`>`, CMFSXP, CMLSTYR) & (
        PXFMETH01 == 10 |
        PXFMETH02 == 10 |
        PXFMETH03 == 10 |
        PXFMETH04 == 10
      )) |
      (century_month_comparison(`>`, CMFSXP2, CMLSTYR) & (
        PXFMETH14 == 10 |
        PXFMETH15 == 10 |
        PXFMETH16 == 10 |
        PXFMETH17 == 10
      )) |
      (century_month_comparison(`>`, CMFSXP3, CMLSTYR) & (
        PXFMETH27 == 10 |
        PXFMETH28 == 10 |
        PXFMETH29 == 10 |
        PXFMETH30 == 10
      )) |
      PXMETHOD01 == 10 |
      PXMETHOD02 == 10 |
      PXMETHOD03 == 10 |
      PXMETHOD04 == 10 |
      PXMETHOD05 == 10 |
      PXMETHOD14 == 10 |
      PXMETHOD15 == 10 |
      PXMETHOD16 == 10 |
      PXMETHOD17 == 10 |
      PXMETHOD18 == 10 |
      PXMETHOD27 == 10 |
      PXMETHOD28 == 10 |
      PXMETHOD29 == 10 |
      PXMETHOD30 == 10 |
      PXMETHOD31 == 10
    )
  ]
]


# If respondent has had intercourse in the past 12 months and has an active vasectomy, then set boolean variable of vasectomy use at in the past 12 months to true.
male1719dt[,
  any_use_12m_method3 := fifelse(
    SEX12MO == 'YES, HAD INTERCOURSE' & RSURGSTR == 'YES',
    TRUE,
    any_use_12m_method3
  )
]


# If last intercourse with wife or cohabitating partner was within the past 12 months, and wife or cohabitating partner has an active tubal ligation (or other sterilizing procedure), then set boolean variable of tubal ligation use at in the past 12 months to true.
male1719dt[,
  any_use_12m_method5 := fifelse(
    SEX12MO == 'YES, HAD INTERCOURSE' &
      century_month_comparison(`>`, CMLSXCWP, CMLSTYR) &
      PSURGSTR == 'YES',
    TRUE,
    any_use_12m_method5
  )
]


# Count number of contraceptive methods used in past 12 months.
set_count_variable_for_mentions(male1719dt, 'any_use_12m_method')


# Create categorical variable specifying consistency of any contraceptive method use over previous 12 months with wife or cohabitating partner that combines CONDFREQ and CWPNOFRQ.
male1719dt[,
  any_use_12m_wcp_consistency := factor(
    fcase(
      CONDFREQ == 100,
        'Every time',
      CWPNOFRQ != 'Not Applicable',
        as.character(CWPNOFRQ),
      default = 'No answer provided in public use data files'
    ),
    ordered = TRUE,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      "Don't know",
      'No answer provided in public use data files'
    )
  )
]


# Create categorical variable specifying consistency of any contraceptive method use over previous 12 months with last partner, who is not wife or cohabitating partner, that combines PXCONFRQ and PXNOFREQ.
male1719dt[,
  any_use_12m_p1_consistency := factor(
    fcase(
      PXCONFRQ == 100,
        'Every time',
      PXNOFREQ != 'Not Applicable',
        as.character(PXNOFREQ),
      default = 'No answer provided in public use data files'
    ),
    ordered = TRUE,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      "Don't know",
      'No answer provided in public use data files'
    )
  )
]

# Create categorical variable specifying consistency of condom use over previous 12 months that combines P12MOCONO and P12MOCON.
male1719dt[,
  condom_12m_consistency := factor(
    fcase(
      P12MOCONO == 'Yes',
        'Every time',
      P12MOCONO == 'No',
        'None of the time',
      !is.na(P12MOCON),
        as.character(P12MOCON),
      default = 'No answer provided in public use data files'
    ),
    ordered = TRUE,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      "Don't know",
      'No answer provided in public use data files'
    )
  )
]
```


# Persons in Populations

Description: Persons aged 15-49 living in households in the United States as estimated by the NSFG

```{r, dependson=c('process-fem-data', 'process-male-data')}
fem1719dt[, person := 1]
male1719dt[, person := 1]

estimate_and_combine_NSFG_totals_and_percentages(~person)
```


# Currently Using Contraception

Domain: Persons aged 15-49 living in households in the United States

Description: By whether had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

```{r, dependson=c('process-fem-data', 'process-male-data')}
estimate_and_combine_NSFG_totals_and_percentages(~used_last_3m)
```


# Reason for Nonuse

Domain: Persons not currently using contraception, as defined above

Description: Categorized into exclusive hierarchy, such that individuals categorized earlier in the hierarchy are not counted in later categories

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(used_last_3m_status),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_method_count == 0
  )
) |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(used_last_3m_status),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_method_count == 0
  )
) |> style_totals_and_percentages()
```


# Contraception Use Rate

Domain: Persons who had sexual intercourse with someone of the opposite sex in the 3 months preceding the interview, are not nor had last intercourse with someone who is pregnant, postpartum, trying to conceive, or physically infertile

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(used_last_3m_status),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_status %in% c(
      'Used at least one contraceptive method at last intercourse',
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(used_last_3m_status),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_status %in% c(
      'Used at least one contraceptive method at last intercourse',
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> style_totals_and_percentages()
```


# Reported Ignorance of Contraceptive Use

Domain: Males who had intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~not_aware,
  subset(
    get_NSFG_survey_design_for_sex('male'),
    SEX3MO == 'YES, HAD INTERCOURSE'
  )
) |> style_totals_and_percentages()
```

Domain: Males who had intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~not_aware,
  subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_status %in% c(
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> style_totals_and_percentages()
```


# Not Sexually Active

## Never Had Intercourse with Opposite Sex

Domain: Persons who have not had sexual intercourse with someone of the opposite sex in the 3 months preceding the interview

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(HADSEX),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    SEX3MO != 'YES'
  )
) |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(HADSEX),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    SEX3MO != 'YES, HAD INTERCOURSE'
  )
) |> style_totals_and_percentages()
```

### Reason for Never Having Intercourse

Domain: Persons who have never had sexual intercourse with someone of the opposite sex

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(YNOSEX),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    HADSEX == 'NO, R NEVER HAD INTERCOURSE'
  )
)[order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(YNOSEX),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    HADSEX == 'NO, R NEVER HAD INTERCOURSE'
  )
)[order(-total)] |> style_totals_and_percentages()
```


## Attraction by Sex

Domain: Females who have not had sexual intercourse with a male in the past 3 months

Domain: Females who had sexual intercourse with a male in the past 3 months

```{r, dependson='process-fem-data'}
style_and_combine_totals_and_percentages_horizontally(
  'Sexually active with opposite sex',
  estimate_totals_and_percentages(
    ~factor(ATTRACT),
    subset(
      get_NSFG_survey_design_for_sex('fem'),
      SEX3MO == 'YES'
    )
  ),
  'Not sexually active with opposite sex',
  estimate_totals_and_percentages(
    ~factor(ATTRACT),
    subset(
      get_NSFG_survey_design_for_sex('fem'),
      SEX3MO != 'YES'
    )
  )
)
```

Domain: Males who have not had sexual intercourse with a female in the past 3 months

Domain: Males who had sexual intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
style_and_combine_totals_and_percentages_horizontally(
  'Sexually active with opposite sex',
  estimate_totals_and_percentages(
    ~ATTRACT,
    subset(
      get_NSFG_survey_design_for_sex('male'),
      SEX3MO != 'YES, HAD INTERCOURSE'
    )
  ),
  'Not sexually active with opposite sex',
  estimate_totals_and_percentages(
    ~ATTRACT,
    subset(
      get_NSFG_survey_design_for_sex('male'),
      SEX3MO == 'YES, HAD INTERCOURSE'
    )
  )
)
```


# Reason for Physical Inability to Conceive

Domain: Females who report being physically unable to get pregnant

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(REASIMPR),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    POSIBLPG == 'No'
  )
)[order(-total)] |> style_totals_and_percentages()
```

Domain: Females who report their partner is unable to father a child

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(REASIMPP),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    POSIBLMN == 'No'
  )
)[order(-total)] |> style_totals_and_percentages()
```


# Reason(s) for Nonuse

## Size of Domain

Description: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview*

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~I(
    CURRPREG == 'NO' &
      sex_this_month &
      !is.element(
        RSTRSTAT,
        c('SURGICALLY STERILE', 'NONSURGICALLY STERILE')
      ) &
      CURRMETH1 == 'No method used'
  ),
  get_NSFG_survey_design_for_sex('fem')
)[description == TRUE] |> style_totals_and_percentages()
```

## Intent to Conceive

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, did not use a contraceptive in month of interview, and are not intending to conceive*

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(pregnancy_intent_status),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    CURRPREG == 'NO' &
      sex_this_month &
      !is.element(
        RSTRSTAT,
        c('SURGICALLY STERILE', 'NONSURGICALLY STERILE')
      ) &
      CURRMETH1 == 'No method used'
  )
) |> style_totals_and_percentages()
```

## Reason(s) for Nonuse When Not Intending to Conceive

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    pregnancy_intent_status == 'Not intending to conceive'
  ),
  prefix = 'nonuse_reason',
  format = 'WHYNOUSNG'
)[order(-total)] |> style_totals_and_percentages()
```

## Reason(s) Respondent Believes She Cannot Become Pregnant

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    nonuse_reason2
  ),
  prefix = 'pregnancy_impossible_reason',
  format = 'WHYNOTPGF'
)[order(-total)] |> style_totals_and_percentages()
```


# Method(s) at Last Intercourse

## Number of Methods

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

Description: By number of methods used at last intercourse

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(used_last_3m_method_count),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_method_count > 0
  )
) |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(used_last_3m_method_count),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_method_count > 0
  )
) |> style_totals_and_percentages()
```


## Method(s) Used at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_method_count > 0
  ),
  prefix = 'used_last_3m_method',
  skip = 20:21,
  format = 'METH3MF'
)[order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions(
  sex = 'male',
  survey_design = subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_method_count > 0
  ),
  prefix = 'used_last_3m_method',
  skip = 95:96,
  format = 'METH3MF'
)[order(-total)] |> style_totals_and_percentages()
```


## Method Used Exclusively at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used **one and only one** method of contraception during last intercourse

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_method_count == 1
  ),
  prefix = 'used_last_3m_method',
  skip = 20:21,
  format = 'METH3MF'
)[order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions(
  sex = 'male',
  survey_design = subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_method_count == 1
  ),
  prefix = 'used_last_3m_method',
  skip = 95:96,
  format = 'METH3MF'
)[order(-total)] |> style_totals_and_percentages()
```


## Proportion of Method Users Who Also Used Other Method(s)

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used each specific method of contraception during last intercourse

Description: Proportion who also used other method(s)

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions_in_subdomains(
  row_estimation_function = function(x) {
    estimate_row_total_and_percentage(
      ~I(used_last_3m_method_count > 1),
      subset(
        get_NSFG_survey_design_for_sex('fem'),
        fem1719dt[, get(sprintf('used_last_3m_method%d', x))]
      )
    )
  },
  format = 'METH3MF',
  skip = c(20:22)
)[order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions_in_subdomains(
  sex = 'male',
  row_estimation_function = function(x) {
    estimate_row_total_and_percentage(
      ~I(used_last_3m_method_count > 1),
      subset(
        get_NSFG_survey_design_for_sex('male'),
        male1719dt[, get(sprintf('used_last_3m_method%d', x))]
      )
    )
  },
  format = 'METH3MF',
  skip = 95:96
)[order(-total)] |> style_totals_and_percentages()
```


## Other Method(s) Used at Last Intercourse with Calendar Method

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a calendar method during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_method8
  ),
  prefix = 'used_last_3m_method',
  skip = c(8, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions(
  sex = 'male',
  survey_design = subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_method9
  ),
  prefix = 'used_last_3m_method',
  skip = c(9, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```


## Other Method(s) Used at Last Intercourse with Withdrawal

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used withdrawal during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_method5
  ),
  prefix = 'used_last_3m_method',
  skip = c(5, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions(
  sex = 'male',
  survey_design = subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_method2
  ),
  prefix = 'used_last_3m_method',
  skip = c(2, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```


## Other Method(s) Used at Last Intercourse with Condom

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used condom during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_method2
  ),
  prefix = 'used_last_3m_method',
  skip = c(2, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions(
  sex = 'male',
  survey_design = subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_method1
  ),
  prefix = 'used_last_3m_method',
  skip = c(1, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```


## Other Method(s) Used at Last Intercourse with Pill

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used pill during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_method1
  ),
  prefix = 'used_last_3m_method',
  skip = c(1, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions(
  sex = 'male',
  survey_design = subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_method4
  ),
  prefix = 'used_last_3m_method',
  skip = c(4, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```


# Method(s) in Past 12 Months

## Size of Domain

Description: Persons who have had intercourse with opposite in the past 12 months

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(sex12mo),
  get_NSFG_survey_design_for_sex('fem')
) |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(SEX12MO == 'YES, HAD INTERCOURSE'),
  get_NSFG_survey_design_for_sex('male')
) |> style_totals_and_percentages()
```


## Number of Methods

Domain: Females who have had intercourse with a male in the past 12 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(any_use_12m_method_count),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    sex12mo
  )
) |> style_totals_and_percentages()
```

Domain: Males who have had intercourse with a female in the past 12 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(any_use_12m_method_count),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    SEX12MO == 'YES, HAD INTERCOURSE'
  )
) |> style_totals_and_percentages()
```


## Method(s) Used at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 12 months prior to interview and used a method of contraception at least once

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    any_use_12m_method_count > 0
  ),
  prefix = 'any_use_12m_method',
  skip = c(1:2, 22:23, 55, 98:99),
  format = 'METHHXF'
)[order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions(
  sex = 'male',
  survey_design = subset(
    get_NSFG_survey_design_for_sex('male'),
    any_use_12m_method_count > 0
  ),
  prefix = 'any_use_12m_method',
  skip = 98:99,
  format = 'MTHDSV1F'
)[order(-total)] |> style_totals_and_percentages()
```


## Method Used Exclusively in Past 12 Months

Domain: Persons who had intercourse with opposite sex during the 12 months prior to interview and reporting using only one method of contraception during the 12 months prior to interview

**Females**

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    any_use_12m_method_count == 1
  ),
  prefix = 'any_use_12m_method',
  skip = c(1:2, 22:23, 55, 98:99),
  format = 'METHHXF'
)[total > 0][order(-total)] |> style_totals_and_percentages()
```

**Males**

```{r, dependson='process-male-data'}
estimate_NSFG_mentions(
  sex = 'male',
  survey_design = subset(
    get_NSFG_survey_design_for_sex('male'),
    any_use_12m_method_count == 1
  ),
  prefix = 'any_use_12m_method',
  skip = 98:99,
  format = 'MTHDSV1F'
)[order(-total)] |> style_totals_and_percentages()
```


# Consistency

## Use of Contraception Prior to Nonuse at Last Intercourse

Domain: Females who have had intercourse with a male in the past 3 months and did not use a method of contraception at last intercourse

Description: By whether used a method of contraception in past 12 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~I(any_use_12m_method_count > 0),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_status == 'Otherwise did not use contraception at last intercourse'
  )
) |> style_totals_and_percentages()
```

Domain: Females who have had intercourse with a male in the past 3 months and did not use a method of contraception at last intercourse

Description: By whether used a method of contraception ever

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(EVERUSED),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    used_last_3m_status == 'Otherwise did not use contraception at last intercourse'
  )
) |> style_totals_and_percentages()
```

Domain: Males who have had intercourse with a female in the past 3 months and did not use a method of contraception at last intercourse

Description: By whether used a method of contraception in past 12 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~I(any_use_12m_method_count > 0),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    used_last_3m_status == 'Otherwise did not use contraception at last intercourse'
  )
) |> style_totals_and_percentages()
```


## Any Method During Past 12 Months

Domain: Females who had intercourse with a male during the 12 months prior to interview, who used a method of contraception at least once, and who do not have active sterilizing operations such as tubal ligations

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(any_use_12m_consistency),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    sex12mo &
      any_use_12m_method_count > 0 &
      TUBS != 'YES'
  )
) |> style_totals_and_percentages()
```

Domain: Males who had used at least one method of contraception during intercourse with wife or cohabitating partner during the 12 months prior to interview, who do not have active sterilizing operations such as vasectomies, and whose partners do not have active sterilizing operations such as tubal ligations

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(any_use_12m_wcp_consistency),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    !is.na(CWPALLBC01) &
      RSURGSTR != 'YES' &
      PSURGSTR != 'YES'
  )
) |> style_totals_and_percentages()
```

Domain: Males who had used at least one method of contraception during intercourse with last partner, who is not wife or cohabitating partner, during the 12 months prior to interview, and who do not have active sterilizing operations such as vasectomies

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(any_use_12m_p1_consistency),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    !is.na(PXMETHOD01) &
      RSURGSTR != 'YES'
  )
) |> style_totals_and_percentages()
```


## Condom Use During Past 12 Months

Domain: Females who had intercourse with a male during the 12 months prior to interview, who used condom at least once in the past 12 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(
    P12MOCON,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      'Not Applicable'
    )
  ),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    sex12mo &
      any_use_12m_method4
  )
) |> style_totals_and_percentages()
```

Domain: Males who had intercourse with a female during the 12 months prior to interview, who used condom at least once in the past 12 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(condom_12m_consistency),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    SEX12MO == 'YES, HAD INTERCOURSE' &
        any_use_12m_method1
  )
) |> style_totals_and_percentages()
```

Domain: Females who had intercourse with a male during the 12 months prior to interview and whose only method of contraception used in the past 12 months is condom

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(
    P12MOCON,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      'Not Applicable'
    )
  ),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    sex12mo &
      any_use_12m_method4 &
      any_use_12m_method_count == 1
  )
) |> style_totals_and_percentages()
```

Domain: Males who had intercourse with a female during the 12 months prior to interview and whose only method of contraception used in the past 12 months is condom

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(condom_12m_consistency),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    SEX12MO == 'YES, HAD INTERCOURSE' &
      any_use_12m_method1 &
      any_use_12m_method_count == 1
  )
) |> style_totals_and_percentages()
```


## Pill Use During Past 4 Weeks

Domain: Females who used pill in the month of the interview or the previous month

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(MISSPILL),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    last_month_method3 | this_month_method3
  )
) |> style_totals_and_percentages()
```



# Use of Contraceptive Methods for Other Reasons

## Condom

### Size of Domain

Domain: Females who have had vaginal intercourse with a male

Description: By whether used condom at last intercourse with a male

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(CONDVAG),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    VAGSEX %in% c(
      'Yes',
      'Not Applicable'
    )
  )
) |> style_totals_and_percentages()
```

Domain: Males who have had vaginal intercourse with a female

Description: By whether used condom at last intercourse with a female

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(CONDVAG),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    VAGSEX %in% c(
      'Yes',
      'Not Applicable'
    )
  )
) |> style_totals_and_percentages()
```

### Reason for Use

Domain: Females who used condom at last intercourse with a male

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(WHYCONDL),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    CONDVAG == 'Yes'
  )
)[order(-total)] |> style_totals_and_percentages()
```

Domain: Males who used condom at last intercourse with a female

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(WHYCONDL),
  subset(
    get_NSFG_survey_design_for_sex('male'),
    CONDVAG == 'Yes'
  )
)[order(-total)] |> style_totals_and_percentages()
```


## Pill

### Size of Domain

Description: By whether used pill either during the month of interview or the month preceding the interview

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~I(this_month_method3 | last_month_method3),
  get_NSFG_survey_design_for_sex('fem')
) |> style_totals_and_percentages()
```

### Reason(s) for Use

Domain: Females who used pill either during the month of interview or the month preceding the interview

Description: By reason(s), with those mentioning multiple reasons counted multiple times

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    this_month_method3 | last_month_method3
  ),
  prefix = 'why_use_pill_reason',
  format = 'YUSEMTHF',
  skip = 98:99
)[order(-total)] |> style_totals_and_percentages()
```

### Contraceptive vs. Noncontraceptive Reasons

Domain: Females who used pill either during the month of interview or the month preceding the interview

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~pill_motivation,
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    this_month_method3 | last_month_method3
  )
)[order(-total)] |> style_totals_and_percentages()
```


## IUD

### Size of Domain

Description: By whether used an IUD either during the month of interview or the month preceding the interview*

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~I(this_month_method19 | last_month_method19),
  get_NSFG_survey_design_for_sex('fem')
) |> style_totals_and_percentages()
```

### Reason(s) for Use

Domain: Females who used an IUD either during the month of interview or the month preceding the interview

Description: By reason(s), with those mentioning multiple reasons counted multiple times*

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    this_month_method19 | last_month_method19
  ),
  prefix = 'why_use_iud_reason',
  format = 'YUSEMTHF',
  skip = 98:99
)[order(-total)] |> style_totals_and_percentages()
```

### Contraceptive vs. Noncontraceptive Reasons

Domain: Females who used an IUD either during the month of interview or the month preceding the interview*

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(iud_motivation),
  subset(
    get_NSFG_survey_design_for_sex('fem'),
    this_month_method19 | last_month_method19
  )
)[order(-total)] |> style_totals_and_percentages()
```



# Method(s) Ever Used

Domain: Females aged 15-49 living in households in the United States

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = get_NSFG_survey_design_for_sex('fem'),
  prefix = 'ever_used_method',
  format = 'ever_used_method'
)[order(-total)] |> style_totals_and_percentages()
```

## Among Those Who Have Ever Had Intercourse

Description: Females who have ever had intercourse with a male

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(HADSEX),
  get_NSFG_survey_design_for_sex('fem')
)[order(-total)] |> style_totals_and_percentages()
```

Domain: Females who have ever had intercourse with a male

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    HADSEX == 'YES, R EVER HAD INTERCOURSE'
  ),
  prefix = 'ever_used_method',
  format = 'ever_used_method'
)[order(-total)] |> style_totals_and_percentages()
```



# Discontinuation Due to Dissatisfaction

Domain: For each method, females who have ever used the method

Description: For each method, females who have stopped using the method due to dissatisfaction

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions_in_subdomains(
  row_estimation_function = function(x) {
    estimate_row_total_and_percentage(
      as.formula(sprintf('~ever_quit_method%d', x)),
      subset(
        get_NSFG_survey_design_for_sex('fem'),
        fem1719dt[, get(sprintf('ever_used_method%d', x))]
      )
    )
  },
  format = 'ever_used_method',
  skip = c(20)
)[order(-total)] |> style_totals_and_percentages()
```


## Dissatisfaction with Condom

Domain: Females who have ever discontinued using condom due to dissatisfaction

Description: Reason(s) for dissatisfaction selected from list provided in survey

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    ever_quit_method4
  ),
  prefix = 'condom_quit_reason',
  format = 'REASMFMT'
)[order(-total)] |> style_totals_and_percentages()
```

Domain: Females who have discontinued using condom because "too difficult to use," "side effects," or "other" reason

Description: Reason(s) for dissatisfaction volunteered by respondents

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    condom_quit_reason3 | condom_quit_reason6 | condom_quit_reason15
  ),
  prefix = 'specific_condom_quit_reason',
  format = 'STOPCONDFMT'
)[order(-total)] |> style_totals_and_percentages()
```


## Dissatisfaction with Pill

Domain: Females who have ever discontinued using pill due to dissatisfaction

Description: Reason(s) for dissatisfaction selected from list provided in survey

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    ever_quit_method3
  ),
  prefix = 'pill_quit_reason',
  format = 'REASMFMT'
)[order(-total)] |> style_totals_and_percentages()
```

Domain: Females who have discontinued using pill because "too difficult to use," "side effects," or "other" reason

Description: Reason(s) for dissatisfaction volunteered by respondents

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    pill_quit_reason3 | pill_quit_reason6 | pill_quit_reason15
  ),
  prefix = 'specific_pill_quit_reason',
  format = 'STOPPILLFMT'
)[order(-total)] |> style_totals_and_percentages()
```


## Dissatisfaction with Hormonal IUDs

Domain: Females who have ever discontinued using an hormonal IUD due to dissatisfaction

Description: Reason(s) for dissatisfaction selected from list provided in survey

```{r, dependson='process-pill-quit'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    ever_quit_method32
  ),
  prefix = 'iud_quit_reason',
  format = 'REASMFMT'
)[order(-total)] |> style_totals_and_percentages()
```

Domain: Females who have discontinued using an hormonal IUD because "too difficult to use," "side effects," or "other" reason

Description: Reason(s) for dissatisfaction volunteered by respondents

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    ever_quit_method32 & (
      iud_quit_reason3 |
        iud_quit_reason6 |
        iud_quit_reason15
    )
  ),
  prefix = 'specific_iud_quit_reason',
  format = 'STOPIUDFMT'
)[order(-total)] |> style_totals_and_percentages()
```


## Dissatisfaction with Copper IUDs

Domain: Females who have ever discontinued using a copper IUD due to dissatisfaction

Description: Reason(s) for dissatisfaction selected from list provided in survey

```{r, dependson='process-pill-quit'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    ever_quit_method31
  ),
  prefix = 'iud_quit_reason',
  format = 'REASMFMT'
)[order(-total)] |> style_totals_and_percentages()
```

Domain: Females who have discontinued using copper IUD because "too difficult to use," "side effects," or "other" reason

Description: Reason(s) for dissatisfaction volunteered by respondents

```{r, dependson='process-fem-data'}
estimate_NSFG_mentions(
  survey_design = subset(
    get_NSFG_survey_design_for_sex('fem'),
    ever_quit_method31 & (
      iud_quit_reason3 |
        iud_quit_reason6 |
        iud_quit_reason15
    )
  ),
  prefix = 'specific_iud_quit_reason',
  format = 'STOPIUDFMT'
)[order(-total)] |> style_totals_and_percentages()
```



# Things to Do

* Style tables for output
    * Add alternating row shadowing
    * Limit width of description column so C.I. columns don't get wrapped
* Fix NAs in condom_12m_consistency for males
* Make capitalization in descriptions consistent
* Style plots for output
* Write results and discussion section of report
* Compare own report with published reports
* Write introduction section of report
* Add license to GitHub repository
* Publish report on blog
