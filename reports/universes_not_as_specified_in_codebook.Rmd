---
title: "Variables Discovered Whose Universes Are Not as Specified in Codebook"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(here)
library(knitr)
library(survey)

i_am('reports/universes_not_as_specified_in_codebook.Rmd')

source(here('R/NSFG_helpers.R'))

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r load-data}
fem1719 <- load_NSFG_data('2017_2019', 'FemResp')
male1719 <- load_NSFG_data('2017_2019', 'Male')
```

# `CONDVAG`

This is actually as specified in the codebook, with the exception that some answers for `CONDVAG` exist for cases that have "Not ascertained" values for `VAGSEX`.

## Females

```{r, dependson='load-data'}
fem1719$Data[
  is.na(VAGSEX) | VAGSEX == 1,
  table(
    CONDVAG,
    useNA = 'ifany'
  )
] |> kable()
```

```{r, dependson='load-data'}
fem1719$Data[
  !is.na(CONDVAG),
  table(
    VAGSEX,
    useNA = 'ifany'
  )
] |> kable()
```

## Males

```{r, dependson='load-data'}
male1719$Data[
  is.na(VAGSEX) | VAGSEX == 1,
  table(
    CONDVAG,
    useNA = 'ifany'
  )
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  !is.na(CONDVAG),
  table(
    VAGSEX,
    useNA = 'ifany'
  )
] |> kable()
```


# `MISSPILL`

There are numerous missing `MISSPILL` values for cases that should have `MISSPILL` values as specified in the codebook. However, all of the cases for which there are `MISSPILL` values are cases that are within the universe specified in the codebook.

```{r, dependson='load-data'}
fem1719$Data[
  is.na(MISSPILL) &
    (
      CURRMETH1 == 3 |
      CURRMETH2 == 3 |
      CURRMETH3 == 3 |
      CURRMETH4 == 3 |
      LSTMONMETH1 == 3 |
      LSTMONMETH2 == 3 |
      LSTMONMETH3 == 3 |
      LSTMONMETH4 == 3
    ),
  .(
    CASEID,
    MISSPILL,
    CURRMETH1,
    CURRMETH2,
    CURRMETH3,
    CURRMETH4,
    LSTMONMETH1,
    LSTMONMETH2,
    LSTMONMETH3,
    LSTMONMETH4
  )
] |> kable()
```

```{r, dependson='load-data'}
fem1719$Data[
  !is.na(MISSPILL),
  table(
    CURRMETH1 == 3 |
      CURRMETH2 == 3 |
      CURRMETH3 == 3 |
      CURRMETH4 == 3 |
      LSTMONMETH1 == 3 |
      LSTMONMETH2 == 3 |
      LSTMONMETH3 == 3 |
      LSTMONMETH4 == 3,
    useNA = 'ifany'
  )
] |> kable()
```


# `P12MOCON` and `PXNOFREQ`

## Females

There are a lot of non-answers for cases that are supposed to be in the universe of `P12MOCON`, and a lot of answers for cases not in the universe of `P12MOCON`. I should verify this manually to make sure there is not an error in the way I'm deploying the pivot tables.

For `PXNOFREQ`, all the cases within the universe specified in the codebook have answers in the data table. However, there are answers for `PXNOFREQ` for some cases that are not within the universe specified in the codebook.

```{r, dependson='load-data'}
get_raw_import_for_sex <- function(sex) {
  if (startsWith(sex, 'f')) {
    fem1719
  } else {
    male1719
  }
}

create_pivot_table <- function(
  prefix,
  series,
  id_vars,
  source_dt
) {
  dt <- copy(
    source_dt[
      ,
      c(id_vars, paste0(prefix, series)),
      with = FALSE
    ]
  )

  dt <- melt(
    dt,
    id.vars = id_vars,
    variable.factor = FALSE,
    value.name = prefix
  )

  dt[
    ,
    (paste0(prefix, 'ID')) :=
      as.integer(sub(prefix, '', variable))
  ]

  dt[, variable := NULL]

  dt
}

create_NSFG_pivot_table <- function(prefix, series, id_vars = 'CASEID', sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  pivot_table <- create_pivot_table(prefix, series, id_vars, raw_import$Data)
  setkeyv(pivot_table, id_vars)
}

fem1719_MONSX <- create_NSFG_pivot_table(
  'CMMONSX',
  2:48,
  c('CASEID', 'CMINTVW', 'CMLSTYR')
)[
  create_NSFG_pivot_table('MONSX', 2:48),
  on = c(CASEID = 'CASEID', CMMONSXID = 'MONSXID')
]

fem1719_sex12mo <- fem1719_MONSX[
  !is.na(MONSX) & MONSX == 1 &
    CMMONSX > CMLSTYR &
    CMMONSX <= CMINTVW,
  .(sex12mo = .N > 1),
  by = CASEID
]


fem1719_sex12mo[
  fem1719$Data
][
  sex12mo &
    CONDOM == 1 &
    is.na(P12MOCON),
  .(
    CASEID,
    sex12mo,
    CONDOM,
    P12MOCON
  )
] |> kable()


fem1719_sex12mo[
  fem1719$Data
][
  !is.na(P12MOCON) & (!sex12mo | CONDOM != 1),
  .(
    CASEID,
    P12MOCON,
    CASEID,
    sex12mo,
    CONDOM
  )
] |> kable()


fem1719_sex12mo[
  fem1719$Data
][
  sex12mo &
    EVERUSED == 1 &
    P12MOCON != 1,
  table(PXNOFREQ, useNA = 'ifany')
] |> kable()


fem1719_sex12mo[
  fem1719$Data
][
  !is.na(PXNOFREQ) & !(
    sex12mo &
    EVERUSED == 1 &
    P12MOCON != 1
  ),
  .(
    CASEID,
    PXNOFREQ,
    sex12mo,
    EVERUSED,
    P12MOCON
  )
] |> kable()
```

## Males

Unlike in the females table, there are exactly answers for the universes of `P12MOCON` and `P12MOCONO` as specified in the codebook.

There is one case without an answer to `PXNOFREQ`, but in the universe specified in the codebook. However, all of the cases with answers to `PXNOFREQ` are within the universe specified in the codebook, however.

```{r, dependson='load-data'}
male1719$Data[
  SEXSTAT == 1,
  table(P12MOCONO, useNA = 'ifany')
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  SEXSTAT %in% c(2, 6),
  table(P12MOCON, useNA = 'ifany')
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  !is.na(P12MOCONO),
  table(SEXSTAT, useNA = 'ifany')
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  !is.na(P12MOCON),
  table(SEXSTAT, useNA = 'ifany')
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  PXANYUSE == 1 & PXCONFRQ != 100 & is.na(PXNOFREQ),
  .(
    CASEID,
    PXANYUSE,
    PXCONFRQ,
    PXNOFREQ
  )
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  !is.na(PXNOFREQ) & !(
    PXANYUSE == 1 & PXCONFRQ != 100
  ),
 .N
] |> kable()
```


# `TYPEIUD_1`

While `TYPEIUD_1` has answers for all cases in the universe specified in the codebook, there are two cases that are not in the universe that have answers for `TYPEIUD_1`.

```{r, dependson='load-data'}
equals <- function(x, y) {
  !is.na(x) & !is.na(y) & x == y
}

fem1719$Data[
  equals(METHSTOP01, 19) |
  equals(METHSTOP02, 19) |
  equals(METHSTOP03, 19) |
  equals(METHSTOP04, 19) |
  equals(METHSTOP05, 19) |
  equals(METHSTOP06, 19) |
  equals(METHSTOP07, 19) |
  equals(METHSTOP08, 19) |
  equals(METHSTOP09, 19) |
  equals(METHSTOP10, 19),
  table(
    TYPEIUD_1,
    useNA = 'ifany'
  )
] |> kable()
```

```{r, dependson='load-data'}
fem1719$Data[
  !is.na(TYPEIUD_1) & !(
    equals(METHSTOP01, 19) |
    equals(METHSTOP02, 19) |
    equals(METHSTOP03, 19) |
    equals(METHSTOP04, 19) |
    equals(METHSTOP05, 19) |
    equals(METHSTOP06, 19) |
    equals(METHSTOP07, 19) |
    equals(METHSTOP08, 19) |
    equals(METHSTOP09, 19) |
    equals(METHSTOP10, 19)
  ),
  .(
    CASEID,
    TYPEIUD_1,
    METHSTOP01,
    METHSTOP02,
    METHSTOP03,
    METHSTOP04,
    METHSTOP05,
    METHSTOP06,
    METHSTOP07,
    METHSTOP08,
    METHSTOP09,
    METHSTOP10
  )
] |> kable()
```


* `WHYNOTUSE`
* `YNOSEX` vs `HADSEX`
* `YUSEIUD1`
