---
title: "Contraceptive Usage"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(here)
library(knitr)
library(survey)

i_am('EDA/contraceptive_usage.Rmd')

source(here('R/survey_helpers.R'))
source(here('R/import.R'))

opts_chunk$set(
  echo = TRUE,
  cache = FALSE
)
```


## Female Persons Aged 15-49

```{r, load-data}
fem_2017_2019 <- load_NSFG_data('2017_2019', 'FemResp')
fem_data <- fem_2017_2019$Data
fem_formats <- fem_2017_2019$Formats
```

```{r, setup-data}
fem_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = fem_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```


### Currently Using

```{r}
kable(fem_formats[format_name == 'CONSTATF'])
```

It seems like the NSFG recodes count a respondent as currently using contraception if has had sexual intercourse in the past 3 months with someone of the opposite sex and used a contraceptive during the last intercourse.

```{r}
tablena(fem_data$HADSEX)
tablena(fem_data$SEX3MO)
tablena(fem_data$SEXP3MO)
tablena(fem_data$MTHUSE3)
fem_data[, sum(is.na(HADSEX), is.na(MTHUSE3))]
```

Togther the above variables form a set. Those who have `2` for `HADSEX` are `NA` for `SEX3MO`, and those who have either a `2` for `HADSEX` or `2` for `SEX3MO` are `NA` for `MTHUSE3`.

There is another variable `SEXP30MO` which comes from the months of non-intercourse series that reports a higher count of those who have had sex in the past 3 months than `SEX3MO`.

```{r}
fem_data[, women := 1]

ksvytotalci(~women, fem_svy)
```

According to the U.S. Census Bureau, Current Population Survey, Annual Social and Economic Supplement, 2019, Table 1. Population by Age and Sex: 2019. The female civilian noninstitutionalized population of the United States is ~74,445,000. The estimate generated from the NSFG is consistent with this.

```{r}
kable(fem_formats[startsWith(format_name, 'MTHUSE3F')])

fem_data[, MTHUSE3_factor := factorize(MTHUSE3, 'MTHUSE3F', fem_formats)]

ksvybyci(~women, ~MTHUSE3_factor, fem_svy, svytotal)

ksvyci(~MTHUSE3_factor, fem_svy, svymean)
```

```{r, females-currently-totals, fig.height=8, fig.width=6}
fem_data[, currently := factor(
  fifelse(
    !is.na(MTHUSE3) & MTHUSE3 == 1,
    'Currently using contraception',
    'Not currently using contraception'
  )
)]

female_currently_totals <- svybyci(~women, ~currently, fem_svy, svytotal)

female_currently_totals[, 2:5] <- female_currently_totals[, 2:5] / 10^6

ggplot(
  data = female_currently_totals,
  mapping = aes(
    x = level
  )
) +
  geom_point(
    aes(
      y = estimate
    ),
    size = 4
  ) +
  geom_segment(
    aes(
      xend = level,
      y = `2.5 %`,
      yend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.125, 'inches')),
    size = 1
  ) +
  scale_y_continuous(
    labels = scales::label_number(suffix = 'M', accuracy = 1),
    minor_breaks = \(limits) seq(floor(limits[1]), limits[2], 1)
  ) +
  labs(
    subtitle = 'among females aged 15-49 living in households in the United States',
    title = 'Number of persons currently using contraception',
    y = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.x = element_blank()
  )
```

```{r, females-currently-proportions, fig.width=8, fig.height=2.5}
female_currently_proportions <- svyci(~currently, fem_svy, svymean)

ggplot(
  data = female_currently_proportions[1],
  aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  scale_y_discrete(
    labels = NULL
  ) +
  labs(
    subtitle = 'among females aged 15-49 living in households in the United States',
    title = 'Proportion of persons currently using contraception'
  ) +
  theme_bw() +
  theme(
    axis.ticks.y = element_blank(),
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

```{r}
fem_data[, tablena(METH3M1)]
fem_data[, tablena(LSTMTHP1)]
fem_data[, tablena(METH3M2)]
fem_data[, tablena(LSTMTHP2)]
fem_data[, tablena(METH3M3)]
fem_data[, tablena(LSTMTHP3)]
fem_data[, tablena(METH3M4)]
fem_data[, tablena(LSTMTHP4)]
fem_data[, tablena(LSTMTHP5)]
```

It appears that no women reported using more than 3 methods of contraception at last intercourse with last partner. (`LSTMTHP5` refers to 2nd-to-last partner.)

```{r}
kable(fem_formats[format_name == 'METH3MF'])
```

```{r}
fem_data[, `:=`(
  METH3M1_factor = factorize(METH3M1, 'METH3MF', fem_formats),
  METH3M2_factor = factorize(METH3M2, 'METH3MF', fem_formats),
  METH3M3_factor = factorize(METH3M3, 'METH3MF', fem_formats)
)]

current_female_counts <-  as.data.table(fem_data[, tablena(METH3M1_factor)])[
  as.data.table(fem_data[, tablena(METH3M2_factor)]),
  on = 'x'
][
  as.data.table(fem_data[, tablena(METH3M3_factor)]),
  on = 'x'
]

colnames(current_female_counts) <- c('Method', paste('METH3M', 1:3, sep = ''))

kable(current_female_counts)

dim(current_female_counts)
```

"Respondent sterile (aside from sterilizing operation above)" and "Respondentâ€™s partner sterile (aside from vasectomy above)" should be removed from estimates of those using contraception, if this is the only contraceptive method reported.

Additionally, a count of currently used contraceptive methods is useful.

Both of these can be settled with a single new variable.

```{r}
fem_data[, current_contraceptive_count := fcase(
  !is.na(METH3M3) & !is.element(METH3M3, c(20, 21)) & !is.element(METH3M2, c(20, 21)) & !is.element(METH3M1, c(20, 21)), 3,
  !is.na(METH3M3) & is.element(METH3M3, c(20, 21)) & !is.element(METH3M2, c(20, 21)) & !is.element(METH3M1, c(20, 21)), 2,
  !is.na(METH3M3) & !is.element(METH3M3, c(20, 21)) & is.element(METH3M2, c(20, 21)) & !is.element(METH3M1, c(20, 21)), 2,
  !is.na(METH3M3) & !is.element(METH3M3, c(20, 21)) & !is.element(METH3M2, c(20, 21)) & is.element(METH3M1, c(20, 21)), 2,
  !is.na(METH3M3) & !is.element(METH3M3, c(20, 21)) & is.element(METH3M2, c(20, 21)) & is.element(METH3M1, c(20, 21)), 1,
  !is.na(METH3M3) & is.element(METH3M3, c(20, 21)) & !is.element(METH3M2, c(20, 21)) & is.element(METH3M1, c(20, 21)), 1,
  !is.na(METH3M3) & is.element(METH3M3, c(20, 21)) & is.element(METH3M2, c(20, 21)) & !is.element(METH3M1, c(20, 21)), 1,
  !is.na(METH3M2) & !is.element(METH3M2, c(20, 21)) & !is.element(METH3M1, c(20, 21)), 2,
  !is.na(METH3M2) & !is.element(METH3M2, c(20, 21)) & is.element(METH3M1, c(20, 21)), 1,
  !is.na(METH3M2) & is.element(METH3M2, c(20, 21)) & !is.element(METH3M1, c(20, 21)), 1,
  !is.na(METH3M1) & !is.element(METH3M1, c(20, 21)), 1,
  default = 0
)]

fem_data[, tablena(current_contraceptive_count)]
```

```{r, females-currently-totals-2, fig.height=8, fig.width=6}
fem_data[, currently2 := factor(
  fifelse(
    current_contraceptive_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  )
)]

female_currently_totals2 <- svybyci(~women, ~currently2, fem_svy, svytotal)

female_currently_totals2[, 2:5] <- female_currently_totals2[, 2:5] / 10^6

female_currently_totals2

female_currently_totals

ggplot(
  data = female_currently_totals2,
  mapping = aes(
    x = level
  )
) +
  geom_point(
    aes(
      y = estimate
    ),
    size = 4
  ) +
  geom_segment(
    aes(
      xend = level,
      y = `2.5 %`,
      yend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.125, 'inches')),
    size = 1
  ) +
  scale_y_continuous(
    labels = scales::label_number(suffix = 'M', accuracy = 1),
    minor_breaks = \(limits) seq(floor(limits[1]), limits[2], 1)
  ) +
  labs(
    subtitle = 'among females aged 15-49 living in households in the United States',
    title = 'Number of persons currently using contraception',
    y = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.x = element_blank()
  )
```

```{r, females-currently-proportions-2, fig.width=8, fig.height=2.5}
female_currently_proportions2 <- svyci(~currently2, fem_svy, svymean)

female_currently_proportions2

female_currently_proportions

ggplot(
  data = female_currently_proportions2[1],
  aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  scale_y_discrete(
    labels = NULL
  ) +
  labs(
    subtitle = 'among females aged 15-49 living in households in the United States',
    title = 'Proportion of persons currently using contraception'
  ) +
  theme_bw() +
  theme(
    axis.ticks.y = element_blank(),
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

As expected, removing those who are infertile not due to a sterilizing operation changes the estimates of current contraceptive users, but only slightly.

```{r}
fem_data[, current_contraceptive_count_factor := factor(
  current_contraceptive_count,
  levels = seq(0, 3),
  labels = c('Not using contraception', '1 method', '2 methods', '3 methods')
)]

female_current_contraceptors <- subset(fem_svy, current_contraceptive_count > 0)

female_number_current_methods_totals <- svybyci(~women, ~current_contraceptive_count_factor, female_current_contraceptors, svytotal)

female_number_current_methods_proportions <- svyci(~factor(current_contraceptive_count_factor), female_current_contraceptors, svymean)

female_number_current_methods_totals

female_number_current_methods_proportions
```

```{r, female-number-current-methods-totals, fig.height=3.5, fig.width=12}
female_number_current_methods_totals[, 2:5] <- female_number_current_methods_totals[, 2:5] / 10^6

ggplot(
  data = female_number_current_methods_totals,
  mapping = aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    labels = scales::label_number(suffix = 'M', accuracy = 1)
  ) +
  labs(
    subtitle = 'among females currently using contraception',
    title = 'Total persons by number of contraceptive methods used',
    x = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
```

```{r, female-number-current-methods-proportions, fig.height=3.5, fig.width=12}
ggplot(
  data = female_number_current_methods_proportions,
  aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  labs(
    subtitle = 'among females currently using contraception',
    title = 'Proportion of persons by number of contraceptive methods used'
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

There is enough simultaneous contraceptive usage that it is worth taking it into account when estimating method use.

```{r}
fem_data[, `:=`(
  curr_meth1 = as.integer(METH3M1_factor) == 1 | as.integer(METH3M2_factor) == 1 | as.integer(METH3M3_factor) == 1,
  curr_meth2 = as.integer(METH3M1_factor) == 2 | as.integer(METH3M2_factor) == 2 | as.integer(METH3M3_factor) == 2,
  curr_meth3 = as.integer(METH3M1_factor) == 3 | as.integer(METH3M2_factor) == 3 | as.integer(METH3M3_factor) == 3,
  curr_meth4 = as.integer(METH3M1_factor) == 4 | as.integer(METH3M2_factor) == 4 | as.integer(METH3M3_factor) == 4,
  curr_meth5 = as.integer(METH3M1_factor) == 5 | as.integer(METH3M2_factor) == 5 | as.integer(METH3M3_factor) == 5,
  curr_meth6 = as.integer(METH3M1_factor) == 6 | as.integer(METH3M2_factor) == 6 | as.integer(METH3M3_factor) == 6,
  curr_meth7 = as.integer(METH3M1_factor) == 7 | as.integer(METH3M2_factor) == 7 | as.integer(METH3M3_factor) == 7,
  curr_meth8 = as.integer(METH3M1_factor) == 8 | as.integer(METH3M2_factor) == 8 | as.integer(METH3M3_factor) == 8,
  curr_meth9 = as.integer(METH3M1_factor) == 9 | as.integer(METH3M2_factor) == 9 | as.integer(METH3M3_factor) == 9,
  curr_meth10 = as.integer(METH3M1_factor) == 10 | as.integer(METH3M2_factor) == 10 | as.integer(METH3M3_factor) == 10,
  curr_meth11 = as.integer(METH3M1_factor) == 11 | as.integer(METH3M2_factor) == 11 | as.integer(METH3M3_factor) == 11,
  curr_meth12 = as.integer(METH3M1_factor) == 12 | as.integer(METH3M2_factor) == 12 | as.integer(METH3M3_factor) == 12,
  curr_meth13 = as.integer(METH3M1_factor) == 13 | as.integer(METH3M2_factor) == 13 | as.integer(METH3M3_factor) == 13,
  #curr_meth14 = as.integer(METH3M1_factor) == 14 | as.integer(METH3M2_factor) == 14 | as.integer(METH3M3_factor) == 14,
  curr_meth15 = as.integer(METH3M1_factor) == 15 | as.integer(METH3M2_factor) == 15 | as.integer(METH3M3_factor) == 15,
  #curr_meth16 = as.integer(METH3M1_factor) == 16 | as.integer(METH3M2_factor) == 16 | as.integer(METH3M3_factor) == 16,
  curr_meth17 = as.integer(METH3M1_factor) == 17 | as.integer(METH3M2_factor) == 17 | as.integer(METH3M3_factor) == 17,
  curr_meth18 = as.integer(METH3M1_factor) == 18 | as.integer(METH3M2_factor) == 18 | as.integer(METH3M3_factor) == 18,
  curr_meth19 = as.integer(METH3M1_factor) == 19 | as.integer(METH3M2_factor) == 19 | as.integer(METH3M3_factor) == 19,
  #curr_meth22 = as.integer(METH3M1_factor) == 22 | as.integer(METH3M2_factor) == 22 | as.integer(METH3M3_factor) == 22,
  curr_meth23 = as.integer(METH3M1_factor) == 23 | as.integer(METH3M2_factor) == 23 | as.integer(METH3M3_factor) == 23,
  curr_meth24 = as.integer(METH3M1_factor) == 24 | as.integer(METH3M2_factor) == 24 | as.integer(METH3M3_factor) == 24
)]

female_current_sumcounts <- current_female_counts[, .(sumcount = METH3M1 + METH3M2 + METH3M3), by = Method]

all(
  fem_data[, sum(curr_meth1)] == female_current_sumcounts[1, sumcount],
  fem_data[, sum(curr_meth2)] == female_current_sumcounts[2, sumcount],
  fem_data[, sum(curr_meth3)] == female_current_sumcounts[3, sumcount],
  fem_data[, sum(curr_meth4)] == female_current_sumcounts[4, sumcount],
  fem_data[, sum(curr_meth5)] == female_current_sumcounts[5, sumcount],
  fem_data[, sum(curr_meth6)] == female_current_sumcounts[6, sumcount],
  fem_data[, sum(curr_meth7)] == female_current_sumcounts[7, sumcount],
  fem_data[, sum(curr_meth8)] == female_current_sumcounts[8, sumcount],
  fem_data[, sum(curr_meth9)] == female_current_sumcounts[9, sumcount],
  fem_data[, sum(curr_meth10)] == female_current_sumcounts[10, sumcount],
  fem_data[, sum(curr_meth11)] == female_current_sumcounts[11, sumcount],
  fem_data[, sum(curr_meth12)] == female_current_sumcounts[12, sumcount],
  fem_data[, sum(curr_meth13)] == female_current_sumcounts[13, sumcount],
  #fem_data[, sum(curr_meth14)] == female_current_sumcounts[14, sumcount],
  fem_data[, sum(curr_meth15)] == female_current_sumcounts[15, sumcount],
  #fem_data[, sum(curr_meth16)] == female_current_sumcounts[16, sumcount],
  fem_data[, sum(curr_meth17)] == female_current_sumcounts[17, sumcount],
  fem_data[, sum(curr_meth18)] == female_current_sumcounts[18, sumcount],
  fem_data[, sum(curr_meth19)] == female_current_sumcounts[19, sumcount],
  #fem_data[, sum(curr_meth22)] == female_current_sumcounts[22, sumcount],
  fem_data[, sum(curr_meth23)] == female_current_sumcounts[23, sumcount],
  fem_data[, sum(curr_meth24)] == female_current_sumcounts[24, sumcount]
)
```

```{r, female-current-method-totals, fig.width=12, fig.height=9}
female_current_method_totals <- rbind(
  svyci(~curr_meth1, fem_svy, svytotal)[level == TRUE][, method := 1],
  svyci(~curr_meth2, fem_svy, svytotal)[level == TRUE][, method := 2],
  svyci(~curr_meth3, fem_svy, svytotal)[level == TRUE][, method := 3],
  svyci(~curr_meth4, fem_svy, svytotal)[level == TRUE][, method := 4],
  svyci(~curr_meth5, fem_svy, svytotal)[level == TRUE][, method := 5],
  svyci(~curr_meth6, fem_svy, svytotal)[level == TRUE][, method := 6],
  svyci(~curr_meth7, fem_svy, svytotal)[level == TRUE][, method := 7],
  svyci(~curr_meth8, fem_svy, svytotal)[level == TRUE][, method := 8],
  svyci(~curr_meth9, fem_svy, svytotal)[level == TRUE][, method := 9],
  svyci(~curr_meth10, fem_svy, svytotal)[level == TRUE][, method := 10],
  svyci(~curr_meth11, fem_svy, svytotal)[level == TRUE][, method := 11],
  svyci(~curr_meth12, fem_svy, svytotal)[level == TRUE][, method := 12],
  svyci(~curr_meth13, fem_svy, svytotal)[level == TRUE][, method := 13],
  #svyci(~curr_meth14, fem_svy, svytotal)[level == TRUE][, method := 14],
  svyci(~curr_meth15, fem_svy, svytotal)[level == TRUE][, method := 15],
  #svyci(~curr_meth16, fem_svy, svytotal)[level == TRUE][, method := 16],
  svyci(~curr_meth17, fem_svy, svytotal)[level == TRUE][, method := 17],
  svyci(~curr_meth18, fem_svy, svytotal)[level == TRUE][, method := 18],
  svyci(~curr_meth19, fem_svy, svytotal)[level == TRUE][, method := 19],
  #svyci(~curr_meth22, fem_svy, svytotal)[level == TRUE][, method := 22],
  svyci(~curr_meth23, fem_svy, svytotal)[level == TRUE][, method := 23],
  svyci(~curr_meth24, fem_svy, svytotal)[level == TRUE][, method := 24]
)

female_current_method_totals[, 2:5] <- female_current_method_totals[, 2:5] / 10^6

female_current_method_totals[, method_factor := factorize(method, 'METH3MF', fem_formats)]

ggplot(
  data = female_current_method_totals,
  mapping = aes(
    y = method_factor
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = method_factor,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = \(limits) seq(0, limits[2], 2),
    labels = scales::label_number(suffix = 'M', accuracy = 1),
    minor_breaks = \(limits) seq(0, limits[2], 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  labs(
    subtitle = 'with those using multiple methods counted multiple times',
    title = 'Total female persons by current contraceptive method',
    x = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
```

```{r, female-current-method-proportions, fig.height=9, fig.width=12}
female_current_contraceptors <- subset(fem_svy, current_contraceptive_count > 0)

female_current_method_proportions <- rbind(
  svyci(~curr_meth1, female_current_contraceptors, svymean)[level == TRUE][, method := 1],
  svyci(~curr_meth2, female_current_contraceptors, svymean)[level == TRUE][, method := 2],
  svyci(~curr_meth3, female_current_contraceptors, svymean)[level == TRUE][, method := 3],
  svyci(~curr_meth4, female_current_contraceptors, svymean)[level == TRUE][, method := 4],
  svyci(~curr_meth5, female_current_contraceptors, svymean)[level == TRUE][, method := 5],
  svyci(~curr_meth6, female_current_contraceptors, svymean)[level == TRUE][, method := 6],
  svyci(~curr_meth7, female_current_contraceptors, svymean)[level == TRUE][, method := 7],
  svyci(~curr_meth8, female_current_contraceptors, svymean)[level == TRUE][, method := 8],
  svyci(~curr_meth9, female_current_contraceptors, svymean)[level == TRUE][, method := 9],
  svyci(~curr_meth10, female_current_contraceptors, svymean)[level == TRUE][, method := 10],
  svyci(~curr_meth11, female_current_contraceptors, svymean)[level == TRUE][, method := 11],
  svyci(~curr_meth12, female_current_contraceptors, svymean)[level == TRUE][, method := 12],
  svyci(~curr_meth13, female_current_contraceptors, svymean)[level == TRUE][, method := 13],
  #svyci(~curr_meth14, female_current_contraceptors, svymean)[level == TRUE][, method := 14],
  svyci(~curr_meth15, female_current_contraceptors, svymean)[level == TRUE][, method := 15],
  #svyci(~curr_meth16, female_current_contraceptors, svymean)[level == TRUE][, method := 16],
  svyci(~curr_meth17, female_current_contraceptors, svymean)[level == TRUE][, method := 17],
  svyci(~curr_meth18, female_current_contraceptors, svymean)[level == TRUE][, method := 18],
  svyci(~curr_meth19, female_current_contraceptors, svymean)[level == TRUE][, method := 19],
  #svyci(~curr_meth22, female_current_contraceptors, svymean)[level == TRUE][, method := 22],
  svyci(~curr_meth23, female_current_contraceptors, svymean)[level == TRUE][, method := 23],
  svyci(~curr_meth24, female_current_contraceptors, svymean)[level == TRUE][, method := 24]
)

female_current_method_proportions[, method_factor := factorize(method, 'METH3MF', fem_formats)]

ggplot(
  data = female_current_method_proportions,
  aes(
    y = method_factor
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = method_factor,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  labs(
    subtitle = 'among those currently using contraception',
    title = 'Proportion of female persons by current contraceptive method'
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

There are clearly some contraceptive methods used more than others, but not any one method that the majority of females use.

```{r}
female_current_method_proportions[, sum(estimate)]
```

This does not sum to 1 because some females are using multiple methods.

```{r, female-current-exclusive-method-totals, fig.width=12, fig.height=9}
female_current_exclusive <- subset(fem_svy, current_contraceptive_count == 1)

female_current_exclusive_method_totals <- svybyci(~women, ~METH3M1_factor, female_current_exclusive, svytotal)

female_current_exclusive_method_totals[, 2:5] <- female_current_exclusive_method_totals[, 2:5] / 10^6

ggplot(
  data = female_current_exclusive_method_totals,
  mapping = aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = \(limits) seq(0, limits[2], 2),
    labels = scales::label_number(suffix = 'M', accuracy = 1),
    minor_breaks = \(limits) seq(0, limits[2], 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  labs(
    subtitle = 'among females currently using exclusively one contraceptive method',
    title = 'Total female persons by current contraceptive method',
    x = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
```

It seems like a lot of withdrawal users and condom users are using other contraceptive methods as well.

```{r}
fem_data[current_contraceptive_count == 2, `:=`(
  meth3m1_sorted = pmin(METH3M1, METH3M2),
  meth3m2_sorted = pmax(METH3M1, METH3M2)
)]

fem_data[current_contraceptive_count == 2, table(meth3m1_sorted, meth3m2_sorted)]

unique_current_pairs <- unique(
  fem_data[
    current_contraceptive_count == 2,
    .(meth3m1_sorted, meth3m2_sorted)
  ]
)[order(meth3m1_sorted, meth3m2_sorted)]

unique_current_pairs[, `:=`(
  meth3m_pair = meth3m1_sorted * 100 + meth3m2_sorted,
  meth3m1_sorted_factor = factorize(meth3m1_sorted, 'METH3MF', fem_formats),
  meth3m2_sorted_factor = factorize(meth3m2_sorted, 'METH3MF', fem_formats)
)]

unique_current_pairs[, meth3m_pair_label :=
  paste(meth3m1_sorted_factor, meth3m2_sorted_factor, sep = ' & ')
]

fem_data[, meth3m_pair := meth3m1_sorted * 100 + meth3m2_sorted]

fem_data[, meth3m_pair_factor := factor(
  meth3m_pair,
  levels = unique_current_pairs[, meth3m_pair],
  labels = unique_current_pairs[, meth3m_pair_label]
)]

kable(fem_data[current_contraceptive_count == 2, tablena(meth3m_pair_factor)])
```

```{r}
female_current_pair <- subset(fem_svy, current_contraceptive_count == 2)

female_current_pair_totals <- svybyci(~women, ~meth3m_pair_factor, female_current_pair, svytotal)

kable(female_current_pair_totals)
```

```{r, female-current-pair-totals, fig.width=12, fig.height=18}
female_current_pair_totals[, 2:5] <- female_current_pair_totals[, 2:5] / 10^6

ggplot(
  data = female_current_pair_totals,
  mapping = aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    #breaks = \(limits) seq(0, limits[2], 2),
    labels = scales::label_number(suffix = 'M', accuracy = 0.1),
    #minor_breaks = \(limits) seq(0, limits[2], 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  labs(
    subtitle = 'among females currently using two contraceptive methods',
    title = 'Total female persons by current contraceptive methods',
    x = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
```

Unsurprisingly, the most common method pairing is the two most popular reversible methods of contraception used together. Perhaps more surprising is the number of females who have tubal ligation and whose partners also have had vasectomies, leading to the most potent contraception available.

Many of the method pairings whose 95\% CIs do not include 0 consist of one of the two lower-efficacy methods, i.e., condom or withdrawal, paired with another method. Sometimes these are more effective methods, and sometimes these are less effective methods, such as calendar rhythm. It is worth investigating these separately.

A few exceptions exist to the pairings with condom or withdrawal. One is the aforementioned combination of male and female sterilization procedures. Others include vasectomy & IUD, pill & tubal ligation, and pill & vasectomy.

```{r}
fem_data[, current_condom_exclusive := factor(
  fifelse(
    current_contraceptive_count == 1,
    'Condom Exclusively',
    'Condom With Other Method'
  )
)]

female_current_condom_users <- subset(fem_svy, curr_meth2)

female_current_condom_exclusive_totals <- svybyci(~women, ~current_condom_exclusive, female_current_condom_users, svytotal)

kable(female_current_condom_exclusive_totals)
```

```{r, female-current-condom-exclusive-totals, fig.width=12, fig.height=4}
in_millions <- function(svystat) {
  this_svystat <- copy(as.data.table(svystat))
  this_svystat[, 2:5] <- this_svystat[, 2:5] / 10^6
  this_svystat
}

ggplot(
  data = in_millions(female_current_condom_exclusive_totals),
  mapping = aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    #breaks = \(limits) seq(0, limits[2], 2),
    labels = scales::label_number(suffix = 'M', accuracy = 0.1),
    #minor_breaks = \(limits) seq(0, limits[2], 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  labs(
    subtitle = 'among females currently using condom',
    title = 'Total female persons by whether condom use is exclusive',
    x = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
```

```{r}
female_current_condom_exclusive_proportions <- svyci(~current_condom_exclusive, female_current_condom_users, svymean)

kable(female_current_condom_exclusive_proportions)
```

```{r, female-current-condom-exclusive-proportions, fig.height=3.5, fig.width=12}
ggplot(
  data = female_current_condom_exclusive_proportions,
  aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  labs(
    subtitle = 'among females currently using condom',
    title = 'Proportion of female persons by whether condom use is exclusive',
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

```{r}
fem_data[, current_withdrawal_exclusive := factor(
  fifelse(
    current_contraceptive_count == 1,
    'Withdrawal Exclusively',
    'Withdwawal With Other Method'
  )
)]

female_current_withdrawal_users <- subset(fem_svy, curr_meth5)

female_current_withdrawal_exclusive_totals <- svybyci(~women, ~current_withdrawal_exclusive, female_current_withdrawal_users, svytotal)

kable(female_current_withdrawal_exclusive_totals)
```

```{r, female-current-withdrawal-exclusive-totals, fig.width=12, fig.height=4}
ggplot(
  data = in_millions(female_current_withdrawal_exclusive_totals),
  mapping = aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    #breaks = \(limits) seq(0, limits[2], 2),
    labels = scales::label_number(suffix = 'M', accuracy = 0.1),
    #minor_breaks = \(limits) seq(0, limits[2], 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  labs(
    subtitle = 'among females currently using withdrawal',
    title = 'Total female persons by whether withdrawal use is exclusive',
    x = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
```

```{r}
female_current_withdrawal_exclusive_proportions <- svyci(~current_withdrawal_exclusive, female_current_withdrawal_users, svymean)

kable(female_current_withdrawal_exclusive_proportions)
```

```{r, female-current-withdrawal-exclusive-proportions, fig.height=3.5, fig.width=12}
ggplot(
  data = female_current_withdrawal_exclusive_proportions,
  aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  labs(
    subtitle = 'among females currently using withdrawal',
    title = 'Proportion of female persons by whether withdrawal use is exclusive',
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

Perhaps a better way to look at this is to look at, for each method, what number/proportion of users are also using another method.

```{r}
total_using_another_method <- function(meth) {
  subdomain <- subset(fem_svy, fem_data[, get(sprintf('curr_meth%d', meth))])
  svybyci(~women, ~I(current_contraceptive_count > 1), subdomain, svytotal)
}

totals_using_another_method <- rbindlist(lapply(
  c(1:13, 15, 17:19, 23:24),
  function(x) {
    data.table(
      meth_num = x,
      total_using_another_method(x)
    )
  }
))

totals_using_another_method[, meth_factor := factorize(
  meth_num,
  'METH3MF',
  fem_formats
)]

totals_using_another_method[, 3:6] <- totals_using_another_method[, 3:6] / 10^6

kable(totals_using_another_method[(level), .(meth_factor, estimate, se, `2.5 %`, `97.5 %`)][order(-estimate)])
```

```{r, female-using-another-method-totals, fig.width=12, fig.height=8}
ggplot(
  data = totals_using_another_method[(level)],
  mapping = aes(
    y = reorder(meth_factor, estimate)
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = reorder(meth_factor, estimate),
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    #breaks = \(limits) seq(0, limits[2], 2),
    labels = scales::label_number(suffix = 'M', accuracy = 0.1),
    #minor_breaks = \(limits) seq(0, limits[2], 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  labs(
    subtitle = 'among females currently using contraception',
    title = 'Total female persons using multiple methods, by method',
    x = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
```

```{r}
proportion_using_another_method <- function(meth) {
  subdomain <- subset(fem_svy, fem_data[, get(sprintf('curr_meth%d', meth))])
  svyci(~I(current_contraceptive_count > 1), subdomain, svyciprop)
}

proportions_using_another_method <- rbindlist(lapply(
  c(1:13, 15, 17:19, 23:24),
  function(x) {
    data.table(
      meth_num = x,
      proportion_using_another_method(x)
    )
  }
))

proportions_using_another_method[, meth_factor := factorize(
  meth_num,
  'METH3MF',
  fem_formats
)]

kable(
  proportions_using_another_method[
    , .(meth_factor, estimate, se, `2.5%`, `97.5%`)
  ][order(-estimate)]
)
```

```{r, female-using-another-method-proportions, fig.width=12, fig.height=8}
ggplot(
  data = proportions_using_another_method[se > 0],
  aes(
    y = reorder(meth_factor, estimate)
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = reorder(meth_factor, estimate),
      x = `2.5%`,
      xend = `97.5%`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  labs(
    subtitle = 'among females currently using contraception',
    title = 'Proportion of female persons using multiple methods, by method'
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

The estimates for the proportion of multiple method use among "other" method users, temperature or cervical mucus test, and emergency contraception users are unreliable; their 95\% CIs do not exclude 0 persons total.

Perhaps the most surprising result is that the majority of calendar rhythm, etc, method users also use another method. This is worth looking into more.

Unsurprisingly, a substantial minority of withdrawal (~45\%) and condom users (~40\%) use another method, and these account for the largest numbers of female persons using multiple methods.


## To Do

* Investigate other methods used with calendar methods
* Investigate users for reasons other than contraception
* Find out what "other" methods were specified
* Think about what to do about the triple method users
* Start investigating nonusers


## Outline

### Frames for analysis

#### By Table

* Female persons
* Male persons

#### By Columns

* "Current" -- at last intercourse with male in past 3 months
* "Recent" -- over previous year
* "Ever" -- over lifetime

### Questions for Users

* Which contraceptives?
* How many?
* For reasons other than contraception?
* For "recent," how consistent?
* For "recent" and for multiple methods users, simultaneously or alternatively?
* For "ever" and who have stopped using a method, why did they stop?

### Questions for Nonusers

* Not sexually active?
    * Ever or just now?
* Currently pregnant?
* Trying to get pregnant?
* (Naturally) infertile?
* Exclusively same-sex partner(s)?
* For those fertile, heterosexually active, not using contraception, and not desiring pregnancy, why no contraception usage?

### Covariates/Subdomains

* Want children in future, but not just not now
* By sex education
* By income
* By religion
    * Roman Catholics are a subdomain of interest.
* Second phase vs. first-phase (to investigate nonresponse bias)

### Other

* Try combining with 2015-2017 data for more precise estimates?


## Male Persons Aged 15-49

```{r, load-male-data}
male_2017_2019 <- load_NSFG_data('2017_2019', 'Male')

male_data <- male_2017_2019$Data
```

```{r, setup-male-data}
male_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = male_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```

According to the U.S. Census Bureau, ibid. The number of civilian noninstitutionalized male persons in the United States is ~74,238,000.
