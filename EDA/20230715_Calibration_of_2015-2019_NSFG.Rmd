---
title: "Calibration of 2015-2019 National Survey of Family Growth (NSFG)"
author: "Joshua Born"
output:
  html_document:
    code_folding: show
    toc: true
    toc_depth: 5
    css: wide.css
---

```{r setup, include=FALSE}
library(dplyr)
library(gt)
library(haven)
library(here)
library(readr)
library(srvyr)
library(stringr)
library(tidyr)

knitr::opts_chunk$set(
  cache = TRUE,
  dpi=200,
  echo = FALSE,
  fig.align = 'center',
  fig.height=9.6,
  fig.retina=1.5,
  fig.width=9.6
)
```

```{r load-guttmacher-data}
guttmacher_raw <- read_csv(
  here('data/Guttmacher/NationalAndStatePregnancy_PublicUse.csv'),
  show_col_types = FALSE
)
```

```{r process-national-guttmacher-data, dependson="load-guttmacher-data"}
guttmacher_national <- guttmacher_raw |>
  filter(state == 'US') |>
  select(-state, -notes) |>
  mutate(interpolated = year %in%
      c(1983, 1986, 1989, 1990, 1993, 1994, 1997, 1998, 2001, 2002, 2003, 2006,
        2009, 2012, 2015)
  )

guttmacher_abortions2014 <- guttmacher_national |>
  filter(year == 2014) |>
  select(starts_with('abortions'))

abortionstotal2014 <- pull(guttmacher_abortions2014, abortionstotal)

guttmacher_abortions2012 <- guttmacher_national |>
  filter(year == 2012) |>
  select(starts_with('abortions'))

abortionstotal2012 <- pull(guttmacher_abortions2012, abortionstotal)

guttmacher_abortions2011 <- guttmacher_national |>
  filter(year == 2011) |>
  select(starts_with('abortions'))

abortionstotal2011 <- pull(guttmacher_abortions2011, abortionstotal)
```


## Test Harness from 2014 Guttmacher APS

```{r create-guttmacher-test-harness, dependson="process-national-guttmacher-data"}
guttmacher2014 <- bind_rows(
  tribble(
    ~Level, ~PctAPS2014,
    'lt20',     11.9,
    '1517',     3.4,
    '1819',     8.2,
    '2024',     33.6,
    '2529',     26.5,
    '3034',     15.9,
    '3539',     9.1,
    '40plus',   3.1
  ) |> mutate(
    Variable = 'Age group',
    name = paste0('abortions', Level),
    .before = everything()
  ) |>
    left_join(
      pivot_longer(
        guttmacher_abortions2014,
        cols = everything(),
        values_to = 'TtlAPC2014'
      ),
      by = 'name'
    ) |>
    select(-name),
  tribble(
    ~Level, ~PctAPS2014,
    'Married            ',               14.3,
    'Cohabitating, no married',          31.0,
    'Never-married, not cohabiting',     45.9,
    'Previously married, not cohabiting', 8.8
  ) |>  mutate(
    Variable = 'Relationship status',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    'White',    38.7,
    'Black',    27.6,
    'Hispanic', 24.8,
    'Asian/Pacific Islander', 5.5,
    'Other',    3.4
  ) |>  mutate(
    Variable = 'Race/ethnicity',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    'U.S.-born',     83.9,
    'Foreign-born',  16.1
  ) |>  mutate(
    Variable = 'Nativity',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    '<high school',                  8.9,
    'High school graduate/GED',      27.0,
    'Some college/associate degree', 40.9,
    'College graduate',               23.1
  ) |>  mutate(
    Variable = 'Educational attainment',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    '0',   40.7,
    '1',   26.2,
    '>=2', 33.1
  ) |>  mutate(
    Variable = 'No. of prior births',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    '>=1', 44.8
  ) |>  mutate(
    Variable = 'No. of previous induced abortions',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    '<100',    49.3,
    '100-199', 25.7,
    '>=200',   25.0
  ) |>  mutate(
    Variable = 'Family income as % of poverty level',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    'Mainline Protestant',    17.3,
    'Evangelical Protestant', 12.8,
    'Roman Catholic',         23.7,
    'Other',                  8.2,
    'None',                   38.0
  ) |>  mutate(
    Variable = 'Religious affiliation',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    'Heterosexual/straight',    94.4,
    'Homosexual/gay/lesbian',   0.3,
    'Bisexual',                 4.2,
    'Something else',           1.1
  ) |>  mutate(
    Variable = 'Sexual orientation',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctAPS2014,
    'Any method',  50.9,
    'Sterilization',  0.2,
    'Long-active reversible methods', 1.0,
    'Short-acting hormonal methods', 14.2,
    'Not using a method', 49.1,
    'IUD', 0.8,
    'Implant', 0.2,
    'Injectables', 1.6,
    'Ring', 1.4,
    'Pill', 12.6,
    'Patch', 0.2,
    'Condom', 24.2,
    'Withdrawal', 8.6,
    'Other', 1.1,
    'Not using, but ever used', 39.2,
    'Never used', 9.9
  ) |>  mutate(
    Variable = 'Contraceptive used in month pregnancy began',
    .before = everything()
  )
) |> mutate(
  Level = str_squish(Level),
  PctAPS2014 = PctAPS2014 / 100,
  TtlAPS2014 = as.integer(round(abortionstotal2014 * PctAPS2014)),
  .before = 'TtlAPC2014'
)

guttmacher2014 |>
  gt() |>
  fmt_percent(starts_with('Percent'), decimals = 1) |>
  fmt_number(starts_with('Ttl'), decimals = 0)
```


## Test Harness from CDC Abortion Surveillance

### 2014

```{r create-CDC2014-test-harness, dependson="process-national-guttmacher-data"}
CDC2014 <- bind_rows(
  tribble(
    ~Level, ~PctCDC,
    'lt15',   0.3,
    '1519',   10.4,
    '2024',   32.2,
    '2529',   26.7,
    '3034',   17.1,
    '3539',   9.7,
    '40plus', 3.6
  ) |> mutate(
    Variable = 'Age group',
    name = paste0('abortions', Level),
    .before = everything()
  ) |> left_join(
    pivot_longer(
      guttmacher_abortions2014,
      cols = everything(),
      values_to = 'TtlAPC'
    ),
    by = 'name'
  ) |> select(-name),
  tribble(
    ~Level, ~PctCDC,
    '<=8',   64.9,
    '9-13',  26.1,
    '14-15', 3.6,
    '16-17', 2.2,
    '18-20', 1.9,
    '>=21',  1.3
  ) |>  mutate(
    Variable = 'Gestational age',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    'White',    38.0,
    'Black',    36.0,
    'Other (incl. Asian/Pacific Islander)',    7.7,
    'Hispanic', 18.3,
  ) |>  mutate(
    Variable = 'Race/ethnicity',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    'Married',    14.5,
    'Unmarried',  85.5
  ) |>  mutate(
    Variable = 'Relationship status',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    '0',   40.4,
    '1',   26.0,
    '2',   19.7,
    '3',   8.7,
    '>=4', 5.1
  ) |>  mutate(
    Variable = 'No. of prior births',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    '0',   55.1,
    '1',   24.7,
    '2',   11.6,
    '>=3', 8.6
  ) |>  mutate(
    Variable = 'No. of previous induced abortions',
    .before = everything()
  )
) |> mutate(
  Level = str_squish(Level),
  PctCDC = PctCDC / 100,
  TtlCDC = as.integer(round(abortionstotal2014 * PctCDC)),
  .before = 'TtlAPC'
)

CDC2014 |>
  gt() |>
  fmt_percent(starts_with('Percent'), decimals = 1) |>
  fmt_number(starts_with('Ttl'), decimals = 0)
```


### 2012

```{r create-CDC2012-test-harness, dependson="process-national-guttmacher-data"}
CDC2012 <- bind_rows(
  tribble(
    ~Level, ~PctCDC,
    'lt15',   0.4,
    '1519',   12.2,
    '2024',   32.8,
    '2529',   25.4,
    '3034',   16.4,
    '3539',   9.1,
    '40plus', 3.7
  ) |> mutate(
    Variable = 'Age group',
    name = paste0('abortions', Level),
    .before = everything()
  ) |> left_join(
    pivot_longer(
      guttmacher_abortions2012,
      cols = everything(),
      values_to = 'TtlAPC'
    ),
    by = 'name'
  ) |> select(-name),
  tribble(
    ~Level, ~PctCDC,
    '<=8',   65.8,
    '9-13',  25.6,
    '14-15', 3.5,
    '16-17', 1.8,
    '18-20', 1.9,
    '>=21',  1.3
  ) |>  mutate(
    Variable = 'Gestational age',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    'White',    37.6,
    'Black',    36.7,
    'Other (incl. Asian/Pacific Islander)',    7.0,
    'Hispanic', 18.7,
  ) |>  mutate(
    Variable = 'Race/ethnicity',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    'Married',    14.7,
    'Unmarried',  85.3
  ) |>  mutate(
    Variable = 'Relationship status',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    '0',   40.3,
    '1',   26.2,
    '2',   19.6,
    '3',   8.7,
    '>=4', 5.3
  ) |>  mutate(
    Variable = 'No. of prior births',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    '0',   55.7,
    '1',   24.6,
    '2',   11.0,
    '>=3', 8.6
  ) |>  mutate(
    Variable = 'No. of previous induced abortions',
    .before = everything()
  )
) |> mutate(
  Level = str_squish(Level),
  PctCDC = PctCDC / 100,
  TtlCDC = as.integer(round(abortionstotal2012 * PctCDC)),
  .before = 'TtlAPC'
)

CDC2012 |>
  gt() |>
  fmt_percent(starts_with('Percent'), decimals = 1) |>
  fmt_number(starts_with('Ttl'), decimals = 0)
```


### 2011

```{r create-CDC2011-test-harness, dependson="process-national-guttmacher-data"}
CDC2011 <- bind_rows(
  tribble(
    ~Level, ~PctCDC,
    'lt15',   0.4,
    '1519',   13.5,
    '2024',   32.9,
    '2529',   24.9,
    '3034',   15.8,
    '3539',   8.9,
    '40plus', 3.6
  ) |> mutate(
    Variable = 'Age group',
    name = paste0('abortions', Level),
    .before = everything()
  ) |> left_join(
    pivot_longer(
      guttmacher_abortions2011,
      cols = everything(),
      values_to = 'TtlAPC'
    ),
    by = 'name'
  ) |> select(-name),
  tribble(
    ~Level, ~PctCDC,
    '<=8',   64.5,
    '9-13',  26.9,
    '14-15', 3.5,
    '16-17', 1.9,
    '18-20', 1.9,
    '>=21',  1.4
  ) |>  mutate(
    Variable = 'Gestational age',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    'White',    37.2,
    'Black',    36.2,
    'Other (incl. Asian/Pacific Islander)',    7.0,
    'Hispanic', 19.7,
  ) |>  mutate(
    Variable = 'Race/ethnicity',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    'Married',    14.5,
    'Unmarried',  85.5
  ) |>  mutate(
    Variable = 'Relationship status',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    '0',   39.9,
    '1',   26.5,
    '2',   19.6,
    '3',   8.7,
    '>=4', 5.2
  ) |>  mutate(
    Variable = 'No. of prior births',
    .before = everything()
  ),
  tribble(
    ~Level, ~PctCDC,
    '0',   53.7,
    '1',   25.5,
    '2',   11.6,
    '>=3', 9.3
  ) |>  mutate(
    Variable = 'No. of previous induced abortions',
    .before = everything()
  )
) |> mutate(
  Level = str_squish(Level),
  PctCDC = PctCDC / 100,
  TtlCDC = as.integer(round(abortionstotal2011 * PctCDC)),
  .before = 'TtlAPC'
)

CDC2011 |>
  gt() |>
  fmt_percent(starts_with('Percent'), decimals = 1) |>
  fmt_number(starts_with('Ttl'), decimals = 0)
```


### Combined

```{r combine-CDC-test-harnesses, dependson=c("create-CDC2014-test-harness", "create-CDC2012-test-harness", "create-CDC2011-test-harness"), R.options=list(width = 3000)}
CDC_combined <- full_join(
  CDC2011,
  CDC2012,
  by = c('Variable', 'Level'),
  suffix = c('2011', '2012')
) |>
  full_join(
    rename_with(
      CDC2014,
      ~paste0(.x, '2014'),
      starts_with(c('Pct', 'Ttl'))
    ),
    by = c('Variable', 'Level')
  ) |>
  select(-contains('APC'))

CDC_combined |>
  gt() |>
  fmt_percent(starts_with('Percent'), decimals = 1) |>
  fmt_number(starts_with('Ttl'), decimals = 0)
```


## Combined Abortion Test Harness

```{r combine-guttmacher-and-CDC-test-harnesses, dependson=c("combine-CDC-test-harnesses", "create-guttmacher-test-harness")}
combine_levels <- function(tbl, variable, levels, new_level, remove = TRUE) {
  new_row <- tbl |>
    filter(Variable == variable, Level %in% levels) |>
    group_by(Variable) |>
    summarize(across(c(-Level), sum)) |>
    mutate(Level = new_level, .after = Variable)

  if (remove) {
    add_row(tbl, new_row, .before = 1) |>
      filter(!is.element(Level, levels))
  } else {
    add_row(tbl, new_row, .before = 1)
  }
}

CDC_releveled <- CDC_combined |>
  combine_levels(
    'Age group',
    c('lt15', '1519'),
    'lt20'
  ) |>
  combine_levels(
    'No. of previous induced abortions',
    c('1', '2', '>=3'),
    '>=1',
    remove = FALSE
  ) |>
  combine_levels(
    'No. of prior births',
    c('2', '3', '>=4'),
    '>=2',
    remove = FALSE
  )

guttmacher_releveled <- guttmacher2014 |>
  select(-TtlAPC2014) |>
  combine_levels(
    'Relationship status',
    c('Cohabitating, no married', 'Never-married, not cohabiting', 'Previously married, not cohabiting'),
    'Unmarried',
    remove = FALSE
  )

full_join(
  CDC_releveled,
  guttmacher_releveled,
  by = c('Variable', 'Level')
) |>
  arrange(Variable) |>
  gt() |>
  fmt_percent(starts_with('Pct'), decimals = 1) |>
  fmt_number(starts_with('Ttl'), decimals = 0)
```


## Uncalibrated NSFG Estimates

```{r load-NSFG-data}
preg2017_2019 <- read_sas(
  data_file = here('data/NSFG/d2017_2019fempreg.sas7bdat'),
  catalog_file = here('data/NSFG/d2017_2019fempreg.sas7bcat')
)
preg2015_2017 <- read_sas(
  data_file = here('data/NSFG/d2015_2017fempreg.sas7bdat'),
  catalog_file = here('data/NSFG/d2015_2017fempreg.sas7bcat')
)
wgt2011_2019 <- read_sas(
  data_file = here('data/NSFG/d2011_2019femwgt.sas7bdat')
)
```

```{r create-pregnancies-table-survey-object, dependson="load-NSFG-data"}
preg_2015_2019_svy <- bind_rows(
  select(preg2015_2017, SECU, SEST, CASEID, DATEND, OUTCOME, AGEPREG, PRGLNGTH),
  select(preg2017_2019, SECU, SEST, CASEID, DATEND, OUTCOME, AGEPREG)
) |>
left_join(
  wgt2011_2019,
  by = join_by(CASEID)
) |>
mutate(
  Year = DATEND
) |> 
as_survey_design(
  strata = SEST,
  ids = SECU,
  weights = WGT2015_2019,
  nest = TRUE
)
```

