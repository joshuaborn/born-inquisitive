---
title: "Verification of Census Counts Used in Post-Stratification"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
    css: wide.css
---

```{r setup, include=FALSE}
library(dplyr)
library(here)
library(tibble)
library(gt)

knitr::opts_chunk$set(
  cache = TRUE,
  dpi=200,
  echo = TRUE,
  fig.align = 'center',
  fig.height=9.6,
  fig.retina=1.5,
  fig.width=9.6
)
```


### Compare 2015-2019 Targets with Original 2015-2017 and 2017-2019 Targets

```{r compare-2015-2019}
readRDS(
  here('data/Census/prepared/census_for_2015_2019.Rds')
) |>
  filter(SEX_f == 'Female') |>
  mutate(
    poststrat_age_race = gsub(
      '[ -]',
      '_',
      paste0(
        gsub(' to | years', '_', AGEGROUP_f),
        race_ethn_f
      )
    )
  ) |>
  rename(MyTarget = pop) |>
  select(poststrat_age_race, MyTarget) |>
  full_join(
    tribble(
       ~Theirs17_19, ~poststrat_age_race,
      1501808, 'Age_15_19_Non_Hispanic_Black',
      1588120, 'Age_20_24_Non_Hispanic_Black',
      1832548, 'Age_25_29_Non_Hispanic_Black',
      1561910, 'Age_30_34_Non_Hispanic_Black',
      1502718, 'Age_35_39_Non_Hispanic_Black',
      1354692, 'Age_40_44_Non_Hispanic_Black',
      1402470, 'Age_45_49_Non_Hispanic_Black',
      2364573, 'Age_15_19_Hispanic',
      2292692, 'Age_20_24_Hispanic',
      2319186, 'Age_25_29_Hispanic',
      2145325, 'Age_30_34_Hispanic',
      2147094, 'Age_35_39_Hispanic',
      2006586, 'Age_40_44_Hispanic',
      1857318, 'Age_45_49_Hispanic',
      5572796, 'Age_15_19_Non_Hispanic_Non_Black',
      6070213, 'Age_20_24_Non_Hispanic_Non_Black',
      7288890, 'Age_25_29_Non_Hispanic_Non_Black',
      7164179, 'Age_30_34_Non_Hispanic_Non_Black',
      7059902, 'Age_35_39_Non_Hispanic_Non_Black',
      6488082, 'Age_40_44_Non_Hispanic_Non_Black',
      7150824, 'Age_45_49_Non_Hispanic_Non_Black'
    ),
    by = join_by(poststrat_age_race)
  ) |>
  full_join(
    tribble(
       ~Theirs15_17, ~poststrat_age_race,
      1519880, 'Age_15_19_Non_Hispanic_Black',
      1654845, 'Age_20_24_Non_Hispanic_Black',
      1723537, 'Age_25_29_Non_Hispanic_Black',
      1508048, 'Age_30_34_Non_Hispanic_Black',
      1451485, 'Age_35_39_Non_Hispanic_Black',
      1350570, 'Age_40_44_Non_Hispanic_Black',
      1397935, 'Age_45_49_Non_Hispanic_Black',
      2270479, 'Age_15_19_Hispanic',
      2263325, 'Age_20_24_Hispanic',
      2183216, 'Age_25_29_Hispanic',
      2113468, 'Age_30_34_Hispanic',
      2068823, 'Age_35_39_Hispanic',
      1942468, 'Age_40_44_Hispanic',
      1755392, 'Age_45_49_Hispanic',
      5663957, 'Age_15_19_Non_Hispanic_Non_Black',
      6258438, 'Age_20_24_Non_Hispanic_Non_Black',
      7250571, 'Age_25_29_Non_Hispanic_Non_Black',
      7123702, 'Age_30_34_Non_Hispanic_Non_Black',
      6813279, 'Age_35_39_Non_Hispanic_Non_Black',
      6559123, 'Age_40_44_Non_Hispanic_Non_Black',
      7345545, 'Age_45_49_Non_Hispanic_Non_Black'
    ),
    by = join_by(poststrat_age_race)
  ) |>
  mutate(
    TheirsInter = (Theirs17_19 + Theirs15_17) / 2,
    DiffInter = TheirsInter - MyTarget,
    Diff17_19 = Theirs17_19 - MyTarget,
    Diff15_17 = Theirs15_17 - MyTarget
  ) |>
  gt() |>
  fmt_number(decimal = 0)
```


### Compare 2011-2015 Targets with Original 2011-2013 and 2013-2015 Targets

```{r compare-2011-2015}
readRDS(
  here('data/Census/prepared/census_for_2011_2015.Rds')
) |>
  filter(SEX_f == 'Female') |>
  mutate(
    poststrat_age_race = gsub(
      '[ -]',
      '_',
      paste0(
        gsub(' to | years', '_', AGEGROUP_f),
        race_ethn_f
      )
    )
  ) |>
  rename(MyTarget = pop) |>
  select(poststrat_age_race, MyTarget) |>
  full_join(
    tribble(
      ~Theirs11_13, ~poststrat_age_race,
      1567994, 'Age_15_19_Non_Hispanic_Black',
      1661735, 'Age_20_24_Non_Hispanic_Black',
      1487951, 'Age_25_29_Non_Hispanic_Black',
      1456005, 'Age_30_34_Non_Hispanic_Black',
      1340371, 'Age_35_39_Non_Hispanic_Black',
      1412020, 'Age_40_44_Non_Hispanic_Black',
      2144110, 'Age_15_19_Hispanic',
      2105193, 'Age_20_24_Hispanic',
      2025936, 'Age_25_29_Hispanic',
      2036033, 'Age_30_34_Hispanic',
      1927903, 'Age_35_39_Hispanic',
      1784861, 'Age_40_44_Hispanic',
      5834887, 'Age_15_19_Non_Hispanic_Non_Black',
      6571515, 'Age_20_24_Non_Hispanic_Non_Black',
      6934209, 'Age_25_29_Non_Hispanic_Non_Black',
      6849804, 'Age_30_34_Non_Hispanic_Non_Black',
      6442521, 'Age_35_39_Non_Hispanic_Non_Black',
      7304315, 'Age_40_44_Non_Hispanic_Non_Black',
    ),
    by = join_by(poststrat_age_race)
  ) |>
  full_join(
    tribble(
      ~Theirs13_15, ~poststrat_age_race,
      1518731, 'Age_15_19_Non_Hispanic_Black',
      1722220, 'Age_20_24_Non_Hispanic_Black',
      1580865, 'Age_25_29_Non_Hispanic_Black',
      1492205, 'Age_30_34_Non_Hispanic_Black',
      1377694, 'Age_35_39_Non_Hispanic_Black',
      1403751, 'Age_40_44_Non_Hispanic_Black',
      2192179, 'Age_15_19_Hispanic',
      2233143, 'Age_20_24_Hispanic',
      2084503, 'Age_25_29_Hispanic',
      2106319, 'Age_30_34_Hispanic',
      2000317, 'Age_35_39_Hispanic',
      1893581, 'Age_40_44_Hispanic',
      5715472, 'Age_15_19_Non_Hispanic_Non_Black',
      6516762, 'Age_20_24_Non_Hispanic_Non_Black',
      7059255, 'Age_25_29_Non_Hispanic_Non_Black',
      7048187, 'Age_30_34_Non_Hispanic_Non_Black',
      6539703, 'Age_35_39_Non_Hispanic_Non_Black',
      7006825, 'Age_40_44_Non_Hispanic_Non_Black'
    ),
    by = join_by(poststrat_age_race)
  ) |>
  mutate(
    TheirsInter = (Theirs11_13 + Theirs13_15) / 2,
    DiffInter = TheirsInter - MyTarget,
    Diff11_13 = Theirs11_13 - MyTarget,
    Diff13_15 = Theirs13_15 - MyTarget
  ) |>
  gt() |>
  fmt_number(decimal = 0)
```
