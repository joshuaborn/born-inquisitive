---
title: "Contraceptive Use in Past 12 Months"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(here)
library(knitr)
library(survey)

i_am('EDA/009_past_12_months.Rmd')

source(here('R/EDA_helpers.R'))
source(here('R/factor_helpers.R'))
source(here('R/import.R'))
source(here('R/survey_helpers.R'))

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r fem-load-data}
fem_2017_2019 <- load_NSFG_data('2017_2019', 'FemResp')
fem_2017_2019_formats <- fem_2017_2019$Formats
```

```{r fem-process-data, dependson=c('fem-load-data')}
fem_2017_2019_data <- copy(fem_2017_2019$Data[, .(
  ANYBC12 = factorize(ANYBC12, 'ANYBCF', fem_2017_2019_formats),
  CASEID,
  CONSTAT1 = factorize(CONSTAT1, 'CONSTATF', fem_2017_2019_formats),
  EVERUSED = factorize(EVERUSED, 'YESNONAF', fem_2017_2019_formats),
  LSEXPREG = factorize(LSEXPREG, 'Y1N2RECF', fem_2017_2019_formats),
  METH3M1,
  METH3M2,
  METH3M3,
  PARTS1YR = factorize(PARTS1YR, 'PARTS1YR', fem_2017_2019_formats),
  P1YRELP = factorize(P1YRELP, 'P1YRELP', fem_2017_2019_formats),
  POSIBLMN = factorize(POSIBLMN, 'Y1N5RDF', fem_2017_2019_formats),
  POSIBLPG = factorize(POSIBLPG, 'Y1N5RDF', fem_2017_2019_formats),
  PSURGSTR = factorize(PSURGSTR, 'Y1N5C', fem_2017_2019_formats),
  SECU,
  SEST,
  SEX3MO = factorize(SEX3MO, 'Y1N2RECF', fem_2017_2019_formats),
  SEXONCE = factorize(SEXONCE, 'SEXONCE', fem_2017_2019_formats),
  TUBS = factorize(TUBS, 'Y1N5C', fem_2017_2019_formats),
  WGT2017_2019,
  WYNOLSTP = factorize(WYNOLSTP, 'Y1N5RDF', fem_2017_2019_formats),
  WYNOTUSE = factorize(WYNOTUSE, 'Y1N5RDF', fem_2017_2019_formats)
)])

# remove sterility not from contraceptive procedure from METH3M series
fem_2017_2019_data[
  METH3M3 %in% 20:21,
  `:=`(
    METH3M3 = NA
  )
]
fem_2017_2019_data[
  METH3M2 %in% 20:21,
  `:=`(
    METH3M2 = METH3M3,
    METH3M3 = NA
  )
]
fem_2017_2019_data[
  METH3M1 %in% 20:21,
  `:=`(
    METH3M1 = METH3M2,
    METH3M2 = METH3M3,
    METH3M3 = NA
  )
]

# make METH3M series variables into factors
fem_2017_2019_data[, `:=`(
  METH3M1 = factorize(METH3M1, 'METH3MF', fem_2017_2019_formats),
  METH3M2 = factorize(METH3M2, 'METH3MF', fem_2017_2019_formats),
  METH3M3 = factorize(METH3M3, 'METH3MF', fem_2017_2019_formats)
)]

# create boolean variables for whether each specific method is currently used
for (x in c(1:19, 22:24)) {
  set(
    fem_2017_2019_data,
    j = sprintf('using3m_meth%d', x),
    value = has_level(fem_2017_2019_data$METH3M1, x) |
      has_level(fem_2017_2019_data$METH3M2, x) |
      has_level(fem_2017_2019_data$METH3M3, x)
  )
}

# count any respondents who are sexually active and whose last intercourse was with husband or cohabitating partner who has an active vasectomy as using vasectomy as a contraceptive method
fem_2017_2019_data[, using3m_meth3 := fifelse(
  SEX3MO == 'YES' & PSURGSTR == 'YES' & (
    P1YRELP == 'Current husband or (current husband from whom she is separated)' |
    P1YRELP == 'Current cohabiting partner'
  ),
  TRUE,
  using3m_meth3
)]

# count any respondents with current tubal ligations who are sexually active as currently using tubal ligation as a contraceptive method
fem_2017_2019_data[, using3m_meth4 := fifelse(
  SEX3MO == 'YES' & TUBS == 'YES',
  TRUE,
  using3m_meth4
)]

# create variable counting number of current methods
fem_2017_2019_data[
  ,
  meth3m_count := rowSums(.SD),
  .SDcols = patterns('^using3m_meth')
]

# set master categorization for contraceptive use
fem_2017_2019_data[,
  curr_use := factor(fcase(
    meth3m_count > 0,
      'Used at least one contraceptive method at last intercourse',
    SEX3MO != 'YES',
      'Did not have sexual intercourse with male in past 3 months',
    LSEXPREG == 'YES',
      'Pregnant in month of last intercourse',
    CONSTAT1 == 'Postpartum',
      'Postpartum',
    (WYNOTUSE == 'Yes' | WYNOLSTP == 'Yes'),
      'Currently trying to conceive',
    POSIBLPG == 'No',
      'Physically unable to conceive',
    POSIBLMN == 'No' & (
      P1YRELP == 'Current cohabiting partner' |
      P1YRELP == 'Current husband or (current husband from whom she is separated)'
    ),
      'Last intercourse was with partner who is physically unable to conceive',
    default = 'Otherwise did not use contraception at last intercourse'
  ))
]

# set master categorization for 12 month contraceptive use
fem_2017_2019_data[,
  mos12_use := factor(fcase(
    PARTS1YR == 'NONE' | PARTS1YR == 'Not Applicable',
      'Did not have sexual intercourse with male in past 12 months',
    default = 'Otherwise did not use contraception in past 12 months'
  ))
]

# create survey design object
fem_2017_2019_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = fem_2017_2019_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```


```{r male-load-data}
male_2017_2019 <- load_NSFG_data('2017_2019', 'Male')
male_2017_2019_formats <- male_2017_2019$Formats
```

```{r male-process-data, dependson=c('male-load-data')}
male_2017_2019_data <- copy(male_2017_2019$Data[, .(
  CWPPOSS = factorize(CWPPOSS, 'Y1N5RDF', male_2017_2019_formats),
  CWPPRGNW = factorize(CWPPRGNW, 'Y1N5RDF', male_2017_2019_formats),
  CWPRECBC = factorize(CWPRECBC, 'Y1N5RDF', fem_2017_2019_formats),
  CWPTRYPG = factorize(CWPTRYPG, 'Y1N5RDF', male_2017_2019_formats),
  FATHPOSS = factorize(FATHPOSS, 'Y1N5RDF', male_2017_2019_formats),
  METH3M1 = factorize(METH3M1, 'METH3MF', male_2017_2019_formats),
  METH3M2 = factorize(METH3M2, 'METH3MF', male_2017_2019_formats),
  METH3M3 = factorize(METH3M3, 'METH3MF', male_2017_2019_formats),
  METH3M4 = factorize(METH3M4, 'METH3MF', male_2017_2019_formats),
  P1COHABIT = factorize(P1COHABIT, 'Y1N5RDF', male_2017_2019_formats),
  P1CURRWIFE = factorize(P1CURRWIFE, 'Y1N5RDF', male_2017_2019_formats),
  PSURGSTR = factorize(PSURGSTR, 'N0Y1CF', male_2017_2019_formats),
  PXANYUSE = factorize(PXANYUSE, 'Y1N5RDF', male_2017_2019_formats),
  PXANYUSE2 = factorize(PXANYUSE2, 'Y1N5RDF', male_2017_2019_formats),
  PXANYUSE3 = factorize(PXANYUSE3, 'Y1N5RDF', male_2017_2019_formats),
  PXCPREG = factorize(PXCPREG, 'Y1N5RDF', male_2017_2019_formats),
  PXFUSE = factorize(PXFUSE, 'Y1N5RDF', male_2017_2019_formats),
  PXMTONCE = factorize(PXMTONCE, 'Y1N5RDF', male_2017_2019_formats),
  PXTRYING = factorize(PXTRYING, 'Y1N5RDF', male_2017_2019_formats),
  RSURGSTR  = factorize(RSURGSTR, 'N0Y1RDF', male_2017_2019_formats),
  SECU,
  SEST,
  SEX3MO = factorize(SEX3MO, 'SEX3MO', male_2017_2019_formats),
  SEX12MO = factorize(SEX12MO, 'SEX3MO', male_2017_2019_formats),
  SEXONCE = factorize(SEXONCE, 'SEXONCE', male_2017_2019_formats),
  WGT2017_2019
)])

# create boolean variables for whether each specific method is currently used
for (x in 1:13) {
  set(
    male_2017_2019_data,
    j = sprintf('using3m_meth%d', x),
    value = has_level(male_2017_2019_data$METH3M1, x) |
      has_level(male_2017_2019_data$METH3M2, x) |
      has_level(male_2017_2019_data$METH3M3, x) |
      has_level(male_2017_2019_data$METH3M4, x)
  )
}

# count any respondents who are sexually active and who have an active vasectomy as using vasectomy as a contraceptive method
male_2017_2019_data[, using3m_meth3 := fifelse(
  SEX3MO == 'YES, HAD INTERCOURSE' & RSURGSTR == 'YES',
  TRUE,
  using3m_meth3
)]

# count any respondents who are sexually active and who are married or cohabitating and whose last intercourse was with wife or cohabitating partner who has active tubal ligation
male_2017_2019_data[, using3m_meth5 := fifelse(
  SEX3MO == 'YES, HAD INTERCOURSE' &
    (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') &
    PSURGSTR == 'YES',
  TRUE,
  using3m_meth5
)]

# create variable counting number of current methods
male_2017_2019_data[
  ,
  meth3m_count := rowSums(.SD),
  .SDcols = patterns('^using3m_meth')
]

# set master categorization for contraceptive use
male_2017_2019_data[,
  curr_use := factor(fcase(
    meth3m_count > 0,
      'Used at least one contraceptive method at last intercourse',
    SEX3MO != 'YES, HAD INTERCOURSE',
      'Did not have sexual intercourse with female in past 3 months',
    PXCPREG == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPRGNW == 'Yes'),
      'Last intercourse was with partner who is pregnant',
    PXTRYING == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPTRYPG == 'Yes'),
      'Last intercourse was with partner who is trying to conceive',
    FATHPOSS == 'No',
      'Physically unable to conceive',
    (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPOSS == 'No',
      'Last intercourse was with wife or cohabitating partner who is physically unable to concieve',
    default = 'Otherwise did not use contraception at last intercourse'
  ))
]

# set master categorization for 12 month contraceptive use
male_2017_2019_data[,
  mos12_use := factor(fcase(
    SEX12MO != 'YES, HAD INTERCOURSE',
      'Did not have sexual intercourse with female in past 12 months',
    default = 'Otherwise did not use contraception in past 12 months'
  ))
]

# create survey design object
male_2017_2019_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = male_2017_2019_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```


# Otherwise Did Not Use Contraception at Last Intercourse


## Used Contraception in Past 12 Months

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(ANYBC12 == 'Yes, at least one month of method use'),
    subset(
      fem_2017_2019_svy,
      curr_use == 'Otherwise did not use contraception at last intercourse'
    ),
    svyciprop
  ),
  type = 'proportion',
  domain = 'females who otherwise did not use contraception at last intercourse',
  title = 'who used at least one method of contraception in the past 12 months'
) |> kable()
```

For females, a sizable minority of unintentional female nonusers have used a method of contraception at least once in the past 12 months.


## Has Ever Used Contraception

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(EVERUSED == 'Yes'),
    subset(
      fem_2017_2019_svy,
      curr_use == 'Otherwise did not use contraception at last intercourse'
    ),
    svyciprop
  ),
  type = 'proportion',
  domain = 'females who otherwise did not use contraception at last intercourse',
  title = 'who have had sexual intercourse only that one time'
) |> kable()
```

A supermajority of female nonusers have used a method of contraception at least once in their lifetimes

I can't find an equivalent to `EVERUSED` for males.


## Used Contraception at First Intercourse with Most Recent Partner

```{r, dependson=c('male-process-data')}
collect_estimate(
  svyci(
    ~I(PXFUSE == 'Yes'),
    subset(
      male_2017_2019_svy,
      curr_use == 'Otherwise did not use contraception at last intercourse'
    ),
    svyciprop
  ),
  type = 'proportion',
  domain = 'males who otherwise did not use contraception at last intercourse',
  title = 'who used at least one method of contraception in the past 12 months with most recent partner'
) |> kable()
```


## Last Intercourse Was First Intercourse with Partner

```{r, dependson=c('male-process-data')}
collect_estimate(
  svyci(
    ~I(PXMTONCE == 'Yes'),
    subset(
      male_2017_2019_svy,
      curr_use == 'Otherwise did not use contraception at last intercourse'
    ),
    svyciprop
  ),
  type = 'proportion',
  domain = 'males who otherwise did not use contraception at last intercourse',
  title = 'whose last intercourse was first intercourse with partner'
) |> kable()
```


## Has Not Had Sexual Intercourse More Than Once

```{r, dependson=c('male-process-data')}
collect_estimate(
  svyci(
    ~I(SEXONCE == 'YES (R HAS HAD SEX ONLY ONCE)'),
    subset(
      male_2017_2019_svy,
      curr_use == 'Otherwise did not use contraception at last intercourse'
    ),
    svytotal
  ),
  type = 'total',
  domain = 'males who otherwise did not use contraception at last intercourse',
  title = 'who have had sexual intercourse only that one time'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(SEXONCE == 'YES (R HAS HAD SEX ONLY ONCE)'),
    subset(
      fem_2017_2019_svy,
      curr_use == 'Otherwise did not use contraception at last intercourse'
    ),
    svyciprop
  ),
  type = 'proportion',
  domain = 'females who otherwise did not use contraception at last intercourse',
  title = 'who have had sexual intercourse only that one time'
) |> kable()
```


# Any Contraceptive Use in Past 12 Months

## Had Intercourse with Opposite Sex in Past 12 Months

```{r, dependson=c('male-process-data')}
collect_estimate(
  svyci(
    ~I(SEX12MO != 'YES, HAD INTERCOURSE'),
    male_2017_2019_svy,
    svytotal
  )[level == TRUE],
  type = 'total',
  domain = 'males aged 15-49 living in households in the United States',
  title = 'who have not had intercourse with a female in the past 12 months'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(PARTS1YR == 'NONE'),
    fem_2017_2019_svy,
    svytotal
  ),
  type = 'total',
  domain = 'females aged 15-49 living in households in the United States',
  title = 'who have not had intercourse with a male in the past 12 months'
) |> kable()
```


## Did Not Use Contraception in Past 12 Months

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(ANYBC12 != 'Yes, at least one month of method use'),
    subset(
      fem_2017_2019_svy,
      PARTS1YR != 'NONE' & PARTS1YR != 'Not Applicable'
    ),
    svytotal
  )[level == TRUE],
  type = 'total',
  domain = 'females who have had intercourse with a male in the past 12 months',
  title = 'who have not used contraception in the past 12 months'
) |> kable()
```

The universe of the `PXANYUSE` series and `CWPRECBC` does not appear to be all males who have had intercourse in past 12 months. I see. The `PXANYUSE` series is only asked of a respondent if he did not report using contraception at either last or first sex with the partner in question. Similarly, `CWPRECBC` is only asked of a respondent if he reports not using contraception at either last or first sex with current wife or cohabitating partner or of both those were longer ago than past 12 months.

Thus, it's better to estimate any contraception used in past 12 months first, then estimate the remaining nonusers. This is relatively straightforward for females, but for males care must be taken to check, for each possible partner, use at first intercourse and whether first intercourse was within past 12 months, use at last sex and whether last intercourse was within 12 months, and otherwise use within 12 months.



# Things to Investigate

* Summarize contraceptive use in previous 12 months by those not sexually active with opposite sex, by those sexually active and did not use contraception at all, and by contraceptive method among those who used at least one method of contraception
* Among those sexually active with the opposite sex in the previous 12 months and who used at least one method of contraception, how frequently was any method of contraception used?
* Among those who used condoms in previous 12 months, how frequently were condoms used, in the past 12 months and past 4 weeks?
* Among females who used the pill in the previous 12 months, how many pills were missed?
* Can the difference in female and male contraceptive use rates be due to males not being aware of contraception?
* Among those at risk for unintended pregnancy, why not using contraception (Fem: EH-2, Male: None)
* Why respondents believe themselves to be sterile (Fem: DE-2 REASIMPP & EH-2 WHYNOTPG, Male: None)
* Ever tried over lifetime and why quit (Fem: EA, DC; Male: BB)
    * Include tubal ligation and vasectomy reversal
* Replicate analysis in SAS
    * Attempt single-factor categorical data analysis, e.g., whether totals of otherwise not using contraception and currently trying to conceive are different
* Experiment using chi-squared tests whether it is worth combining with 2015-2017 data for more precise estimates


## Variables for Recent Contraceptive Use

* Each month for 3 previous years
    * Females
        * EC MONSX whether intercourse occurred in given month
        * ED METHX each method used in each month
        * ED SIMSEQX whether methods used together or at different times
* Past 12 months
    * Females
        * EL for frequency of condom or any contraceptive use and missed pills (also past 4 weeks)
    * Males
        * BC overall frequency of sexual intercourse and condom use (also past 4 weeks)
        * CF methods used with current wife or cohabitating partner and "most often" used method
        * DG methods used with most recent 3 partners, "main" method, and frequency of condom and any method use