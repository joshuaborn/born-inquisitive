---
title: "Contraceptive Usage"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(here)
library(knitr)
library(survey)

i_am('EDA/004_contraceptive_usage.Rmd')

source(here('R/survey_helpers.R'))
source(here('R/import.R'))

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r helper-functions}
tablena <- function(x) {
  table(x, useNA = 'always')
}

in_millions <- function(dt, round_to = 3, do_round = TRUE) {
  dt <- as.data.table(dt)
  cols <- c('estimate', 'se', '2.5 %', '97.5 %')
  sub_dt <- dt[, cols, with = FALSE] / 10^6
  if (do_round) {
    sub_dt <- round(sub_dt, round_to)
  }
  dt[, (cols) := sub_dt]
  dt
}

rounded <- function(dt, round_to = 3) {
  cols <- c('estimate', 'se', '2.5 %', '97.5 %')
  sub_dt <- round(dt[, cols, with = FALSE], round_to)
  dt[, (cols) := sub_dt]
  dt
}

has_level <- function(x, ids) {
  is.element(as.integer(x), ids)
}

standard_millions_plot <- function(data) {
  ggplot(
    data = data,
    mapping = aes(
      y = reorder(level, estimate)
    )
  ) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2
  ) +
  geom_segment(
    aes(
      yend = reorder(level, estimate),
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.075, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    labels = scales::label_number(suffix = 'M', accuracy = 1),
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
}

standard_proportions_plot <- function(data) {
  ggplot(
  data = data,
  mapping = aes(
    y = reorder(level, estimate)
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2
  ) +
  geom_segment(
    aes(
      yend = reorder(level, estimate),
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.075, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    legend.position = 'none'
  )
}

env <- new.env()

env$estimates <- data.table()

collect_estimate <- function(est, title, domain = '', type = '', round_to = 3, plot = FALSE) {
  this_title <- title
  this_domain <- domain
  this_type <- type

  if (type == 'total') {
    dt <- in_millions(est, round_to)
  } else if (type == 'proportion') {
    dt <- rounded(est, round_to)
  } else {
    dt <- as.data.table(est)
  }
  env$estimates <- rbindlist(list(
    env$estimates[
      !(
        title == this_title &
          domain == this_domain &
          type == this_type
      )
    ],
    dt[, .(
      domain = this_domain,
      title = this_title,
      type = this_type,
      level,
      estimate,
      se,
      `2.5 %`,
      `97.5 %`
    )]
  ))

  env$estimates[
    title == this_title &
      domain == this_domain &
      type == this_type
  ]
}
```


# Current Usage


## Female Persons Aged 15-49

```{r fem-load-data}
fem_2017_2019 <- load_NSFG_data('2017_2019', 'FemResp')
fem_2017_2019_formats <- fem_2017_2019$Formats
```

```{r fem-process-data, dependson=c('helper-functions', 'fem-load-data')}
fem_2017_2019_data <- copy(fem_2017_2019$Data[, .(
  CASEID,
  DATFEMOP_Y,
  DATFEMOP_Y2,
  DATFEMOP_Y3,
  DATFEMOP_Y4,
  FECUND,
  FMEDREAS1,
  FMEDREAS10,
  FMEDREAS11,
  FMEDREAS19,
  FMEDREAS2,
  FMEDREAS20,
  FMEDREAS21,
  FMEDREAS3,
  FMEDREAS4,
  FMEDREAS7,
  FMEDREAS8,
  FMEDREAS9,
  HADSEX,
  HYST,
  METH3M1,
  METH3M2,
  METH3M3,
  MTHUSE3,
  OTHR,
  OVAREM,
  P1YRELP,
  POSIBLMN,
  POSIBLPG,
  PSURGSTR,
  RCURPREG,
  RHADALL,
  RHADALL2,
  RHADALL3,
  RHADALL4,
  RSURGSTR,
  SECU,
  SEST,
  SEX3MO,
  STRLOPER,
  TUBS,
  VASECT,
  WGT2017_2019,
  WYNOTUSE
)])

# remove sterility not from contraceptive procedure from METH3M series
fem_2017_2019_data[
  METH3M3 %in% 20:21,
  `:=`(
    METH3M3 = NA
  )
]
fem_2017_2019_data[
  METH3M2 %in% 20:21,
  `:=`(
    METH3M2 = METH3M3,
    METH3M3 = NA
  )
]
fem_2017_2019_data[
  METH3M1 %in% 20:21,
  `:=`(
    METH3M1 = METH3M2,
    METH3M2 = METH3M3,
    METH3M3 = NA
  )
]

# make existing variables factors
fem_2017_2019_data[, `:=`(
  FECUND = factorize(FECUND, 'FECUND', fem_2017_2019_formats),
  FMEDREAS1 = factorize(FMEDREAS1, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS2 = factorize(FMEDREAS2, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS3 = factorize(FMEDREAS3, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS4 = factorize(FMEDREAS4, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS7 = factorize(FMEDREAS7, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS8 = factorize(FMEDREAS8, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS9 = factorize(FMEDREAS9, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS10 = factorize(FMEDREAS10, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS11 = factorize(FMEDREAS11, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS19 = factorize(FMEDREAS19, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS20 = factorize(FMEDREAS20, 'FMEDREASF', fem_2017_2019_formats),
  FMEDREAS21 = factorize(FMEDREAS21, 'FMEDREASF', fem_2017_2019_formats),
  HADSEX = factorize(HADSEX, 'HADSEX', fem_2017_2019_formats),
  HYST = factorize(HYST, 'Y1N5C', fem_2017_2019_formats) ,
  METH3M1 = factorize(METH3M1, 'METH3MF', fem_2017_2019_formats),
  METH3M2 = factorize(METH3M2, 'METH3MF', fem_2017_2019_formats),
  METH3M3 = factorize(METH3M3, 'METH3MF', fem_2017_2019_formats),
  MTHUSE3 = factorize(MTHUSE3, 'MTHUSE3F', fem_2017_2019_formats),
  OTHR = factorize(OTHR, 'Y1N5C', fem_2017_2019_formats),
  OVAREM = factorize(OVAREM, 'Y1N5C', fem_2017_2019_formats),
  P1YRELP = factorize(P1YRELP, 'P1YRELP', fem_2017_2019_formats),
  POSIBLPG = factorize(POSIBLPG, 'Y1N5RDF', fem_2017_2019_formats),
  POSIBLMN = factorize(POSIBLMN, 'Y1N5RDF', fem_2017_2019_formats),
  PSURGSTR = factorize(PSURGSTR, 'Y1N5C', fem_2017_2019_formats),
  RCURPREG = factorize(RCURPREG, 'RCURPREG', fem_2017_2019_formats),
  RHADALL = factorize(RHADALL, 'Y1N5C', fem_2017_2019_formats),
  RHADALL2 = factorize(RHADALL2, 'Y1N5C', fem_2017_2019_formats),
  RHADALL3 = factorize(RHADALL3, 'Y1N5C', fem_2017_2019_formats),
  RHADALL4 = factorize(RHADALL4, 'Y1N5C', fem_2017_2019_formats),
  RSURGSTR = factorize(RSURGSTR, 'Y1N5C', fem_2017_2019_formats),
  VASECT = factorize(VASECT, 'Y1N5C', fem_2017_2019_formats),
  SEX3MO = factorize(SEX3MO, 'Y1N2RECF', fem_2017_2019_formats),
  STRLOPER = factorize(STRLOPER, 'STRLOPER', fem_2017_2019_formats),
  TUBS = factorize(TUBS, 'Y1N5C', fem_2017_2019_formats),
  WYNOTUSE = factorize(WYNOTUSE, 'Y1N5RDF', fem_2017_2019_formats)
)]

# create boolean variables for whether each specific method is currently used
for (x in c(1:19, 22:24)) {
  set(
    fem_2017_2019_data,
    j = sprintf('using3m_meth%d', x),
    value = has_level(fem_2017_2019_data$METH3M1, x) |
      has_level(fem_2017_2019_data$METH3M2, x) |
      has_level(fem_2017_2019_data$METH3M3, x)
  )
}

# count any respondents who are sexually active and whose last intercourse was with husband or cohabitating partner who has an active vasectomy as using vasectomy as a contraceptive method
fem_2017_2019_data[, using3m_meth3 := fifelse(
  SEX3MO == 'YES' & PSURGSTR == 'YES' & (
    P1YRELP == 'Current husband or (current husband from whom she is separated)' |
    P1YRELP == 'Current cohabiting partner'
  ),
  TRUE,
  using3m_meth3
)]

# count any respondents with current tubal ligations who are sexually active as currently using tubal ligation as a contraceptive method
fem_2017_2019_data[, using3m_meth4 := fifelse(
  SEX3MO == 'YES' & TUBS == 'YES',
  TRUE,
  using3m_meth4
)]

# create variable counting number of current methods
fem_2017_2019_data[
  ,
  meth3m_count := rowSums(.SD),
  .SDcols = patterns('^using3m_meth')
]

# create survey design object
fem_2017_2019_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = fem_2017_2019_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```


```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(meth3m_count > 0),
    fem_2017_2019_svy,
    svytotal
  ),
  title = 'currently using contraception',
  type = 'total',
  domain = 'females aged 15-49 living in households in the United States'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(meth3m_count > 0),
    fem_2017_2019_svy,
    svymean
  ),
  title = 'currently using contraception',
  type = 'proportion',
  domain = 'females aged 15-49 living in households in the United States'
) |> kable()
```


### Currently Using Contraception

```{r, dependson=c('fem-process-data')}
kable(fem_2017_2019_formats[format_name == 'METH3MF'])
```


#### Number of Methods Used

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~factor(meth3m_count),
    subset(fem_2017_2019_svy, meth3m_count > 0),
    svytotal
  ),
  title = 'by number of contraceptive methods used',
  domain = 'females currently using contraception',
  type = 'total'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~factor(meth3m_count),
    subset(fem_2017_2019_svy, meth3m_count > 0),
    svymean
  ),
  title = 'by number of contraceptive methods used',
  domain = 'females currently using contraception',
  type = 'proportion'
) |> kable()
```


#### By Method Used, With Those Currently Using Multiple Methods Counted Multiple Times

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(lapply(
    c(1:19, 22:24),
    function(x) {
      svyci(
        as.formula(sprintf('~using3m_meth%d', x)),
        fem_2017_2019_svy,
        svytotal
      )[
        level == TRUE
      ][
        , .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'by current contraceptive method',
  domain = 'females currently using contraception',
  type = 'total'
) |> standard_millions_plot() +
  labs(
    subtitle = 'with those using multiple methods counted multiple times',
    title = 'Total persons by current contraceptive method',
    x = 'Number of persons'
  )
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(lapply(
    c(1:19, 22:24),
    function(x) {
      svyci(
        as.formula(sprintf('~using3m_meth%d', x)),
        subset(fem_2017_2019_svy, meth3m_count > 0),
        svyciprop
      )[
        , .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'by current contraceptive method',
  domain = 'females currently using contraception',
  type = 'proportion'
) |> standard_proportions_plot() +
  labs(
    subtitle = 'with those using multiple methods counted multiple times',
    title = 'Proportion of persons by current contraceptive method'
  )
```


#### By Method Used, Among Those Currently Using One Method Exclusively

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~factor(METH3M1),
    subset(fem_2017_2019_svy, meth3m_count == 1),
    svytotal
  ),
  title = 'by current contraceptive method',
  domain = 'females currently using one method exclusively',
  type = 'total',
  plot = TRUE
) |> standard_millions_plot() +
  labs(
    subtitle = 'among females currently using one method exclusively',
    title = 'Total persons by current contraceptive method',
    x = 'Number of persons'
  )
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~factor(METH3M1),
    subset(fem_2017_2019_svy, meth3m_count == 1),
    svymean
  ),
  title = 'by current contraceptive method',
  domain = 'females currently using one method exclusively',
  type = 'proportion'
) |> standard_proportions_plot() +
  labs(
    subtitle = 'among females currently using one method exclusively',
    title = 'Proportion of persons by current contraceptive method'
  )
```


#### By Method Used, Among Those Currently Using Multiple Methods

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(lapply(
    c(1:19, 22:24),
    function(x) {
      svyci(
        ~I(meth3m_count > 1),
        subset(
          fem_2017_2019_svy,
          fem_2017_2019_data[, get(sprintf('using3m_meth%d', x))]
        ),
        svytotal
      )[
        level == TRUE,
        .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'persons using multiple methods, by method',
  domain = 'females currently using contraception',
  type = 'total',
  plot = TRUE
) |> standard_millions_plot() +
  labs(
    subtitle = 'among females currently using contraception',
    title = 'Total persons currently using multiple contraceptive methods, by method',
    x = 'Number of persons'
  )
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(lapply(
    c(1:9, 13, 17:19, 23:24),
    function(x) {
      svyci(
        ~I(meth3m_count > 1),
        subset(
          fem_2017_2019_svy,
          fem_2017_2019_data[, get(sprintf('using3m_meth%d', x))]
        ),
        svyciprop
      )[
        , .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'persons using multiple methods, by method',
  domain = 'females currently using contraception',
  type = 'proportion',
  plot = TRUE
) |> standard_proportions_plot() +
  labs(
    subtitle = 'among females currently using contraception',
    title = 'Proportion of persons currently using multiple contraceptive methods, by method'
  )
```


#### By Other Method Used, Among Those Currently Using Calendar Methods

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(1:7, 9:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth8),
          svytotal
        )[
          level == TRUE,
          .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      estimate > 0
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    as.data.table(
      svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth8),
        svytotal
      )[
        level == TRUE
      ][
        , .(
          level = 'Exclusively calendar rhythm, Standard Days, or Cycle Beads method',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'total',
  domain = 'females currently using calendar methods'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(1:7, 9:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth8),
          svyciprop
        )[
          ,
          .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      `2.5 %` > 0.0001
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    as.data.table(
      svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth8),
        svyciprop
      )[
        , .(
          level = 'Exclusively calendar rhythm, Standard Days, or Cycle Beads method',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'proportion',
  domain = 'females currently using calendar methods'
) |> kable()
```


#### By Other Method Used, Among Those Currently Condoms

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(1, 3:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth2),
          svytotal
        )[
          level == TRUE,
          .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      estimate > 0
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    as.data.table(
      svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth2),
        svytotal
      )[
        level == TRUE
      ][
        , .(
          level = 'Exclusively condom',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'total',
  domain = 'females currently using condoms'
) |> standard_millions_plot()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(1, 3:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth2),
          svyciprop
        )[
          ,
          .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      `2.5 %` > 0.0001
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    as.data.table(
      svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth2),
        svyciprop
      )[
        , .(
          level = 'Exclusively condoms',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'proportion',
  domain = 'females currently using condoms'
) |> standard_proportions_plot()
```


#### By Other Method Used, Among Those Currently Using Withdrawal

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(1:4, 6:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth5),
          svytotal
        )[
          level == TRUE,
          .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      estimate > 0
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    as.data.table(
      svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth5),
        svytotal
      )[
        level == TRUE
      ][
        , .(
          level = 'Exclusively withdrawal',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'total',
  domain = 'females currently using withdrawal'
) |> standard_millions_plot()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(1:4, 6:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth5),
          svyciprop
        )[
          , .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      `2.5 %` > 0.0001
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    as.data.table(
      svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth5),
        svyciprop
      )[
        , .(
          level = 'Exclusively withdrawal',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'proportion',
  domain = 'females currently using withdrawal'
) |> standard_proportions_plot()
```


#### By Other Method Used, Among Those Currently Using Pill

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(2:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth1),
          svytotal
        )[
          level == TRUE,
          .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      estimate > 0
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    as.data.table(
      svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth1),
        svytotal
      )[
        level == TRUE
      ][
        , .(
          level = 'Exclusively pill',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'total',
  domain = 'females currently using withdrawal'
) |> standard_millions_plot()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(2:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth1),
          svyciprop
        )[
          , .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      `2.5 %` > 0.0001
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    as.data.table(
      svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth1),
        svyciprop
      )[
        , .(
          level = 'Exclusively pill',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'proportion',
  domain = 'females currently using withdrawal'
) |> standard_proportions_plot()
```


### Not Currently Using Contraception


#### Not Currently Sexually Active

```{r, dependson=c('fem-process-data')}
kable(tablena(fem_2017_2019_data$MTHUSE3))

kable(tablena(fem_2017_2019_data$SEX3MO))

kable(tablena(fem_2017_2019_data$HADSEX))

fem_2017_2019_data[MTHUSE3 == 'Not Applicable', .N] ==
  fem_2017_2019_data[SEX3MO == 'NO', .N] +
  fem_2017_2019_data[HADSEX == 'NO, R NEVER HAD INTERCOURSE', .N]
```

The respondents with `NA` for MTHUSE3 are respondents with "NO" for `SEX3MO` plus the respondents with "NO, R NEVER HAD INTERCOURSE" for `HADSEX`. Both these variables must be checked to estimate females who are not currently sexually active with a male.

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(SEX3MO == 'NO' | HADSEX == 'NO, R NEVER HAD INTERCOURSE'),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svytotal
  )[level == TRUE],
  title = 'did not have intercourse with male in previous 3 months',
  type = 'total',
  domain = 'females not currently using contraception' 
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(SEX3MO == 'NO' | HADSEX == 'NO, R NEVER HAD INTERCOURSE'),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svymean
  )[level == TRUE],
  title = 'did not have intercourse with male in previous 3 months',
  type = 'proportion',
  domain = 'females not currently using contraception' 
) |> kable()
```

Females not currently sexually active with a male accounts for the majority not using contraception. This can be further decomposed by never had sex with male versus just not currently.


#### Pregnant

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[, tablena(RCURPREG)] |> kable()
```

The pregnancy recode variable is straightforward.

Going forward, estimates of those not currently using contraception will be cumulatively exclusive of previous estimates. For instance, those who are both pregnant and not currently sexually active will be counted once as not currently sexually active. Only those preganant and currently sexually active will be included in the next estimate.

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(RCURPREG == 'YES (CURRENTLY PREGNANT)' & SEX3MO == 'YES'),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svytotal
  )[level == TRUE],
  title = 'currently pregnant and had sexual intercourse with male in previous 3 months',
  type = 'total',
  domain = 'females not currently using contraception' 
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(RCURPREG == 'YES (CURRENTLY PREGNANT)' & SEX3MO == 'YES'),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svymean
  )[level == TRUE],
  title = 'currently pregnant and had sexual intercourse with male in previous 3 months',
  type = 'proportion',
  domain = 'females not currently using contraception' 
) |> kable()
```


#### Reason for Not Using Contraception

Section EH are questions asked of respondent to determine reason for not using contraception. The universe is 

> Applicable if R is not currently pregnant (currpreg = 5) and R had sex in month of interview (EC-8 MONSX through MONSX48 corresponding to cmintvw = 1) and R is not sterilized nor sterile [(rstrstat ne 1 or 2) and (ED-6 METHX1 through METHX192 corresponding to cmintvw ne 6)] and R did not use a method in month of interview (currmeth1 = 1)

This might not line up nicely with the `MTHUSE3` and `SEX3MO` variables, since Section EH is asked for those who had sex with a male in the current month and `MTHUSE3` and `SEX3MO` refer to past 3 months. Once analysis gets to Section EH, different variables will have to be used in order to make the denominator consistent.


#### Infertile Due to Reasons Others Than Contraception

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  as.integer(MTHUSE3) %in% 2:3 & SEX3MO == 'YES' & as.integer(FECUND) == 1,
  .(
    CASEID,
    DATFEMOP_Y,
    DATFEMOP_Y2,
    DATFEMOP_Y3,
    FECUND,
    MTHUSE3,
    PSURGSTR,
    RSURGSTR,
    STRLOPER,
    meth3m_count
  )
] |> kable()
```


This appears inconsistent. It shouldn't be possible to have `FECUND` of "SURGICALLY STERILE, CONTRACEPTIVE" and to not have used a contraceptive at last intercourse, unless, perhaps, the surgery happened in between the last intercourse and the interview, which seems unlikely.

The `DATFEMOP_Y` series was checked to see if these respondents' apparent contradiction is due to sterilizing operations occurring in the interval between last intercourse and the NSFG interview. Since many sterilizing operations occurred years earlier than the interview, this is not the case.

It appears that the issue with these problem cases is due to how `FECUND` encodes contraceptive intent. Firstly, respondents are only asked about motives for sterilizing operations if the operation occurred in the five years preceding the interview. Any tubal ligations and vasectomies for which there is no motive information, either because the respondents did not answer the motive questions or because the operation occurred more than five years previous, are assumed to have contraceptive intent.

Furthermore, among those sterilizing operations for which there is motive information, the "burden of proof" in the `FECUND` recode is on non-contraceptive intent. For instance, if the respondent indicates at the time of the operation, respondent had all the children respondent wanted (`RHADALL`), then `FECUND` is encoded as contraceptive intent.

Basically, the NSFG recodes are premised on the proposition that tubal ligations and vasectomies are usually done for contraceptive reasons, and aggressively categorizes them as such. However, respondents sometimes do not report their sterilizing operations as a contraceptive method used at least intercourse.

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[, tablena(FECUND)] |> kable()
```

Because of the aggressive recoding, there are relatively few respondents classified as "SURGICALLY STERILE, NONCONTRACEPTIVE."

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  as.integer(MTHUSE3) %in% 2:3 & SEX3MO == 'YES' & as.integer(FECUND) == 1,
  tablena(STRLOPER)
] |> kable()
```

Tubal ligation is by far the most common reason for having a `FECUND` code of 1 among the problem cases.

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  as.integer(MTHUSE3) %in% 2:3 & SEX3MO == 'YES' & as.integer(FECUND) == 1 & STRLOPER == 'TUBAL LIGATION OR STERILIZATION',
  .(
    CASEID,
    DATFEMOP_Y,
    FMEDREAS1,
    FMEDREAS2,
    FMEDREAS3,
    FMEDREAS4,
    RHADALL,
    STRLOPER,
    meth3m_count
  )
] |> kable()
```

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  as.integer(MTHUSE3) %in% 2:3 & SEX3MO == 'YES' & as.integer(FECUND) == 1 & STRLOPER == 'TUBAL LIGATION OR STERILIZATION',
  tablena(FMEDREAS1)
] |> kable()
```

Most of the tubal ligations occurred earlier than 5 years before the interview or did not have motive questions answered. Among known motives, only 1 cites medical problems.

I think I'll join with the NSFG recoding team and just count any tubal ligation still in effect as a current contraceptive method, and set the `using3m_meth4` variable to `TRUE` for these respondents.

However, this is unsound for female respondent's who are married or cohabitating and whose partners have vasectomies, because there is the possibility of sexual intercourse with someone not the reported partner. For exploration of this, see "Married or Cohabitating with Surgically Sterile Partner."

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  as.integer(MTHUSE3) %in% 2:3 & SEX3MO == 'YES' & STRLOPER == 'HYSTERECTOMY',
  .(
    CASEID,
    DATFEMOP_Y2,
    FMEDREAS7,
    FMEDREAS8,
    FMEDREAS9,
    FMEDREAS10,
    FMEDREAS11,
    RHADALL,
    STRLOPER,
    meth3m_count
  )
] |> kable()
```

The 3 hysterectomies among the problem cases were all for medical problems.

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  STRLOPER == 'HYSTERECTOMY',
  tablena(FMEDREAS7)
] |> kable()
```

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  STRLOPER == 'HYSTERECTOMY',
  tablena(FMEDREAS8)
] |> kable()
```

Hysterectomies generally appear to be done mostly for medical reasons.

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  as.integer(MTHUSE3) %in% 2:3 & SEX3MO == 'YES' & STRLOPER == 'OTHER OPERATION OR TYPE UNKNOWN',
  .(
    CASEID,
    DATFEMOP_Y4,
    FMEDREAS19,
    FMEDREAS20,
    FMEDREAS21,
    RHADALL,
    STRLOPER,
    meth3m_count
  )
] |> kable()
```

The 2 other operations among the problem cases are split was to whether they were done for medical reasons.

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  STRLOPER == 'OTHER OPERATION OR TYPE UNKNOWN',
  tablena(FMEDREAS19),
] |> kable()
```

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  STRLOPER == 'OTHER OPERATION OR TYPE UNKNOWN',
  tablena(FMEDREAS20),
] |> kable()
```

More generally, for what motives are known, other operations appear to be mostly for medical reasons.

I think the strategy going forward should be to recode any female respondents who have tubal ligations that have not been reversed as currently using tubal ligation as a method of contraception, but to leave all other sterilizing operations as is.


##### Infertile Due to Noncontraceptive Surgery

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(
      (HYST == 'YES' | OVAREM == 'YES' | 'OTHR' == 'YES') &
        RCURPREG == 'NO (NOT CURRENTLY PREGNANT)' &
        SEX3MO == 'YES'
    ),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svytotal
  )[level == TRUE],
  title = 'infertile due to noncontraceptive surgery, not currently pregnant, and had sexual intercourse with male in previous 3 months',
  type = 'total',
  domain = 'females not currently using contraception'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(
      (HYST == 'YES' | OVAREM == 'YES' | 'OTHR' == 'YES') &
        RCURPREG == 'NO (NOT CURRENTLY PREGNANT)' &
        SEX3MO == 'YES'
    ),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svyciprop
  ),
  title = 'infertile due to noncontraceptive surgery, not currently pregnant, and had sexual intercourse with male in previous 3 months',
  type = 'proportion',
  domain = 'females not currently using contraception'
) |> kable()
```

This is an awfully low estimate.

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  (HYST == 'YES' | OVAREM == 'YES' | 'OTHR' == 'YES') &
    SEX3MO == 'YES',
  tablena(meth3m_count)
] |> kable()
```

It seems that most females who have had sterilizing procedures and are sexually active are still using contraception. That's surprising.

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(meth3m_count > 0),
    subset(
      fem_2017_2019_svy,
      SEX3MO == 'YES' &
        (HYST == 'YES' | OVAREM == 'YES' | 'OTHR' == 'YES')
    ),
    svytotal
  ),
  title = 'currently using contraception',
  type = 'total',
  domain = 'sexually active females who have had noncontraceptive sterilizing procedures'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(meth3m_count > 0),
    subset(
      fem_2017_2019_svy,
      SEX3MO == 'YES' &
        (HYST == 'YES' | OVAREM == 'YES' | 'OTHR' == 'YES')
    ),
    svyciprop
  ),
  title = 'currently using contraception',
  type = 'proportion',
  domain = 'sexually active females who have had noncontraceptive sterilizing procedures'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(lapply(
    c(1:19, 22:24),
    function(x) {
      svyci(
        as.formula(sprintf('~using3m_meth%d', x)),
        subset(
          fem_2017_2019_svy,
          SEX3MO == 'YES' & (HYST == 'YES' | OVAREM == 'YES' | 'OTHR' == 'YES')
        ),
        svyciprop
      )[
        , .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    estimate > 0.001
  ][
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'by current contraceptive method',
  domain = 'sexually active females who have had noncontraceptive sterilizing procedures',
  type = 'proportion'
) |> kable()
```

I see. It seems as though tubal ligation has become a standard practice whenever a hysterectomy, etc, is done. I'm guessing this is to try to avoid ectopic pregnancies.


##### Otherwise Physically Infertile

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  SEX3MO == 'YES' & POSIBLPG == 'No',
  tablena(meth3m_count)
] |> kable()
```

There are some respondents in this category. The universe for the `POSIBLPGN` variable are respondents neither surgically sterile nor pregnant, so this is simple to estimate.

```{r, dependson=c('fem-process-data')}
collect_estimate(
   svyci(
    ~I(
      SEX3MO == 'YES' & POSIBLPG == 'No'
    ),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svytotal
  )[level == TRUE],
  title = 'sexually active, but otherwise physically infertile',
  type = 'total',
  domain = 'females not currently using contraception'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(
      SEX3MO == 'YES' & POSIBLPG == 'No'
    ),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svyciprop
  ),
  title = 'sexually active, but otherwise physically infertile',
  type = 'proportion',
  domain = 'females not currently using contraception'
) |> kable()
```


##### Married or Cohabitating with Physically Infertile Partner

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[, tablena(P1YRELP) ] |> kable()
```

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[
  SEX3MO == 'YES' &
    POSIBLPG == 'Yes' &
    POSIBLMN == 'No' &
    meth3m_count == 0
  ,
  tablena(
    P1YRELP == 'Current husband or (current husband from whom she is separated)' |
      P1YRELP == 'Current cohabiting partner'
  )
] |> kable()
```

Care must be taken when it is reported that respondent's husband or cohabitating partner is physically infertile that last intercourse was with husband or cohabitating partner.

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(
      SEX3MO == 'YES' & POSIBLPG == 'Yes' & POSIBLMN == 'No' & (
        P1YRELP == 'Current husband or (current husband from whom she is separated)' |
          P1YRELP == 'Current cohabiting partner'
      )
    ),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svytotal
  )[level == TRUE],
  title = 'sexually active, not infertile, and married or cohabitating with otherwise physically infertile partner',
  type = 'total',
  domain = 'females not currently using contraception'
) |> kable()
```

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(
      SEX3MO == 'YES' & POSIBLPG == 'Yes' & POSIBLMN == 'No' & (
        P1YRELP == 'Current husband or (current husband from whom she is separated)' |
          P1YRELP == 'Current cohabiting partner'
      )
    ),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svyciprop
  ),
  title = 'sexually active, not infertile, and married or cohabitating with otherwise physically infertile partner',
  type = 'proportion',
  domain = 'females not currently using contraception'
) |> kable()
```

This case is very rare.


##### Married or Cohabitating with Surgically Sterile Partner

Reasons for male sterilizing operations are only asked if the operation occurred within 5 years of the interview and if the female respondent was in a relationship with the husband or cohabitating partner at the time of the operation.

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[PSURGSTR == 'YES', tablena(VASECT)] |> kable()
fem_2017_2019_data[VASECT == 'YES', tablena(PSURGSTR)] |> kable()
```

It appears that all sterilizing operations reported for husband or cohabitating partners are vasectomies. The only difference between `PSURGSTR` and `VASECT` is that `VASECT`'s universe is respondents currently married or cohabitating whereas `PSURGSTR`'s universe is all respondents.

Given this, vasectomies among husbands and cohabitating partners will be handled similarly to tubal ligations. If a female respondent's last sexual intercourse was with H/CP and H/CP is reported to have a vasectomy, then force `using3m_meth3` to be `TRUE`.

```{r}
fem_2017_2019_data[
  as.integer(MTHUSE3) %in% 2:3 &
    (
      P1YRELP == 'Current husband or (current husband from whom she is separated)' |
        P1YRELP == 'Current cohabiting partner'
    ) &
    PSURGSTR == 'YES',
  .(
    CASEID,
    MTHUSE3,
    SEX3MO,
    PSURGSTR,
    P1YRELP,
    meth3m_count
  )
] |> kable()
```

This changes two respondents' contraceptive statuses.


#### Trying to Become Pregnant

This is encoded in `WYNOTUSE` for the respondent, and in `HPPREGQ` with regard to respondent's partner. Unfortunately, both these variables are only asked if respondent had sexual intercourse in the month of the interview (comparing periods of non-intercourse as encoded in the `MONSX` series with the century-month of the interview as encoded in `CMINTVW`). There may be respondents who had sexual intercourse in the two months preceding the interview, but not in the month of the interview, and so `WYNOTUSE` might be incomplete for the remaining respondents.

```{r}
fem_2017_2019_data[
  SEX3MO == 'YES' &
    meth3m_count == 0 &
    RCURPREG == 'NO (NOT CURRENTLY PREGNANT)' &
    POSIBLPG == 'Yes' &
    !(
      POSIBLMN == 'No' & (
        P1YRELP == 'Current husband or (current husband from whom she is separated)' |
          P1YRELP == 'Current cohabiting partner'
      )
    ),
  tablena(WYNOTUSE)
]
```

Indeed, `WYNOTUSE` is `NA` for 102 respondents of interest in this analysis. This is perhaps why the `CONSTAT` series of recodes uses the current month, not past 3 months.

Because of this, it's best to redo the analysis, reframing "currently sexually active" has having had sexual intercourse in the month of the interview.


## To Do

* Finish estimating current non-users
* Calculate overall current contraceptive usage rate
* Check everything against `CONSTAT` series recodes


## Male Persons Aged 15-49

```{r male-load-data}
male_2017_2019 <- load_NSFG_data('2017_2019', 'Male')
```

```{r male-process-data, dependson=c('helper-functions', 'male-load-data')}
male_2017_2019_data <- copy(male_2017_2019$Data)

male_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = male_2017_2019_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```

According to the U.S. Census Bureau, ibid. The number of civilian noninstitutionalized male persons in the United States is ~74,238,000.


# Outline

## Frames for analysis

### By Table

* Female persons
* Male persons

### By Columns

* "Current" -- at last intercourse with male in past 3 months
* "Recent" -- over previous year
* "Ever" -- over lifetime

## Questions for Users

* Which contraceptives?
* How many?
* For reasons other than contraception?
* For "recent," how consistent?
* For "recent" and for multiple methods users, simultaneously or alternatively?
* For "ever" and who have stopped using a method, why did they stop?

## Questions for Nonusers

* Not sexually active with male?
    * Ever or just now?
    * Exclusively same-sex partner(s)?
* Currently pregnant?
* Noncontraceptive surgical sterilization
* Physically unable to have child
* Cohabitating partner or husband surgical sterilization
* Cohabitating partner or husband physically unable to have child
* Trying to get pregnant?
* For those fertile, heterosexually active, not using contraception, and not desiring pregnancy, why no contraception usage?

## Covariates/Subdomains

* Want children in future, but not just not now
* By sex education
* By income
* By religion
    * Roman Catholics are a subdomain of interest.
* Second phase vs. first-phase (to investigate nonresponse bias)

## Other

* Try combining with 2015-2017 data for more precise estimates?
