---
title: "NSFG Estimates Compared with Census Counts"
author: "Joshua Born"
output:
  html_document:
    code_folding: show
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(gt)
library(gtExtras)
library(haven)
library(here)
library(readr)
library(srvyr)
library(tidyr)

knitr::opts_chunk$set(
  cache = TRUE,
  echo = FALSE,
  fig.align = 'center'
)
```

```{r, load-data, message=FALSE}
guttmacher_raw <- read_csv(
  here('data/guttmacher/NationalAndStatePregnancy_PublicUse.csv')
)
vital_births <- read_csv(
  here('data/NCHS_-_Births_and_General_Fertility_Rates__United_States.csv'),
  name_repair = 'universal'
)
preg2017_2019 <- read_sas(
  here('data/d2017_2019fempreg.sas7bdat'),
  #catalog_file = here('data/d2017_2019fempreg.sas7bcat')
)
fem2017_2019 <- read_sas(
  here('data/d2017_2019femresp.sas7bdat'),
  catalog_file = here('data/d2017_2019femresp.sas7bcat')
)
preg2015_2017 <- read_sas(
  here('data/d2015_2017fempreg.sas7bdat'),
  #catalog_file = here('data/d2015_2017fempreg.sas7bcat')
)
preg2013_2015 <- read_sas(
  here('data/d2013_2015fempreg.sas7bdat'),
  #catalog_file = here('data/d2013_2015fempreg.sas7bcat')
)
preg2011_2013 <- read_sas(
  here('data/d2011_2013fempreg.sas7bdat'),
  #catalog_file = here('data/d2011_2013fempreg.sas7bcat')
)
wgt2011_2019 <- read_sas(
  here('data/d2011_2019femwgt.sas7bdat')
)
```


## Census Counts

```{r, calculate-census-counts-by-year, dependson="load-data"}
guttmacher_national <- guttmacher_raw |> 
  filter(state == 'US') |>
  select(-state, -notes) |>
  mutate(abortions_interpolated = year %in%
      c(1983, 1986, 1989, 1990, 1993, 1994, 1997, 1998, 2001, 2002, 2003, 2006,
        2009, 2012, 2015)
  )

census_counts <- full_join(
  guttmacher_national |> 
    rename(Year = year, Total.Abortions = abortionstotal) |> 
    filter(!abortions_interpolated) |> 
    select(Year, Total.Abortions),
  vital_births |> 
    rename(Total.Births = Birth.Number) |> 
    filter(Year >= 1973) |> 
    select(Year, Total.Births),
  by = join_by(Year)
) |> arrange(Year)
```

```{r plot-census-counts-by-year, dependson="calculate-census-counts-by-year", dpi=200, fig.width=9.6, fig.height=9.6, fig.retina=1.5}
ggplot(
  data = census_counts |>
    pivot_longer(
      starts_with('Total'),
      values_drop_na = TRUE,
      values_to = 'Count'
    ) |>
    arrange(Year),
  mapping = aes(
    y = Count,
    x = Year,
    color = name,
    shape = name
  )
) +
  geom_point() +
  scale_y_continuous(
    breaks = \(x) seq(x[1], x[2], 5e5),
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::unit_format(unit = "M", scale = 1e-6),
    limits = c(0, NA),
    minor_breaks = \(x) seq(x[1], x[2], 25e4)
  ) +
  scale_x_continuous(
    breaks = \(x) seq(x[1]+1, x[2], 4),
    expand = expansion(add = 1),
    minor_breaks = \(x) seq(x[1]+1, x[2], 2)
  ) + 
  theme_bw() +
  theme(
    legend.position = 'bottom',
    legend.title = element_blank(),
    axis.ticks.y = element_blank()
  )
```

```{r print-table-of-census-counts-by-year, dependson="calculate-census-counts-by-year"}
gt(census_counts) |>
  gt_theme_538() |> 
  sub_missing(
    missing_text = ''
  ) |> 
  fmt_number(
    starts_with('Total'),
    drop_trailing_zeros = TRUE
  )
```


## Estimates from 2017-2019 NSFG

```{r estimate-based-on-2017-2019-NSFG, dependson="load-data"}
preg2017_2019 |> 
  mutate(
    OUTCOME = labelled(OUTCOME, c(
      "LIVE BIRTH" = 1, # 7199
      "INDUCED ABORTION" = 2, # 941
      "STILLBIRTH" = 3, # 105
      "MISCARRIAGE" = 4,  #  1654
      "ECTOPIC PREGNANCY" = 5, #  123
      "CURRENT PREGNANCY" = 6 #  193
    )),
    Abortions = if_else(OUTCOME == 2, 1, 0),
    Births = if_else(OUTCOME == 1, 1, 0)
  ) |> 
  as_survey_design(
    strata = SEST,
    ids = SECU,
    weights = WGT2017_2019,
    nest = TRUE
  ) |> 
  group_by(DATEND) |> 
  summarize(
    Abortions = survey_total(Abortions, vartype = 'ci'),
    Births = survey_total(Births, vartype = 'ci')
  ) |> 
  mutate(
    Abortions.CI.Width = Abortions_upp - Abortions_low,
    Percent.CI.Abortions = Abortions.CI.Width / Abortions,
    Births.CI.Width = Births_upp - Births_low,
    Percent.CI.Births = Births.CI.Width / Births
  ) |>
  rename(Year = DATEND) |> 
  select(Year, starts_with('Abortions'), starts_with('Births'), everything()) |>
  filter(Year >= 2000 & Year <= 2016) |> 
  gt() |>
  gt_theme_538() |>
  fmt_number(
    starts_with(c('Abortions', 'Births')),
    decimal = 0
  )
```


## Estimates from Stacked 2015-2019 NSFG

```{r estimate-based-on-2015-2019-NSFG, dependson="load-data"}
bind_rows(
  preg2015_2017 |> 
    select(-QUARTER, -PHASE, -INTVWYEAR),
  preg2017_2019 |> 
    select(-QUARTER, -PHASE, -INTVWYEAR)
) |> left_join(
  wgt2011_2019,
  by = join_by(CASEID)
) |> 
  mutate(
    OUTCOME = labelled(OUTCOME, c(
      "LIVE BIRTH" = 1,
      "INDUCED ABORTION" = 2,
      "STILLBIRTH" = 3,
      "MISCARRIAGE" = 4,
      "ECTOPIC PREGNANCY" = 5,
      "CURRENT PREGNANCY" = 6
    )),
    Abortions = if_else(OUTCOME == 2, 1, 0),
    Births = if_else(OUTCOME == 1, 1, 0)
  ) |> 
  as_survey_design(
    strata = SEST,
    ids = SECU,
    weights = WGT2015_2019,
    nest = TRUE
  ) |> 
  group_by(DATEND) |> 
  summarize(
    Abortions = survey_total(Abortions, vartype = 'ci'),
    Births = survey_total(Births, vartype = 'ci')
  ) |> 
  mutate(
    Abortions.CI.Width = Abortions_upp - Abortions_low,
    Percent.CI.Abortions = Abortions.CI.Width / Abortions,
    Births.CI.Width = Births_upp - Births_low,
    Percent.CI.Births = Births.CI.Width / Births
  ) |>
  rename(Year = DATEND) |> 
  select(Year, starts_with('Abortions'), starts_with('Births'), everything()) |> 
  filter(Year >= 2000 & Year <= 2014) |> 
  gt() |> 
  gt_theme_538() |> 
  fmt_number(
    starts_with(c('Abortions', 'Births')),
    decimal = 0
  )
```