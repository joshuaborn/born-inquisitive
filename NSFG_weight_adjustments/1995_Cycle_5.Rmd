---
title: "Cycle 5 (1995) NSFG Weight Adjustment"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
    css: wide.css
---

```{r setup, include=FALSE}
library(PracTools)
library(dplyr)
library(gt)
library(haven)
library(here)
library(lubridate)
library(readr)
library(srvyr)
library(stringr)
library(survey)
library(svrep)
library(tidyr)

knitr::opts_chunk$set(
  cache = TRUE,
  dpi=200,
  echo = TRUE,
  fig.align = 'center',
  fig.height=9.6,
  fig.retina=1.5,
  fig.width=9.6
)
```


## Weight Preparation

### Loading of Raw Data

```{r load-raw-data}
raw_preg_1995_1995 <- read_sas(
  data_file = here('data/NSFG/d1995_1995fempreg.sas7bdat'),
  catalog_file = here('data/NSFG/d1995_1995fempreg.sas7bcat')
)
raw_fem_1995_1995 <- read_sas(
  data_file = here('data/NSFG/d1995_1995femresp.sas7bdat'),
  catalog_file = here('data/NSFG/d1995_1995femresp.sas7bcat')
)
```


### Data Preparation

```{r data-preparation, dependson="load-raw-data"}
cm_to_date <- function(x) {
  x_int <- as.integer(x)
  if_else(
    is.na(x_int) | x_int > 9000 | x_int == 0,
    NA,
    ym(paste0(
      floor((x_int - 1) / 12) + 1900,
      factor(
        x_int %% 12,
        levels = 0:11,
        labels = c('Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov')
      )
    ))
  )
}

data_preg <- select(
    raw_preg_1995_1995,
    CASEID, COL_STR, PANEL, POST_WT,
    
    # Variables used in post-stratification
    AGEPREG,
    DATEND,
    FMAROUT5,
    OUTCOME,
    
    # Variable used in pregnancy counts
    WANTRESP,
    
    # Variable used in births test harness
    NBRNLV
  ) |>
  mutate(

    # Variables used in post-stratification
    AgeAtEndOfPregnancy = as.integer(AGEPREG / 100),
    Year = year(cm_to_date(DATEND)),
    FMAROUT5 = as_factor(labelled(FMAROUT5, c(
      "MARRIED" = 1,
      "DIVORCED" = 2,
      "WINDOWED" = 3,
      "SEPARATED" = 4,
      "NEVER MARRIED" = 5
    ))),
    OUTCOME = as_factor(labelled(OUTCOME, c(
      "LIVE BIRTH" = 1,
      "INDUCED ABORTION" = 2,
      "STILLBIRTH" = 3,
      "MISCARRIAGE" = 4,
      "ECTOPIC PREGNANCY" = 5,
      "CURRENT PREGNANCY" = 6
    ))),
    
    # Variable used for pregnancy counts
    one = 1,
    intent = as.factor(if_else(
      WANTRESP %in% 1:2,
      'Intended',
      'Unintended'
    )),
    
    # Variable used for births test harness
    age_group6 = cut(
      as.integer(AGEPREG / 100),
      breaks = c(0, seq(20, 40, 5), Inf),
      right = FALSE,
      labels = c(
        "Under 20 years",
        "20-24 years",
        "25-29 years",
        "30-34 years",
        "35-39 years",
        "40 years and over"
      )
    ),
    
    # Variables used in abortions test harness
    births = if_else(
      OUTCOME == 'LIVE BIRTH',
      NBRNLV,
      0
    ),
    abortion = if_else(
      OUTCOME == 'INDUCED ABORTION',
      1,
      0
    )
  )


data_fem <- select(
    raw_fem_1995_1995,
    CASEID, PANEL, COL_STR, POST_WT,
    AGER,
    HISP,
    RACE,
    FMARITAL,
    PARITY
  ) |>
  mutate(
    one = 1,
    
    # Define the source variables to be used for the post-stratification variables
    age_coarse = paste(
      cut(
        AGER,
        breaks = c(13, 29, 45),
        labels = c('15-29', '30-44')
      ),
      'years'
    ),
    age_granular = paste(
      cut(
        AGER,
        breaks = c(13, 17, 19, 24, 29, 34, 39, 45),
        labels = c('15-17', '18-19', '20-24', '25-29', '30-34', '35-39', '40-44')
      ),
      'years'
    ),
    ethnicity_race2 = if_else(
      HISP == 1 | RACE == 1,
      'Black and Hispanic',
      'Other race'
    ),
    ethnicity_race3 = case_when(
      HISP == 1 ~ 'Hispanic',
      RACE == 1 ~ 'Black, non-Hispanic',
      .default = 'Other'
    ),
    marital_history = if_else(
      FMARITAL == 6,
      'Never married',
      'Ever married'
    ),
    parity2 = if_else(
      PARITY == 0,
      '0',
      '1 or more'
    ),
    parity3 = case_when(
      PARITY == 0 ~ '0',
      PARITY == 1 ~ '1',
      .default = '2 or more'
    ),
    parity4 = case_when(
      PARITY == 0 ~ '0',
      PARITY == 1 ~ '1',
      PARITY == 2 ~ '2',
      .default = '3 or more'
    ),
    parity5 = case_when(
      PARITY == 0 ~ '0',
      PARITY == 1 ~ '1',
      PARITY == 2 ~ '2',
      PARITY == 3 ~ '3',
      .default = '4 or more'
    ),
    
    # Define the post-stratification variables
    age_coarse_parity = factor(paste(age_coarse, parity5, sep = ', ')),
    age_coarse_marital_history = factor(paste(age_coarse, marital_history, sep = ', ')),
    age_granular_ethnicity_race = factor(paste(age_granular, ethnicity_race3, sep = ', ')),
    age_granular_ethnicity_race_parity = factor(paste(
      age_granular,
      case_when(
        age_granular == '15-17 years' ~ 'All races',
        age_granular == '18-19 years' ~ ethnicity_race2,
        age_granular == '20-24 years' ~ ethnicity_race3,
        age_granular == '25-29 years' ~ ethnicity_race2,
        age_granular == '30-34 years' ~ ethnicity_race2,
        age_granular == '35-39 years' ~ ethnicity_race2,
        age_granular == '40-44 years' ~ ethnicity_race2
      ),
      case_when(
        age_granular == '15-17 years' ~ parity2,
        age_granular == '18-19 years' ~ parity2,
        age_granular == '20-24 years' & ethnicity_race3 == 'Hispanic' ~ parity2,
        age_granular == '20-24 years' ~ parity3,
        age_granular == '25-29 years' ~ parity4,
        age_granular == '30-34 years' ~ parity5,
        age_granular == '35-39 years' ~ parity5,
        age_granular == '40-44 years' ~ parity5
      ),
      sep = ', '
    )),
    age_granular_ethnicity_race_marital_history = factor(paste(
      age_granular,
      case_when(
        age_granular == '15-17 years' ~ 'All races',
        age_granular == '18-19 years' ~ 'All races',
        age_granular == '20-24 years' ~ ethnicity_race3,
        age_granular == '25-29 years' ~ ethnicity_race2,
        age_granular == '30-34 years' ~ ethnicity_race2,
        age_granular == '35-39 years' ~ ethnicity_race2,
        age_granular == '40-44 years' ~ ethnicity_race2
      ),
      case_when(
        age_granular == '15-17 years' ~ 'All marital history',
        age_granular == '18-19 years' ~ marital_history,
        age_granular == '20-24 years' ~ marital_history,
        age_granular == '25-29 years' ~ marital_history,
        age_granular == '30-34 years' ~ marital_history,
        age_granular == '35-39 years' ~ marital_history,
        age_granular == '40-44 years' ~ marital_history
      ),
      sep = ', '
    ))
  ) |>
  left_join(
    data_preg |>
      group_by(CASEID) |>
      summarize(
        abortions_1991_1994 = sum(OUTCOME == 'INDUCED ABORTION' & Year %in% 1991:1994),
        abortion_1991_1994_age = case_when(
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1991:1994 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1991:1994 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1991:1994 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1991:1994 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1991:1994 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        abortions_1986_1990 = sum(OUTCOME == 'INDUCED ABORTION' & Year %in% 1986:1990),
        abortion_1986_1990_age = case_when(
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1986:1990 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1986:1990 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1986:1990 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1986:1990 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year %in% 1986:1990 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        abortion_1991plus_age = case_when(
          any(OUTCOME == 'INDUCED ABORTION' & Year >= 1991 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year >= 1991 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year >= 1991 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year >= 1991 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'INDUCED ABORTION' & Year >= 1991 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1994_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1994 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1994 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1994 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1994 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1994 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1993_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1993 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1993 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1993 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1993 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1993 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1992_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1992 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1992 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1992 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1992 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1992 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1991_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1991 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1991 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1991 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1991 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1991 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1990_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1990 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1990 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1990 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1990 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1990 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1989_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1989 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1989 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1989 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1989 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1989 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1988_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1988 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1988 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1988 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1988 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1988 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1987_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1987 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1987 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1987 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1987 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1987 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        ),
        birth_1986_age = case_when(
          any(OUTCOME == 'LIVE BIRTH' & Year == 1986 & AgeAtEndOfPregnancy <= 19) ~ 'Under 20 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1986 & AgeAtEndOfPregnancy >= 20 & AgeAtEndOfPregnancy <= 24) ~ '20-24 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1986 & AgeAtEndOfPregnancy >= 25 & AgeAtEndOfPregnancy <= 29) ~ '25-29 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1986 & AgeAtEndOfPregnancy >= 30 & AgeAtEndOfPregnancy <= 34) ~ '30-34 years',
          any(OUTCOME == 'LIVE BIRTH' & Year == 1986 & AgeAtEndOfPregnancy >= 35 & AgeAtEndOfPregnancy <= 39) ~ '35-39 years',
          .default = 'Other'
        )
      ),
    by = 'CASEID'
  ) |>
  mutate(
    abortions_1991_1994 = coalesce(abortions_1991_1994, 0),
    abortions_1991_1994_multiplier = if_else(
      abortions_1991_1994 >= 1,
      abortions_1991_1994,
      1
    ),
    abortions_1986_1990 = coalesce(abortions_1986_1990, 0),
    abortions_1986_1990_multiplier = if_else(
      abortions_1986_1990 >= 1,
      abortions_1986_1990,
      1
    ),
    across(
      ends_with('_age'),
      function(x) {
        factor(
          coalesce(x, 'Other'),
          levels = c(
            'Under 20 years',
            '20-24 years',
            '25-29 years',
            '30-34 years',
            '35-39 years',
            'Other'
          ),
          order = TRUE
        )
      }
    ),
    abortion_1991plus_age = if_else(
      abortion_1991plus_age != abortion_1991_1994_age & abortion_1991_1994_age != 'Other',
      abortion_1991_1994_age,
      abortion_1991plus_age
    )
  )


before_fem <- data_fem |>
  as_survey_design(
    strata = COL_STR,
    ids = PANEL,
    weights = POST_WT,
    nest = TRUE
  ) |>
  as_survey_rep(
    type = 'JKn'
  )
```


### Recreation of Demographic Post-Stratification Targets

```{r create-demographic-post-stratification-targets, dependson="data-preparation"}
post_stratification_estimates <- bind_rows(
  #before_fem |>
  #  group_by(age_coarse_parity) |>
  #  summarize(Freq = survey_total(one)) |>
  #  mutate(
  #    Variable = 'age_coarse_parity',
  #    Level = age_coarse_parity,
  #    .keep = 'unused',
  #    .before = everything()
  #  ),
  #before_fem |>
  #  group_by(age_coarse_marital_history) |>
  #  summarize(Freq = survey_total(one)) |>
  #  mutate(
  #    Variable = 'age_coarse_marital_history',
  #    Level = age_coarse_marital_history,
  #    .keep = 'unused',
  #    .before = everything()
  #  ),
  before_fem |>
    group_by(age_granular_ethnicity_race) |>
    summarize(Freq = survey_total(one)) |>
    mutate(
      Variable = 'age_granular_ethnicity_race',
      Level = age_granular_ethnicity_race,
      .keep = 'unused',
      .before = everything()
    ),
  before_fem |>
    group_by(age_granular_ethnicity_race_parity) |>
    summarize(Freq = survey_total(one)) |>
    mutate(
      Variable = 'age_granular_ethnicity_race_parity',
      Level = age_granular_ethnicity_race_parity,
      .keep = 'unused',
      .before = everything()
    ),
  before_fem |>
    group_by(age_granular_ethnicity_race_marital_history) |>
    summarize(Freq = survey_total(one)) |>
    mutate(
      Variable = 'age_granular_ethnicity_race_marital_history',
      Level = age_granular_ethnicity_race_marital_history,
      .keep = 'unused',
      .before = everything()
    )
) |> group_by(Variable)
  

post_stratification_estimates |>
  gt() |>
  fmt_number(decimal = 0)


demographic_targets <- post_stratification_estimates |>
  select(-Freq_se) |>
  group_by(Variable) |>
  group_split() |>
  lapply(function(tbl) {
    variable_name <- first(pull(tbl, Variable))
    tbl <- select(tbl, -Variable)
    names(tbl) <- c(variable_name, 'Freq')
    tbl
  })
```


### Creation of External Post-Stratification Targets

```{r create-post-stratification-targets}
population_total <- before_fem |>
  summarize(Freq = survey_total(one)) |>
  pull(Freq) |>
  sum()

guttmacher_APC_national <- read_csv(
    here('data/Guttmacher/NationalAndStatePregnancy_PublicUse.csv'),
    show_col_types = FALSE
  ) |>
  filter(state == 'US') |>
  mutate(interpolated = year %in%
      c(1983, 1986, 1989, 1990, 1993, 1994, 1997, 1998, 2001, 2002, 2003, 2006,
        2009, 2012, 2015)
  ) |>
  select('year', 'interpolated', 'abortionslt20', 'abortions2024',
    'abortions2529', 'abortions3034', 'abortions3539', 'abortions40plus',
    'abortionstotal')

guttmacher_APC_age_1986_1990 <- guttmacher_APC_national |>
  select(-abortions40plus) |>
  filter(year %in% 1986:1990) |>
  rename(
    `Other` = abortionstotal,
    `Under 20 years` = abortionslt20,
    `20-24 years` = abortions2024,
    `25-29 years` = abortions2529,
    `30-34 years` = abortions3034,
    `35-39 years` = abortions3539
  ) |>
  summarize(across(3:7, sum)) |>
  pivot_longer(
    cols = everything(),
    names_to = 'abortion_1986_1990_age',
    values_to = 'Freq'
  ) |>
  select(abortion_1986_1990_age, Freq) %>%
  bind_rows(summarize(
    .,
    abortion_1986_1990_age = 'Other',
    Freq = population_total - sum(Freq)
  )) |>
  mutate(
    abortion_1986_1990_age = factor(
      abortion_1986_1990_age,
      levels = c(
        'Under 20 years',
        '20-24 years',
        '25-29 years',
        '30-34 years',
        '35-39 years',
        'Other'
      ),
      ordered = TRUE
    )
  )


guttmacher_APC_age_1991_1994 <- guttmacher_APC_national |>
  select(-abortions40plus) |>
  filter(year %in% 1991:1994) |>
  rename(
    `Other` = abortionstotal,
    `Under 20 years` = abortionslt20,
    `20-24 years` = abortions2024,
    `25-29 years` = abortions2529,
    `30-34 years` = abortions3034,
    `35-39 years` = abortions3539
  ) |>
  summarize(across(3:7, sum)) |>
  pivot_longer(
    cols = everything(),
    names_to = 'abortion_1991_1994_age',
    values_to = 'Freq'
  ) |>
  select(abortion_1991_1994_age, Freq) %>%
  bind_rows(summarize(
    .,
    abortion_1991_1994_age = 'Other',
    Freq = population_total - sum(Freq)
  )) |>
  mutate(
    abortion_1991_1994_age = factor(
      abortion_1991_1994_age,
      levels = c(
        'Under 20 years',
        '20-24 years',
        '25-29 years',
        '30-34 years',
        '35-39 years',
        'Other'
      ),
      ordered = TRUE
    )
  )


NVSS_age <- readRDS(here('data/NVSS/natality_by_age_1974-1994us.Rds')) |>
  filter(
    Year %in% 1986:1994 &
      mage8 %in% c(
        'Under 15 years',
        '15-19 years',
        '20-24 years',
        '25-29 years',
        '30-34 years',
        '35-39 years'
      )
  ) |>
  mutate(
    Variable = paste0('birth_', Year, '_age'),
    Level = forcats::fct_recode(
      mage8,
      `Under 20 years` = 'Under 15 years',
      `Under 20 years` = '15-19 years'
    ),
    .keep = 'unused',
    .before = 'n'
  ) |>
  group_by(Variable, Level) |>
  summarize(n = sum(n), .groups = 'drop') |>
  arrange(Variable, Level) |>
  group_by(Variable) |>
  group_split() |>
  lapply(function(tbl) {
    variable_name <- first(pull(tbl, Variable))
    tbl <- select(tbl, -Variable)
    names(tbl) <- c(variable_name, 'Freq')
    tbl %>%
      add_row(
        summarize(
          .,
          across(where(is.factor), ~'Other'),
          Freq = population_total - sum(Freq)
        )
      ) |>
      mutate(
        across(where(is.character), function(x) {
          factor(
            x,
            levels = c(
              'Under 20 years',
              '20-24 years',
              '25-29 years',
              '30-34 years',
              '35-39 years',
              'Other'
            ),
            ordered = TRUE
          )
        })
      )
  })
```


### Post-Stratifications

```{r rake-post-stratifications, dependson=c("data-preparation", "create-post-stratification-targets")}
source(here('R/rake2.R'))
  
post_stratification_targets <- c(
  list(guttmacher_APC_age_1991_1994),
  list(guttmacher_APC_age_1986_1990),
  demographic_targets,
  NVSS_age
)

extras <- replicate(length(post_stratification_targets), NULL)
extras[[1]] <- c(
  ~abortions_1991_1994_multiplier,
  ~abortion_1991plus_age
)
extras[[2]] <- c(
  ~abortions_1986_1990_multiplier,
  ~abortion_1986_1990_age
)

post_fem <- rake2(
  before_fem,
  sample.margins = lapply(
    post_stratification_targets,
    \(x) as.formula(paste0('~', colnames(x)[1]))
  ),
  population.margins = post_stratification_targets,
  extras = extras,
  control=list(maxit=50, epsilon=1, verbose=FALSE)
)
```


### Saving of Adjusted Weights

```{r save-adjusted-weights, dependson="rake-post-stratifications"}
post_fem |>
  as_data_frame_with_weights(
    full_wgt_name = "FULL_SAMPLE_WGT",
    rep_wgt_prefix = "REP_WGT_"
  ) |>
  select(CASEID, contains('_WGT')) |>
  arrange(CASEID) |>
  saveRDS(here('data/NSFG/adjusted_cycle_5_weights.Rds'))

saveRDS(
  post_fem$rscales,
  here('data/NSFG/adjusted_cycle_5_rscales.Rds')
)
```


## Examination of Results of Weight Adjustment

### Creation of Survey Objects

```{r create-survey-objects, dependson=c("save-adjusted-weights")}
after_fem <- data_fem |>
  select(-POST_WT) |>
  left_join(
    readRDS(here('data/NSFG/adjusted_cycle_5_weights.Rds')),
    by = join_by(CASEID)
  ) |>
  as_survey_rep(
    type = 'JKn',
    weights = FULL_SAMPLE_WGT,
    repweights = starts_with('REP_WGT_'),
    rscales = readRDS(here('data/NSFG/adjusted_cycle_5_rscales.Rds'))
  )

before_preg <- data_preg |>
  select(-POST_WT) |>
  left_join(
    before_fem |>
      as_data_frame_with_weights(
        full_wgt_name = "FULL_SAMPLE_WGT",
        rep_wgt_prefix = "REP_WGT_"
      ) |>
      select(CASEID, contains('_WGT')),
    by = join_by(CASEID)
  ) |>
  as_survey_rep(
    type = 'JKn',
    weights = FULL_SAMPLE_WGT,
    repweights = starts_with('REP_WGT_'),
    rscales = before_fem$rscales
  )

after_preg <- data_preg |>
  select(-POST_WT) |>
  left_join(
    readRDS(here('data/NSFG/adjusted_cycle_5_weights.Rds')),
    by = join_by(CASEID)
  ) |>
  as_survey_rep(
    type = 'JKn',
    weights = FULL_SAMPLE_WGT,
    repweights = starts_with('REP_WGT_'),
    rscales = readRDS(here('data/NSFG/adjusted_cycle_5_rscales.Rds'))
  )
```


### UWE

```{r uwe, dependson="create-survey-objects"}
data.frame(
  when = rep(c('Before Raking', 'After Raking'), 2),
  table = rep(c('Female Respondents', 'Pregnancies'), each = 2),
  UWE = c(
    deffK(weights(before_fem, 'sampling')),
    deffK(weights(after_fem, 'sampling')),
    deffK(weights(before_preg, 'sampling')),
    deffK(weights(after_preg, 'sampling'))
  )
) |>
  gt() |>
  fmt_number()
```


### Observations with Extreme Weights

#### By Entropy

```{r extreme-entropy, dependson="create-survey-objects"}
entropy_extreme_before <- before_fem$variables |>
  select(CASEID, POST_WT) |>
  filter(
    POST_WT^2 > 10 * mean(POST_WT^2)
  )

entropy_extreme_after <-  after_fem$variables |>
  select(CASEID, FULL_SAMPLE_WGT) |>
  filter(
    FULL_SAMPLE_WGT^2 > 10 * mean(FULL_SAMPLE_WGT^2)
  )

data.frame(
  Label = c(
    'Total Observations',
    'Extreme Weights Before',
    'Extreme Weights After',
    'Difference'
  ),
  Count = c(
    nrow(after_fem),
    nrow(entropy_extreme_before),
    nrow(entropy_extreme_after),
    nrow(entropy_extreme_after) - nrow(entropy_extreme_before)
  )
) |>
  gt() |>
  fmt_number(decimal = 0)
```


#### By Inter-Quartile Range (IQR)

```{r extreme-iqr, dependson="create-survey-objects"}
iqr_extreme_after <- after_fem$variables |>
  select(CASEID, FULL_SAMPLE_WGT) |>
  filter(
    FULL_SAMPLE_WGT > 5 * IQR(FULL_SAMPLE_WGT) + median(FULL_SAMPLE_WGT)
  )

iqr_extreme_before <- before_fem$variables |>
  select(CASEID, POST_WT) |>
  filter(
    POST_WT > 5 * IQR(POST_WT) + median(POST_WT)
  )

data.frame(
  Label = c(
    'Total Observations',
    'Extreme Weights Before',
    'Extreme Weights After',
    'Difference'
  ),
  Count = c(
    nrow(after_fem),
    nrow(iqr_extreme_before),
    nrow(iqr_extreme_after),
    nrow(iqr_extreme_after) - nrow(iqr_extreme_before)
  )
) |>
  gt() |>
  fmt_number(decimal = 0)
```


### Post-Stratification Targets

```{r verify-post-stratification, dependson="create-survey-objects"}
after_fem |>
  group_by(abortion_1991_1994_age) |>
  summarize(
    Count = n(),
    Est = survey_total(abortions_1991_1994_multiplier)
  ) |>
  full_join(
    post_stratification_targets[[1]],
    by = join_by(abortion_1991_1994_age)
  ) |>
  mutate(
    Diff = Est - Freq
  ) |>
  gt() |>
  fmt_number(c(Est, Freq), decimal = 0) |>
  fmt_number(c(Est_se, Diff), decimal = 2)

check_poststratifications <- function(targets) {
  variable_name <- colnames(targets)[1]

  estimates <- after_fem |>
    group_by(get(variable_name)) |>
    summarize(
      n = n(),
      Est = survey_total(one)
    )
  
  colnames(estimates)[1] <- variable_name
  
  full_join(
    estimates,
    targets,
    by = variable_name
  ) |>
    mutate(
      Diff = Est - Freq
    ) |>
    gt() |>
    fmt_number(c(Est, Freq), decimal = 0) |>
    fmt_number(c(Est_se, Diff), decimal = 2)
}

check_poststratifications(post_stratification_targets[[2]])
check_poststratifications(post_stratification_targets[[3]])
check_poststratifications(post_stratification_targets[[4]])
check_poststratifications(post_stratification_targets[[5]])
check_poststratifications(post_stratification_targets[[6]])
check_poststratifications(post_stratification_targets[[7]])
check_poststratifications(post_stratification_targets[[9]])
check_poststratifications(post_stratification_targets[[10]])
check_poststratifications(post_stratification_targets[[11]])
check_poststratifications(post_stratification_targets[[12]])
check_poststratifications(post_stratification_targets[[13]])
check_poststratifications(post_stratification_targets[[14]])
```


### Abortion Adjustments

```{r find-average-abortion-adjustment, dependson="create-survey-objects"}
before_fem |>
  group_by(abortion_1986_1990_age) |>
  summarize(
    Count = n(),
    Before = survey_total(one)
  ) |>
  full_join(
    after_fem |>
      group_by(abortion_1986_1990_age) |>
      summarize(
        After = survey_total(one)
      ),
    by = join_by(abortion_1986_1990_age)
  ) |>
  mutate(
    Factor = After / Before
  ) |>
  gt() |>
  fmt_number(decimal = 0) |>
  fmt_number(Factor, decimal = 2)

before_fem |>
  group_by(abortion_1991_1994_age) |>
  summarize(
    Count = n(),
    Before = survey_total(one)
  ) |>
  full_join(
    after_fem |>
      group_by(abortion_1991_1994_age) |>
      summarize(
        After = survey_total(one)
      ),
    by = join_by(abortion_1991_1994_age)
  ) |>
  mutate(
    Factor = After / Before
  ) |>
  gt() |>
  fmt_number(decimal = 0) |>
  fmt_number(Factor, decimal = 2)

before_fem |>
  group_by(abortion_1991plus_age) |>
  summarize(
    Count = n(),
    Before = survey_total(one)
  ) |>
  full_join(
    after_fem |>
      group_by(abortion_1991plus_age) |>
      summarize(
        After = survey_total(one)
      ),
    by = join_by(abortion_1991plus_age)
  ) |>
  mutate(
    Factor = After / Before
  ) |>
  gt() |>
  fmt_number(decimal = 0) |>
  fmt_number(Factor, decimal = 2)
```


### Abortions

This survey will cover years 1986 to 1994.

```{r abortions, dependson=c("create-post-stratification-targets", "create-survey-objects")}
guttmacher_APC_national |>
  filter(year %in% 1986:1994) |>
  summarize(Abortions = sum(abortionstotal)) |>
  cbind(
    before_preg |>
      group_by(Year) |>
      summarize(
        n = unweighted(sum(abortion)),
        Est = survey_total(abortion, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1994) |>
      select(-Year) |>
      summarize(across(everything(), sum)) |>
      rename(
        Est_Before = Est,
        Est_Before_low = Est_low,
        Est_Before_upp = Est_upp
      )
  ) |>
  cbind(
    after_preg |>
      group_by(Year) |>
      summarize(
        Est = survey_total(abortion, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1994) |>
      select(-Year) |>
      summarize(across(everything(), sum)) |>
      rename(
        Est_After = Est,
        Est_After_low = Est_low,
        Est_After_upp = Est_upp
      )
  ) |>
  mutate(
    Bias_Before = Est_Before - Abortions,
    Rel_Bias_Before = Bias_Before / Abortions,
    `Covers_Before?` = Abortions <= Est_Before_upp & Abortions >= Est_Before_low,
    Bias_After = Est_After - Abortions,
    Rel_Bias_After = Bias_After / Abortions,
    `Covers_After?` = Abortions <= Est_After_upp & Abortions >= Est_After_low,
    Bias_Diff = abs(Bias_After) - abs(Bias_Before),
    Est_Diff = Est_After - Est_Before,
    Rel_Bias_Diff = abs(Rel_Bias_After) - abs(Rel_Bias_Before),
    `Fixed?` = if_else(
        !`Covers_Before?`,
        `Covers_After?`,
        NA
    ),
    `Broke?` = `Covers_Before?` & !`Covers_After?`
  ) |>
  select(
    n,
    Abortions,
    Est_Before,
    #Est_Before_low,
    #Est_Before_upp,
    Est_After,
    Est_After_low,
    Est_After_upp,
    #Est_Diff,
    #Bias_Before,
    #Bias_After,
    #Bias_Diff,
    Rel_Bias_Before,
    Rel_Bias_After,
    #Rel_Bias_Diff,
    #`Unc_Covers?`,
    #`Cal_Covers?`,
    `Fixed?`,
    `Broke?`
  ) |>
  gt() |>
  fmt_percent(contains('Rel_Bias'), decimal = 1)
```


### Abortions by Age

This survey will cover years 1986 to 1994.

```{r abortions-by-age, dependson=c("create-post-stratification-targets", "create-survey-objects")}
guttmacher_APC_national |>
  filter(year %in% 1986:1994) |>
  select(-abortionstotal) |>
  summarize(across(starts_with('abortions'), sum)) |>
  rename(
    `Under 20 years` = abortionslt20,
    `20-24 years` = abortions2024,
    `25-29 years` = abortions2529,
    `30-34 years` = abortions3034,
    `35-39 years` = abortions3539,
    `40 years and over` = abortions40plus
  ) |>
  pivot_longer(
    cols = everything(),
    names_to = 'age_group6',
    values_to = 'Abortions'
  ) |>
  inner_join(
    before_preg |>
      group_by(age_group6, Year) |>
      summarize(
        n = unweighted(sum(abortion)),
        Est = survey_total(abortion, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1994) |>
      select(-Year) |>
      summarize(across(c('n', starts_with('Est')), sum)) |>
      rename(
        Est_Before = Est,
        Est_Before_low = Est_low,
        Est_Before_upp = Est_upp
      ),
    by = join_by(age_group6)
  ) |>
  inner_join(
    after_preg |>
      group_by(age_group6, Year) |>
      summarize(
        Est = survey_total(abortion, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1994) |>
      select(-Year) |>
      summarize(across(starts_with('Est'), sum)) |>
      rename(
        Est_After = Est,
        Est_After_low = Est_low,
        Est_After_upp = Est_upp
      ),
    by = join_by(age_group6)
  ) |>
  mutate(
    Bias_Before = Est_Before - Abortions,
    Rel_Bias_Before = Bias_Before / Abortions,
    `Covers_Before?` = Abortions <= Est_Before_upp & Abortions >= Est_Before_low,
    Bias_After = Est_After - Abortions,
    Rel_Bias_After = Bias_After / Abortions,
    `Covers_After?` = Abortions <= Est_After_upp & Abortions >= Est_After_low,
    Bias_Diff = abs(Bias_After) - abs(Bias_Before),
    Est_Diff = Est_After - Est_Before,
    Rel_Bias_Diff = abs(Rel_Bias_After) - abs(Rel_Bias_Before),
    `Fixed?` = if_else(
        !`Covers_Before?`,
        `Covers_After?`,
        NA
    ),
    `Broke?` = `Covers_Before?` & !`Covers_After?`
  ) |>
  select(
    age_group6,
    n,
    Abortions,
    Est_Before,
    #Est_Before_low,
    #Est_Before_upp,
    Est_After,
    Est_After_low,
    Est_After_upp,
    #Est_Diff,
    #Bias_Before,
    #Bias_After,
    #Bias_Diff,
    Rel_Bias_Before,
    Rel_Bias_After,
    #Rel_Bias_Diff,
    #`Unc_Covers?`,
    #`Cal_Covers?`,
    `Fixed?`,
    `Broke?`
  ) |>
  gt() |>
  fmt_percent(contains('Rel_Bias'), decimal = 1)
```


### Abortions by Year

```{r abortions-by-year, dependson=c("create-post-stratification-targets", "create-survey-objects")}
guttmacher_APC_national |>
  filter(year %in% 1986:1995) |>
  rename(Year = year, Abortions = abortionstotal) |>
  select(Year, Abortions) |>
  left_join(
    before_preg |>
      group_by(Year) |>
      summarize(
        n = unweighted(sum(abortion)),
        Est = survey_total(abortion, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1995) |>
      rename(
        Est_Before = Est,
        Est_Before_low = Est_low,
        Est_Before_upp = Est_upp
      ),
    by = 'Year'
  ) |>
  left_join(
    after_preg |>
      group_by(Year) |>
      summarize(
        n = unweighted(sum(abortion)),
        Est = survey_total(abortion, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1995) |>
      rename(
        Est_After = Est,
        Est_After_low = Est_low,
        Est_After_upp = Est_upp
      ),
    by = 'Year',
    suffix = c('.before', '.after')
  ) |>
  mutate(
    unequal_n = n.before != n.after,
    Bias_Before = Est_Before - Abortions,
    Rel_Bias_Before = Bias_Before / Abortions,
    `Covers_Before?` = Abortions <= Est_Before_upp & Abortions >= Est_Before_low,
    Bias_After = Est_After - Abortions,
    Rel_Bias_After = Bias_After / Abortions,
    `Covers_After?` = Abortions <= Est_After_upp & Abortions >= Est_After_low,
    Bias_Diff = abs(Bias_After) - abs(Bias_Before),
    Est_Diff = Est_After - Est_Before,
    Rel_Bias_Diff = abs(Rel_Bias_After) - abs(Rel_Bias_Before),
    `Fixed?` = if_else(
        !`Covers_Before?`,
        `Covers_After?`,
        NA
    ),
    `Broke?` = `Covers_Before?` & !`Covers_After?`
  ) |>
  rename(
    n = n.after
  ) |>
  select(
    Year,
    n,
    Abortions,
    Est_Before,
    #Est_Before_low,
    #Est_Before_upp,
    Est_After,
    Est_After_low,
    Est_After_upp,
    #Est_Diff,
    #Bias_Before,
    #Bias_After,
    #Bias_Diff,
    Rel_Bias_Before,
    Rel_Bias_After,
    #Rel_Bias_Diff,
    #`Unc_Covers?`,
    #`Cal_Covers?`,
    `Fixed?`,
    `Broke?`
  ) |>
  gt() |>
  fmt_number(-Year, decimal = 0) |>
  fmt_percent(contains('Rel_Bias'), decimal = 1)
```


### Abortions by Year by Age

This survey will cover years 1986 to 1994.

```{r abortions-by-year-by-age, dependson=c("create-post-stratification-targets", "create-survey-objects")}
guttmacher_APC_national |>
  filter(year %in% 1986:1995) |>
  rename(
    Year = year,
    `Under 20 years` = abortionslt20,
    `20-24 years` = abortions2024,
    `25-29 years` = abortions2529,
    `30-34 years` = abortions3034,
    `35-39 years` = abortions3539,
    `40 years and over` = abortions40plus
  ) |>
  pivot_longer(
    cols = contains('years'),
    names_to = 'Level',
    values_to = 'Abortions'
  ) |>
  select(Year, Level, Abortions) |>
  left_join(
    before_preg |>
      group_by(Year, age_group6) |>
      summarize(
        n = unweighted(sum(abortion)),
        Est = survey_total(abortion, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1995) |>
      rename(
        Level = age_group6,
        Est_Before = Est,
        Est_Before_low = Est_low,
        Est_Before_upp = Est_upp
      ),
    by = c('Year', 'Level')
  ) |>
  left_join(
    after_preg |>
      group_by(Year, age_group6) |>
      summarize(
        n = unweighted(sum(abortion)),
        Est = survey_total(abortion, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1995) |>
      rename(
        Level = age_group6,
        Est_After = Est,
        Est_After_low = Est_low,
        Est_After_upp = Est_upp
      ),
    by = c('Year', 'Level'),
    suffix = c('.before', '.after')
  ) |>
  mutate(
    unequal_n = n.before != n.after,
    Bias_Before = Est_Before - Abortions,
    Rel_Bias_Before = Bias_Before / Abortions,
    `Covers_Before?` = Abortions <= Est_Before_upp & Abortions >= Est_Before_low,
    Bias_After = Est_After - Abortions,
    Rel_Bias_After = Bias_After / Abortions,
    `Covers_After?` = Abortions <= Est_After_upp & Abortions >= Est_After_low,
    Bias_Diff = abs(Bias_After) - abs(Bias_Before),
    Est_Diff = Est_After - Est_Before,
    Rel_Bias_Diff = abs(Rel_Bias_After) - abs(Rel_Bias_Before),
    `Fixed?` = if_else(
        !`Covers_Before?`,
        `Covers_After?`,
        NA
    ),
    `Broke?` = `Covers_Before?` & !`Covers_After?`
  ) |>
  rename(
    n = n.after
  ) |>
  select(
    Year,
    Level,
    n,
    Abortions,
    Est_Before,
    #Est_Before_low,
    #Est_Before_upp,
    Est_After,
    Est_After_low,
    Est_After_upp,
    #Est_Diff,
    #Bias_Before,
    #Bias_After,
    #Bias_Diff,
    Rel_Bias_Before,
    Rel_Bias_After,
    #Rel_Bias_Diff,
    #`Unc_Covers?`,
    #`Cal_Covers?`,
    `Fixed?`,
    `Broke?`
  ) |>
  group_by(Year) |>
  gt() |>
  fmt_number(-Year, decimal = 0) |>
  fmt_percent(contains('Rel_Bias'), decimal = 1)
```


### Births by Year 

This survey will cover years 1986 to 1994.

```{r births-by-year, dependson=c("create-post-stratification-targets", "create-survey-objects")}
readRDS(here('data/NVSS/natality_by_age_1974-1994us.Rds')) |>
  filter(Year %in% 1986:1995) |>
  group_by(Year) |>
  summarize(Births = sum(n)) |>
  left_join(
    before_preg |>
      filter(Year %in% 1986:1995) |>
      group_by(Year) |>
      summarize(
        n = unweighted(sum(births)),
        Est = survey_total(births, vartype = 'ci')
      ) |>
      rename(
        Est_Before = Est,
        Est_Before_low = Est_low,
        Est_Before_upp = Est_upp
      ),
    by = 'Year'
  ) |>
  left_join(
    after_preg |>
      group_by(Year) |>
      summarize(
        n = unweighted(sum(births)),
        Est = survey_total(births, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1995) |>
      rename(
        Est_After = Est,
        Est_After_low = Est_low,
        Est_After_upp = Est_upp
      ),
    by = 'Year',
    suffix = c('.before', '.after')
  ) |>
  mutate(
    unequal_n = n.before != n.after,
    Bias_Before = Est_Before - Births,
    Rel_Bias_Before = Bias_Before / Births,
    `Covers_Before?` = Births <= Est_Before_upp & Births >= Est_Before_low,
    Bias_After = Est_After - Births,
    Rel_Bias_After = Bias_After / Births,
    `Covers_After?` = Births <= Est_After_upp & Births >= Est_After_low,
    Bias_Diff = abs(Bias_After) - abs(Bias_Before),
    Est_Diff = Est_After - Est_Before,
    Rel_Bias_Diff = abs(Rel_Bias_After) - abs(Rel_Bias_Before),
    `Fixed?` = if_else(
        !`Covers_Before?`,
        `Covers_After?`,
        NA
    ),
    `Broke?` = `Covers_Before?` & !`Covers_After?`
  ) |>
  rename(
    n = n.after
  ) |>
  select(
    Year,
    n,
    Births,
    Est_Before,
    #Est_Before_low,
    #Est_Before_upp,
    Est_After,
    Est_After_low,
    Est_After_upp,
    #Est_Diff,
    #Bias_Before,
    #Bias_After,
    #Bias_Diff,
    Rel_Bias_Before,
    Rel_Bias_After,
    #Rel_Bias_Diff,
    #`Unc_Covers?`,
    #`Cal_Covers?`,
    `Fixed?`,
    `Broke?`
  ) |>
  gt() |>
  fmt_number(-Year, decimal = 0) |>
  fmt_percent(contains('Rel_Bias'), decimal = 1)
```


### Births by Year by Age

This survey will cover years 1986 to 1994.

```{r births-by-year-by-age, dependson=c("create-post-stratification-targets", "create-survey-objects")}
readRDS(here('data/NVSS/natality_by_age_1974-1994us.Rds')) |>
  filter(Year %in% 1986:1995) |>
  mutate(
    age_group6 = forcats::fct_recode(
      mage8,
      `Under 20 years` = 'Under 15 years',
      `Under 20 years` = '15-19 years',
      `40 years and over` = '40-44 years',
      `40 years and over` = '45-49 years'
    ),
    .keep = 'unused',
    .before = 'n'
  ) |>
  group_by(Year, age_group6) |>
  summarize(Births = sum(n), .groups = 'drop') |>
  left_join(
    before_preg |>
      group_by(Year, age_group6) |>
      summarize(
        n = unweighted(sum(births)),
        Est = survey_total(births, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1995) |>
      rename(
        Est_Before = Est,
        Est_Before_low = Est_low,
        Est_Before_upp = Est_upp
      ),
    by = c('Year', 'age_group6')
  ) |>
  left_join(
    after_preg |>
      group_by(Year, age_group6) |>
      summarize(
        n = unweighted(sum(births)),
        Est = survey_total(births, vartype = 'ci')
      ) |>
      filter(Year %in% 1986:1995) |>
      rename(
        Est_After = Est,
        Est_After_low = Est_low,
        Est_After_upp = Est_upp
      ),
    by = c('Year', 'age_group6'),
    suffix = c('.before', '.after')
  ) |>
  mutate(
    unequal_n = n.before != n.after,
    Bias_Before = Est_Before - Births,
    Rel_Bias_Before = Bias_Before / Births,
    `Covers_Before?` = Births <= Est_Before_upp & Births >= Est_Before_low,
    Bias_After = Est_After - Births,
    Rel_Bias_After = Bias_After / Births,
    `Covers_After?` = Births <= Est_After_upp & Births >= Est_After_low,
    Bias_Diff = abs(Bias_After) - abs(Bias_Before),
    Est_Diff = Est_After - Est_Before,
    Rel_Bias_Diff = abs(Rel_Bias_After) - abs(Rel_Bias_Before),
    `Fixed?` = if_else(
        !`Covers_Before?`,
        `Covers_After?`,
        NA
    ),
    `Broke?` = `Covers_Before?` & !`Covers_After?`
  ) |>
  rename(
    n = n.after
  ) |>
  select(
    Year,
    age_group6,
    n,
    Births,
    Est_Before,
    #Est_Before_low,
    #Est_Before_upp,
    Est_After,
    Est_After_low,
    Est_After_upp,
    #Est_Diff,
    #Bias_Before,
    #Bias_After,
    #Bias_Diff,
    Rel_Bias_Before,
    Rel_Bias_After,
    #Rel_Bias_Diff,
    #`Unc_Covers?`,
    #`Cal_Covers?`,
    `Fixed?`,
    `Broke?`
  ) |>
  group_by(Year) |>
  gt() |>
  fmt_number(-Year, decimal = 0) |>
  fmt_percent(contains('Rel_Bias'), decimal = 1)
```


### Pregnancies by Year

This survey will cover years 1986 to 1994.

```{r pregnancies-per-year, dependson="create-survey-objects"}
bind_rows(list(
  before_preg |>
    group_by(Year) |>
    summarize(
      n = n(),
      Freq = survey_total(one, vartype = 'se')
    ) |>
    mutate(
      RSE = Freq_se / Freq,
      post_strat = 'before'
    ) |>
    filter(Year %in% 1986:1994),
  after_preg |>
    group_by(Year) |>
    summarize(
      n = n(),
      Freq = survey_total(one, vartype = 'se')
    ) |>
    mutate(
      RSE = Freq_se / Freq,
      post_strat = 'after'
    ) |>
    filter(Year %in% 1986:1994)
)) |> inner_join(
  bind_rows(list(
    before_preg |>
      group_by(Year) |>
      summarize(
        n = n(),
        Freq = survey_total(one, vartype = 'ci')
      ) |>
      mutate(
        Freq_CI_range = Freq_upp - Freq_low,
        Rel_CI = Freq_CI_range / Freq,
        post_strat = 'before'
      ) |>
      filter(Year %in% 1986:1994),
    after_preg |>
      group_by(Year) |>
      summarize(
        n = n(),
        Freq = survey_total(one, vartype = 'ci')
      ) |>
      mutate(
        Freq_CI_range = Freq_upp - Freq_low,
        Rel_CI = Freq_CI_range / Freq,
        post_strat = 'after'
      ) |>
      filter(Year %in% 1986:1994)
  )),
  by = join_by(Year, post_strat, Freq, n)
) |>
  select(Year, post_strat, everything()) |>
  mutate(
    post_strat = factor(
      post_strat,
      levels = c('before', 'after'),
      ordered = TRUE
    )
  ) |>
  arrange(Year, post_strat) |>
  group_by(Year) |>
  gt() |>
  fmt_number(
    starts_with('Freq'),
    decimals = 0
  ) |>
  fmt_percent(
    c(RSE, Rel_CI)
  )
```


### Pregnancies by Year and Intent

This survey will cover years 1986 to 1994.

```{r pregnancies-per-year-by-intent, dependson="create-survey-objects"}
bind_rows(list(
  before_preg |>
    group_by(Year, intent) |>
    summarize(
      n = n(),
      Freq = survey_total(one, vartype = 'se')
    ) |>
    mutate(
      RSE = Freq_se / Freq,
      post_strat = 'before'
    ) |>
    filter(Year %in% 1986:1994),
  after_preg |>
    group_by(Year, intent) |>
    summarize(
      n = n(),
      Freq = survey_total(one, vartype = 'se')
    ) |>
    mutate(
      RSE = Freq_se / Freq,
      post_strat = 'after'
    ) |>
    filter(Year %in% 1986:1994)
)) |> inner_join(
  bind_rows(list(
    before_preg |>
      group_by(Year, intent) |>
      summarize(
        n = n(),
        Freq = survey_total(one, vartype = 'ci')
      ) |>
      mutate(
        Freq_CI_range = Freq_upp - Freq_low,
        Rel_CI = Freq_CI_range / Freq,
        post_strat = 'before'
      ) |>
      filter(Year %in% 1986:1994),
    after_preg |>
      group_by(Year, intent) |>
      summarize(
        n = n(),
        Freq = survey_total(one, vartype = 'ci')
      ) |>
      mutate(
        Freq_CI_range = Freq_upp - Freq_low,
        Rel_CI = Freq_CI_range / Freq,
        post_strat = 'after'
      ) |>
      filter(Year %in% 1986:1994)
  )),
  by = join_by(Year, intent, post_strat, Freq, n)
) |>
  select(Year, intent, post_strat, everything()) |>
  mutate(
    post_strat = factor(
      post_strat,
      levels = c('before', 'after'),
      ordered = TRUE
    )
  ) |>
  arrange(Year, intent, post_strat) |>
  group_by(Year) |>
  gt() |>
  fmt_number(
    starts_with('Freq'),
    decimals = 0
  ) |>
  fmt_percent(
    c(RSE, Rel_CI)
  )
```


### Pregnancies by Year and Outcome

This survey will cover years 1986 to 1994.

```{r pregnancies-per-year-by-outcome, dependson="create-survey-objects"}
bind_rows(list(
  before_preg |>
    group_by(Year, OUTCOME) |>
    summarize(
      n = n(),
      Freq = survey_total(one, vartype = 'se')
    ) |>
    mutate(
      RSE = Freq_se / Freq,
      post_strat = 'before'
    ) |>
    filter(Year %in% 1986:1994),
  after_preg |>
    group_by(Year, OUTCOME) |>
    summarize(
      n = n(),
      Freq = survey_total(one, vartype = 'se')
    ) |>
    mutate(
      RSE = Freq_se / Freq,
      post_strat = 'after'
    ) |>
    filter(Year %in% 1986:1994)
)) |> inner_join(
  bind_rows(list(
    before_preg |>
      group_by(Year, OUTCOME) |>
      summarize(
        n = n(),
        Freq = survey_total(one, vartype = 'ci')
      ) |>
      mutate(
        Freq_CI_range = Freq_upp - Freq_low,
        Rel_CI = Freq_CI_range / Freq,
        post_strat = 'before'
      ) |>
      filter(Year %in% 1986:1994),
    after_preg |>
      group_by(Year, OUTCOME) |>
      summarize(
        n = n(),
        Freq = survey_total(one, vartype = 'ci')
      ) |>
      mutate(
        Freq_CI_range = Freq_upp - Freq_low,
        Rel_CI = Freq_CI_range / Freq,
        post_strat = 'after'
      ) |>
      filter(Year %in% 1986:1994)
  )),
  by = join_by(Year, OUTCOME, post_strat, Freq, n)
) |>
  select(Year, OUTCOME, post_strat, everything()) |>
  mutate(
    post_strat = factor(
      post_strat,
      levels = c('before', 'after'),
      ordered = TRUE
    )
  ) |>
  arrange(Year, OUTCOME, post_strat) |>
  group_by(Year) |>
  gt() |>
  fmt_number(
    starts_with('Freq'),
    decimals = 0
  ) |>
  fmt_percent(
    c(RSE, Rel_CI)
  )
```
